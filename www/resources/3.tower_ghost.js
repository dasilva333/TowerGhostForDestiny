function Profile(character){this.id=character.characterBase.characterId,this.order=ko.observable(character.index),this.icon=ko.observable(""),this.gender=ko.observable(""),this.classType=ko.observable(""),this.level=ko.observable(""),this.stats=ko.observable(""),this.race=ko.observable(""),this.percentToNextLevel=ko.observable(""),this.background=ko.observable(""),this.items=ko.observableArray().extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),this.items.subscribe(app.redraw),this.reloadingBucket=!1,this.statsShowing=ko.observable(!1),this.weapons=ko.pureComputed(this._weapons,this),this.armor=ko.pureComputed(this._armor,this),this.general=ko.pureComputed(this._general,this),this.invisible=ko.pureComputed(this._invisible,this),this.lostItems=ko.pureComputed(this._lostItems,this),this.equippedGear=ko.pureComputed(this._equippedGear,this),this.equippedStats=ko.pureComputed(this._equippedStats,this),this.sumCSP=ko.pureComputed(this._sumCSP,this),this.equippedSP=ko.pureComputed(this._equippedSP,this),this.equippedTier=ko.pureComputed(this._equippedTier,this),this.tierCSP=ko.pureComputed(this._tierCSP,this),this.potentialCSP=ko.pureComputed(this._potentialCSP,this),this.powerLevel=ko.pureComputed(this._powerLevel,this),this.classLetter=ko.pureComputed(this._classLetter,this),this.uniqueName=ko.pureComputed(this._uniqueName,this),this.iconBG=ko.pureComputed(this._iconBG,this),this.container=ko.observable(),this.reloadBucket=_.bind(this._reloadBucket,this),this.init(character),this.weapons.subscribe(app.addWeaponTypes),this.items.subscribe(app.addTierTypes)}tgd.ArmorSelection=function(groups){var self=this;self.groups=groups,self.armorGroups=ko.observableArray(),self.armorGroups(_.map(groups,function(items,bucketType){return new tgd.armorGroup(bucketType,items,self.armorGroups)})),self.selectedItems=ko.computed(function(){return _.map(self.armorGroups(),function(group){return group.selectedItem()})}),self.combinedStatPoints=ko.computed(function(){return tgd.sum(_.map(self.selectedItems(),function(item){return item.getValue("MaxLightCSP")}))}),self.bestSets=ko.computed(function(){var combos=tgd.cartesianProductOf(_.map(self.selectedItems(),function(item){return _.map(item.futureRolls,function(roll){var itemClone=_.clone(item);return itemClone.activeRoll=roll,itemClone})})),scoredCombos=_.map(combos,function(items){var tmp=tgd.joinStats(items);return{set:items,stats:tmp,statTiers:_.map(_.sortBy(_.keys(tmp)),function(name){return name.substring(0,3)+" T"+Math.floor(tmp[name]/tgd.DestinySkillTier)}).join(" "),score:tgd.sum(_.map(tmp,function(value,key){var result=Math.floor(value/tgd.DestinySkillTier);return result>5?5:result}))+tgd.sum(_.values(tmp))/1e3}}),highestScore=Math.floor(_.max(_.pluck(scoredCombos,"score")));console.log("highestScore",highestScore);var bestSets=_.uniq(_.filter(scoredCombos,function(combo){return combo.score>=highestScore}),!1,function(combo){return combo.statTiers});return bestSets}),self.statTiers=ko.computed(function(){return _.map(self.bestSets(),function(combo){return combo.statTiers}).join(", ")}),self.statValues=ko.computed(function(){return _.map(self.bestSets(),function(combo){return _.map(combo.stats,function(stat,name){return stat}).join("/")}).join(", ")}),self.projectedLightLevel=ko.computed(function(){return tgd.DestinyLightCap}),self.currentLightLevel=ko.computed(function(){return 10})},tgd.armorGroup=function(bucketType,items,groups){var self=this;self.bucketType=bucketType;var selectedIndex=0;self.selectedItem=ko.observable(),self.items=_.map(items,function(item,index){return new tgd.armorItem(item,self.selectedItem,groups)}),self.selectedItem(self.items[selectedIndex])},tgd.armorItem=function(item,selectedItem,groups){var self=this;_.extend(self,item);var isSelected=ko.computed(function(){return self==selectedItem()}),isDisabled=ko.computed(function(){var totalCSP=tgd.sum(_.map(groups(),function(group){return group.bucketType==self.bucketType?0:group.selectedItem().getValue("MaxLightCSP")}))+self.getValue("MaxLightCSP");return tgd.maxTierPointsPossible>=totalCSP});self.css=ko.computed(function(){return(isSelected()?"selected":"not-selected")+" "+(isDisabled()?"disabled":"not-disabled")}),this.select=function(){isDisabled()?BootstrapDialog.alert("This item cannot be selected to maintain the max tier"):selectedItem(self)}},window.ua=navigator.userAgent,window.isNWJS="undefined"!=typeof require,window.isChrome=/Chrome/.test(ua)&&/Google Inc/.test(navigator.vendor)&&"undefined"!=typeof chrome,window.isFirefox=/firefox/i.test(ua),window.isIOS=/ios|iphone|ipod|ipad/i.test(ua),window.isiPad=/ipad/i.test(ua),window.isAndroid=/android/i.test(ua),window.isWindowsPhone=/iemobile/i.test(ua),window.isMobile=window.isIOS||window.isAndroid||window.isWindowsPhone,window.isKindle=/Kindle/i.test(ua)||/Silk/i.test(ua)||/KFTT/i.test(ua)||/KFOT/i.test(ua)||/KFJWA/i.test(ua)||/KFJWI/i.test(ua)||/KFSOWI/i.test(ua)||/KFTHWA/i.test(ua)||/KFTHWI/i.test(ua)||/KFAPWA/i.test(ua)||/KFAPWI/i.test(ua),window.isStaticBrowser=location.protocol.indexOf("http")>-1&&-1==location.href.indexOf("towerghostfordestiny.com/firefox"),window.isStaticBrowser&&(window.isMobile=window.isWindowsPhone=window.isAndroid=window.isIOS=window.isFirefox=window.isChrome=window.isNWJS=!1),"undefined"==typeof window.tgd&&(window.tgd={}),"undefined"==typeof tgd.dataDir&&(tgd.dataDir="data"),isWindowsPhone&&(window.requestFileSystem=function(){}),tgd.localLogging=location.href.indexOf("debug")>-1,tgd.localLog=function(msg){tgd.localLogging&&console.log(msg)},tgd.remoteServer="https://towerghostfordestiny.com",tgd.remoteImagePath=tgd.remoteServer+"/www/",tgd.openTabAs=window.isMobile?"_system":"_blank",tgd.bootstrapGridColumns=24,tgd.autoTransferStacks=!1,tgd.DestinySkillCap=300,tgd.DestinyLightCap=320,tgd.DestinySkillTier=60,tgd.DestinyY1Cap=170,tgd.activeElement=null,tgd.DestinyUnwantedNodes=["Infuse","Upgrade Damage","Upgrade Defense","Arc Damage","Void Damage","Solar Damage","Kinetic Damage","Ascend","Reforge Ready","Twist Fate","Scabbard","Increase Intellect","Increase Strength","Increase Discipline"],tgd.DestinyGeneralItems={"Glimmer Credit":[3632619276,269776572,2904517731,1932910919],"Glimmer Buffs":[3446457162,1043138475,1772853454,3783295803],Synths:[211861343,928169143,2180254632],Parts:[1898539128],Motes:[937555249],Coins:[417308266,1738186005,605475555],Runes:[1565194903,2620224196,1556533319,1314217221,2906158273],"Planetary Resources":[2254123540,2882093969,3164836592,3242866270,1797491610],Telemetries:[4159731660,729893597,3371478409,927802664,4141501356,323927027,3036931873,2610276738,705234570,1485751393,2929837733,846470091]},tgd.lostItemsHelper=[420519466,1322081400,2551875383,398517733,583698483,937555249],tgd.invisibleItemsHelper=[2910404660,2537120989],tgd.itemsNotIndexed=[],tgd.DestinyGeneralSearches=["Synths","Parts","Motes","Coins","Runes","Planetary Resources","Glimmer Buffs","Glimmer Credit","Telemetries","Engrams"],tgd.DestinyArmorPieces=["Helmet","Gauntlet","Chest","Boots","Class Items","Artifact","Ghost"],tgd.DestinyArmorStats=[144602215,1735777505,4244567218],tgd.DestinyWeaponPieces=["Primary","Special","Heavy"],tgd.DestinyGeneralExceptions=["Ghost","Artifact"],tgd.DestinyNonUniqueBuckets=["Consumables","Materials"],tgd.DestinyFiveRowBuckets=["Materials","Consumables","Invisible","Messages","Lost"],tgd.DestinyLayout=[{name:"Weapons",array:"weapons",counts:[72,30],bucketTypes:tgd.DestinyWeaponPieces,extras:[],view:1,headerText:"inventory_weapons"},{name:"Armor",array:"armor",counts:[72,50],bucketTypes:tgd.DestinyArmorPieces,extras:tgd.DestinyGeneralExceptions,view:2,headerText:"inventory_armor"},{name:"Sub Classes",array:"",counts:[0,0],bucketTypes:["Subclasses"],extras:[],view:3,headerText:"inventory_subclasses"},{name:"General",array:"general",counts:[36,80],bucketTypes:["Consumables","Materials","Shader","Emblem","Ship","Sparrow","Horn","Emote"],extras:tgd.DestinyGeneralExceptions,view:3,headerText:"inventory_general"},{name:"Post Master",array:"postmaster",counts:[60,60],bucketTypes:["Messages","Invisible","Lost Items","Bounties","Quests","Mission"],extras:[],view:3,headerText:"inventory_postmaster"}],tgd.DestinyViews={0:"All",1:"Weapons",2:"Armor",3:"General"},tgd.DestinyGender={0:"Male",1:"Female"},tgd.DestinyClass={0:"Titan",1:"Hunter",2:"Warlock"},tgd.DestinyClassNames={},Object.keys(tgd.DestinyClass).forEach(function(key,index){tgd.DestinyClassNames[tgd.DestinyClass[index]]=key}),tgd.DestinyDamageTypes={0:"None",1:"Kinetic",2:"Arc",3:"Solar",4:"Void",5:"Raid"},tgd.DestinyBucketSizes={Materials:20,Consumables:20},tgd.DestinyBucketTypes={1498876634:"Primary",2465295065:"Special",953998645:"Heavy",3448274439:"Helmet",3551918588:"Gauntlet",14239492:"Chest",20886954:"Boots",2973005342:"Shader",4274335291:"Emblem",2025709351:"Sparrow",284967655:"Ship",3865314626:"Materials",1469714392:"Consumables",1585787867:"Class Items",3284755031:"Subclasses",375726501:"Mission",2197472680:"Bounties",12345:"Post Master",2422292810:"Post Master",1367666825:"Invisible",4023194814:"Ghost",434908299:"Artifact",3054419239:"Emote",1801258597:"Quests",3796357825:"Horn"},tgd.DestinyBucketColumns={Chest:3,Boots:3,Ship:3,Heavy:3,Consumables:4,Primary:3,Class:3,"Class Items":3,Sparrow:3,Special:3,Shader:3,Subclasses:3,Helmet:3,Gauntlet:3,Materials:4,Emblem:3,Bounties:4,Post:4,"Post Master":4,Messages:4,Lost:4,"Lost Items":4,Mission:4,Invisible:4,Ghost:3,Artifact:3,Quests:4,Emote:3,Horn:3},tgd.DestinyMaxCSP={Helmet:104,Gauntlet:93,Chest:138,Boots:128,"Class Items":58,Artifact:124,Ghost:58},tgd.DestinyBucketWeights=[{Primary:13.04,Special:13.04,Heavy:13.04,Helmet:10.87,Gauntlet:10.87,Chest:10.87,Boots:10.87,"Class Items":8.7,Ghost:8.7},{Primary:12,Special:12,Heavy:12,Helmet:10,Gauntlet:10,Chest:10,Boots:10,"Class Items":8,Ghost:8,Artifact:8}],tgd.languages=[{code:"en",description:"English",bungie_code:"en"},{code:"es",description:"Spanish",bungie_code:"es"},{code:"it",description:"Italian",bungie_code:"it"},{code:"de",description:"German",bungie_code:"de"},{code:"ja",description:"Japanese",bungie_code:"ja"},{code:"pt",description:"Portuguese",bungie_code:"pt-br"},{code:"fr",description:"French",bungie_code:"fr"},{code:"tr",description:"Turkish",bungie_code:"en"}],tgd.defaults={searchKeyword:"",doRefresh:isMobile?!1:"true",refreshSeconds:300,tierFilter:0,weaponFilter:0,armorFilter:0,generalFilter:0,dmgFilter:[],activeView:0,activeSort:0,progressFilter:0,showDuplicate:!1,setFilter:[],activeClasses:[],shareView:!1,shareUrl:"",showMissing:!1,showArmorPerks:!1,showArmorSC:!1,customFilter:!1,tooltipsEnabled:isMobile?!1:"true",advancedTooltips:isMobile?!1:"true",autoXferStacks:!1,padBucketHeight:isMobile?!1:"true",dragAndDrop:!1,xsColumn:tgd.bootstrapGridColumns,smColumn:tgd.bootstrapGridColumns/2,mdColumn:tgd.bootstrapGridColumns/3,lgColumn:tgd.bootstrapGridColumns/4,vaultColumns:tgd.bootstrapGridColumns/4,vaultWidth:tgd.bootstrapGridColumns/4,locale:"en",appLocale:"",vaultPos:0,itemDefs:"",preferredSystem:"PSN",ccWidth:"",layoutMode:"even",autoUpdates:isFirefox||isIOS||isAndroid||isChrome?"true":!1,toastTimeout:2600,armorViewBy:"Light",sectionsTemplate:"image-grid-template",farmMode:!1,farmViewEnabled:!1,farmItems:["Engrams","Glimmer","Rare","Uncommon"],farmTarget:"Vault"},tgd.farmItemFilters={Engrams:function(item){return item.description.indexOf("Engram")>-1&&"Lost Items"!=item.bucketType&&item.isEquipment===!1},Glimmer:function(item){return tgd.DestinyGeneralItems["Glimmer Credit"].indexOf(item.id)>-1},Rare:function(item){return 4==item.tierType&&item.locked()===!1&&(item.armorIndex>-1||item.weaponIndex>-1)&&item.transferStatus<2},Uncommon:function(item){return 3==item.tierType&&item.locked()===!1&&(item.armorIndex>-1||item.weaponIndex>-1)&&item.transferStatus<2}},$.toaster({settings:{toaster:{css:{top:"45px"}},timeout:tgd.defaults.toastTimeout}}),tgd.imageErrorHandler=function(src,element){return function(){if(element&&element.src&&""!==element.src){var source=element.src;-1==source.indexOf(tgd.remoteImagePath)&&(element.src=tgd.remoteImagePath+src.replace(tgd.dataDir,"data/"))}}},tgd.getEventDelegate=function(target,selector){for(var delegate;target&&target!=this.el;){if(delegate=$(target).filter(selector)[0])return delegate;target=target.parentNode}},window.ko.bindingHandlers.itemImageHandler={init:function(element,valueAccessor,allBindings,viewModel,bindingContext){var icon=ko.unwrap(valueAccessor());element.src=icon,element.onerror=tgd.imageErrorHandler(icon,element)},update:function(element,valueAccessor,allBindings,viewModel,bindingContext){var icon=ko.unwrap(valueAccessor());element.src=icon,element.onerror=tgd.imageErrorHandler(icon,element)}},window.ko.bindingHandlers.refreshableSection={init:function(element,valueAccessor,allBindings,viewModel,bindingContext){isMobile||$(element).bind("mouseenter",function(){$(this).addClass("titleHover"),$(this).find(".titleRefresh").show()}).bind("mouseleave",function(){$(this).removeClass("titleHover"),$(this).find(".titleRefresh").hide()})}},window.ko.bindingHandlers.refreshableEmblem={init:function(element,valueAccessor,allBindings,viewModel,bindingContext){isMobile||$(element).bind("mouseenter",function(){$(this).addClass("emblemHover")}).bind("mouseleave",function(){$(this).removeClass("emblemHover")})}},window.ko.bindingHandlers.scrollToView={init:function(element,valueAccessor,allBindings,viewModel,bindingContext){Hammer(element,{time:2e3}).on("tap",function(ev){var target=tgd.getEventDelegate(ev.target,".mobile-characters"),index=$(target).index(),distance=$(".profile:eq("+index+")");distance.length>0&&(distance=distance.position().top-50,app.scrollTo(distance))}).on("press",function(ev){var target=tgd.getEventDelegate(ev.target,".mobile-characters-image"),item=ko.contextFor(target).$data;$.toaster({priority:"info",title:"Info",message:app.activeText().this_icon+item.uniqueName(),settings:{timeout:tgd.defaults.toastTimeout}})})}},window.ko.bindingHandlers.fastclick={init:function(element,valueAccessor){return FastClick.attach(element),ko.bindingHandlers.click.init.apply(this,arguments)}},window.ko.bindingHandlers.moveItem={init:function(element,valueAccessor,allBindings,viewModel,bindingContext){Hammer(element,{time:2e3}).on("tap",function(ev){tgd.localLog("item.tap");var target=tgd.getEventDelegate(ev.target,".itemLink");if(target){var item=ko.contextFor(target).$data;tgd.moveItemPositionHandler(target,item)}}).on("doubletap",function(ev){tgd.localLog("item.doubletap");var target=tgd.getEventDelegate(ev.target,".itemLink");if(target){var context=ko.contextFor(target);if(context&&"$data"in context){var item=context.$data;if(item.transferStatus<2||"Subclasses"==item.bucketType)if(app.dynamicMode()===!1&&(app.dynamicMode(!0),app.createLoadout()),tgd.localLog("double tap"),item._id>0)app.activeLoadout().addUniqueItem({id:item._id,bucketType:item.bucketType,doEquip:!1});else{var payload={hash:item.id,bucketType:item.bucketType,characterId:item.characterId()};app.activeLoadout().addGenericItem(payload)}else $.toaster({priority:"danger",title:"Warning",message:app.activeText().unable_create_loadout_for_type,settings:{timeout:tgd.defaults.toastTimeout}})}}}).on("press",function(ev){tgd.localLog("item.press");var target=tgd.getEventDelegate(ev.target,".itemLink");if(target){var context=ko.contextFor(target);if(context&&"$data"in context){var item=context.$data;item&&item.doEquip&&app.loadoutMode()===!0?(item.doEquip(!item.doEquip()),item.markAsEquip(item,{target:target})):isMobile?($ZamTooltips.lastElement=target,$ZamTooltips.show("destinydb","items",item.id,target)):tgd.moveItemPositionHandler(target,item)}}})}},tgd.calculateStatRoll=function(item,targetLight,withBonus){var currentLight=item.primaryValues.Default,isItemLeveled=item.hasUnlockedStats,currentBonus=tgd.bonusStatPoints(item.armorIndex,currentLight),targetBonus=tgd.bonusStatPoints(item.armorIndex,targetLight),newStats=(item.getValue("All")-(isItemLeveled?currentBonus:0))*targetLight/currentLight,finalStat=newStats+(withBonus?targetBonus:0);return finalStat},tgd.bonusStatPoints=function(armorIndex,light){return 0==armorIndex?291>light?15:307>light?16:319>light?17:18:1==armorIndex?287>light?13:305>light?14:319>light?15:16:2==armorIndex?287>light?20:299>light?21:310>light?22:319>light?23:24:3==armorIndex?284>light?18:298>light?19:309>light?20:319>light?21:22:4==armorIndex?295>light?8:319>light?9:10:5==armorIndex?287>light?34:295>light?35:302>light?36:308>light?37:314>light?38:319>light?39:40:6==armorIndex?295>light?8:319>light?9:10:void 0},tgd.bungie=function(cookieString,complete){function _getAllCookies(callback){if(chrome&&chrome.cookies&&chrome.cookies.getAll)chrome.cookies.getAll({domain:"."+domain},function(){callback.apply(null,arguments)});else{if(!isNWJS)return callback([]),BootstrapDialog.alert("You must enable cookie permissions in Chrome before loading TGD");require("nw.gui").Window.get().cookies.getAll({},function(a,b){callback.apply(null,arguments)})}}function readCookie(cname){for(var name=cname+"=",ca=(cookieString||"").toString().split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "==c.charAt(0);)c=c.substring(1);if(0===c.indexOf(name))return c.substring(name.length,c.length)}return""}var active,self=this,domain="bungie.net",url="https://www."+domain+"/",apikey="5cae9cdee67a42848025223b4e61f929";this.bungled="",this.systemIds={},this.requests={},this.requestCookie=function(callback){tgd.localLog("sending request-cookie-from-ps");var event=new CustomEvent("request-cookie-from-ps",{});window.dispatchEvent(event),self.requestCookieCB=callback},this.getCookie=function(name,callback){isChrome?_getAllCookies(function(cookies){for(var c=null,i=0,l=cookies.length;l>i;++i)if(cookies[i].name===name){c=cookies[i];break}callback(c?c.value:null)}):isFirefox?self.requestCookie(callback):callback(readCookie("bungled"))},this.retryRequest=function(opts){opts.retries?opts.retries>3?opts.complete({error:"network error:"+this.status},response):(opts.retries++,setTimeout(function(){self.request(opts)},1e3*opts.retries)):(opts.retries=0,setTimeout(function(){self.request(opts)},2e3))},this.request=function(opts){-1==opts.route.indexOf("http")&&(opts.route=url+"Platform"+opts.route);var data;opts.payload&&(data=JSON.stringify(opts.payload)),$.ajax({url:opts.route,type:opts.method,headers:{"X-API-Key":apikey,"x-csrf":self.bungled},beforeSend:function(xhr){isMobile&&"string"==typeof cookieString&&_.each(cookieString.split(";"),function(cookie){try{var trimCookie=$.trim(cookie);xhr.setRequestHeader("Cookie",trimCookie)}catch(e){}})},data:data,complete:function(xhr,status){tgd.localLog("ajax complete");var response;if(xhr.status>=200&&xhr.status<=409){try{response=JSON.parse(xhr.responseText)}catch(e){}if(response&&response.ErrorCode&&(36==response.ErrorCode||1652==response.ErrorCode||1651==response.ErrorCode))self.retryRequest(opts);else{var obj=response;"object"==typeof obj&&"Response"in obj&&(obj=response.Response),opts.complete(obj,response)}}else self.retryRequest(opts)}})},this.vault=function(callback){self.request({route:"/Destiny/"+active.type+"/MyAccount/Vault/",method:"GET",complete:callback})},this.logout=function(callback){self.request({route:url+"en/User/SignOut",method:"GET",complete:callback})},this.login=function(callback){tgd.localLog("bungie.login"),self.request({route:url,method:"GET",complete:callback})},this.getUrl=function(){return url},this.setsystem=function(type){active=self.systemIds.xbl,"PSN"===type&&(active=self.systemIds.psn)},this.getMemberId=function(){return membershipId},this.gamertag=function(){return active?active.id:null},this.system=function(){return systemIds},this.user=function(callback){self.request({route:"/User/GetBungieNetUser/",method:"GET",complete:function(res,response){return response&&response.ErrorCode&&response.ErrorCode>1?void callback({error:response.Message,code:response.ErrorCode}):"undefined"==typeof res?void callback({error:"no response"}):(self.systemIds.xbl={id:res.gamerTag,type:1},self.systemIds.psn={id:res.psnId,type:2},active=self.systemIds.xbl,res.psnId&&(active=self.systemIds.psn),void callback(res))}})},this.account=function(callback){self.request({route:"/Destiny/"+active.type+"/Account/"+active.membership+"/",method:"GET",complete:callback})},this.setlockstate=function(characterId,itemId,state,callback){self.request({route:"/Destiny/SetLockState/",method:"POST",payload:{membershipType:active.type,characterId:characterId,itemId:itemId,state:state},complete:callback})},this.transfer=function(characterId,itemId,itemHash,amount,toVault,callback){self.request({route:"/Destiny/TransferItem/",method:"POST",payload:{characterId:characterId,membershipType:active.type,itemId:itemId,itemReferenceHash:itemHash,stackSize:amount,transferToVault:toVault},complete:callback})},this.equip=function(characterId,itemId,callback){self.request({route:"/Destiny/EquipItem/",method:"POST",payload:{membershipType:active.type,characterId:characterId,itemId:itemId},complete:callback})},this.getAccountSummary=function(callback){self.request({route:"/Destiny/"+active.type+"/Account/"+active.membership+"/Summary/",method:"GET",complete:callback})},this.getItemDetail=function(characterId,instanceId,callback){self.request({route:"/Destiny/"+active.type+"/Account/"+active.membership+"/Character/"+characterId+"/Inventory/"+instanceId+"/",method:"GET",complete:callback})},this.inventory=function(characterId,callback){self.request({route:"/Destiny/"+active.type+"/Account/"+active.membership+"/Character/"+characterId+"/Inventory/",method:"GET",complete:callback})},this.character=function(characterId,callback){self.request({route:"/Destiny/"+active.type+"/Account/"+active.membership+"/Character/"+characterId+"/",method:"GET",complete:callback})},this.search=function(activeSystem,callback){this.setsystem(activeSystem),active&&active.type&&("undefined"==typeof active.membership?self.request({route:"/Destiny/"+active.type+"/Stats/GetMembershipIdByDisplayName/"+active.id+"/",method:"GET",complete:function(membership){return membership>0?(active.membership=membership,void self.account(callback)):void callback({error:!0})}}):self.account(callback))},this.account=function(callback){tgd.localLog(active.type+" log request to "+JSON.stringify(active.membership)),self.request({route:"/Destiny/"+active.type+"/Account/"+active.membership+"/",method:"GET",complete:callback})},this.flattenItemArray=function(buckets){var items=[];return _.isArray(buckets)?buckets.forEach(function(bucket){bucket.items.forEach(function(item){items.push(item)})}):Object.keys(buckets).forEach(function(bucketName){buckets[bucketName].forEach(function(bucket){bucket.items.forEach(function(item){item.bucketName=bucketName,items.push(item)})})}),items},this.init=function(){isFirefox&&window.addEventListener("response-cookie-from-cs",function(event){tgd.localLog("response-cookie-from-cs: "+event.detail),self.requestCookieCB(event.detail)}),tgd.localLog("bungie.init"),isStaticBrowser?complete(""):self.login(function(){tgd.localLog("bungie.login.complete, now getCookie"),self.getCookie("bungled",function(token){tgd.localLog("bungied started with token "+token),self.bungled=token,complete(token)})})},this.init()},tgd.dialog=function(options){var self=this;return this.modal=new BootstrapDialog(options),this.options=options,self},tgd.dialog.prototype={title:function(title){return this.modal.setTitle(title),this},content:function(content){return this.modal.setMessage(content),this},buttons:function(buttons){return this.modal.setClosable(!0).enableButtons(!0).setData("buttons",buttons),this},show:function(excludeClick,onHide,onShown){var self=this;self.modal.open();var mdl=self.modal.getModal();return excludeClick||mdl.bind("click",function(){self.modal.close()}),mdl.on("hide.bs.modal",onHide),mdl.on("shown.bs.modal",onShown),self}},tgd.Layout=function(layout){var self=this;self.name=layout.name,self.id=layout.view,self.bucketTypes=layout.bucketTypes,self.extras=layout.extras,self.headerText=layout.headerText,self.array=layout.array,self.counts=layout.counts,self.activeBucketTypes=ko.computed(self._activeBucketTypes,self)},tgd.Layout.prototype={_activeBucketTypes:function(){var self=this,bucketTypes=self.bucketTypes;return"3"==app.activeView()&&(bucketTypes=bucketTypes.concat(self.extras)),bucketTypes},countText:function(character){var self=this;return ko.pureComputed(function(){var text="";if(""!==self.array&&"Vault"==character.id){var currentAmount=character[self.array]().length,totalAmount="Vault"==character.id?self.counts[0]:self.counts[1];text="("+currentAmount+"/"+totalAmount+")",currentAmount==totalAmount&&(text="<label class='label label-danger'>"+text+"</label>")}return text})},titleText:function(character){var self=this;return ko.pureComputed(function(){return"Vault"==character.id&&"Sub Classes"==self.name?"Vault Sub Classes":app.activeText()[self.headerText]})},isVisible:function(character){var self=this;return ko.pureComputed(function(){return"Vault"==character.id&&"Post Master"!==self.name||"Vault"!==character.id})}},tgd.loadoutId=0,tgd.LoadoutItem=function(model){var self=this;_.each(model,function(value,key){self[key]=value});var _doEquip=model&&"undefined"==typeof model.hash?self.doEquip&&"true"==self.doEquip.toString()||!1:!1;this.doEquip=ko.observable(_doEquip)},tgd.Loadout=function(model,isItems){var self=this;if(_.each(model,function(value,key){self[key]=value}),this.loadoutId=tgd.loadoutId++,this.name=ko.observable(self.name||""),this.ids=ko.observableArray(),this.generics=ko.observableArray(),this.items=ko.pureComputed(function(){var _items=[];return _.each(self.ids(),function(equip){if(equip){var itemFound=self.findItemById(equip.id);itemFound&&(itemFound.doEquip=equip.doEquip,itemFound.markAsEquip=self.markAsEquip,_items.push(itemFound))}}),_.each(self.generics(),function(item){if(item&&item.hash){var itemFound=self.findItemByHash(item.hash,item.characterId);itemFound&&(itemFound.doEquip=item.doEquip,itemFound.markAsEquip=self.markAsEquip,_items.push(itemFound))}}),_items.sort(function(a,b){return a.armorIndex>-1?a.armorIndex-b.armorIndex:a.weaponIndex>-1?a.weaponIndex-b.weaponIndex:-1})}),this.markAsEquip=function(item,event){var existingItems=_.where(self.ids(),{bucketType:item.bucketType}).filter(function(loadoutItem){var foundItem=_.find(self.items(),{_id:loadoutItem.id});return foundItem?"Subclasses"==item.bucketType||-1!=foundItem.armorIndex?item.doEquip()===!0&&item._id!=loadoutItem.id&&item.character.classType()==foundItem.character.classType():item.doEquip()===!0&&item._id!=loadoutItem.id:!1});return 6==item.tierType&&item.hasLifeExotic===!1&&item.doEquip()&&_.each(self.ids(),function(equip){var itemFound=self.findItemById(equip.id);itemFound&&itemFound.tierType&&6==itemFound.tierType&&itemFound.hasLifeExotic===!1&&equip.doEquip()&&equip.id!=item._id&&(item.weaponIndex>-1&&itemFound.weaponIndex>-1||item.armorIndex>-1&&itemFound.armorIndex>-1)&&existingItems.push(equip)}),existingItems.length>0&&_.each(existingItems,function(loadoutItem){loadoutItem.doEquip(!1)}),item.doEquip()&&_.findWhere(self.ids(),{id:item._id}).doEquip(!0),!0},isItems)_.each(model,function(item){item._id>0?self.addUniqueItem({id:item._id,bucketType:item.bucketType,doEquip:!1}):self.addGenericItem({hash:item.id,bucketType:item.bucketType,characterId:item.characterId()})});else if(model&&model.ids&&model.ids.length>0){var firstItem=model.ids[0];if(firstItem&&_.isString(firstItem)){var _ids=[];_.each(model.ids,function(id){var equipDef=_.findWhere(model.equipIds,{_id:id}),item=self.findItemById(id);item&&_ids.push(new tgd.LoadoutItem({id:id,bucketType:equipDef?equipDef.bucketType:item.bucketType,doEquip:equipDef?!0:!1}))}),self.ids(_ids)}else self.ids(_.map(model.ids,function(obj){return new tgd.LoadoutItem(obj)}))}},tgd.Loadout.prototype={normalize:function(bucketTypes,extras){var arrUnion=_.difference(extras,bucketTypes),arr=[];return arr=arrUnion.length==extras.length?_.union(bucketTypes,extras):_.difference(bucketTypes,extras)},toJSON:function(){var copy=ko.toJS(this);return delete copy.items,copy},compareLoadout:function(){var ids=_.pluck(this.items(),"id").join(",");window.open("http://db.destinytracker.com/compare/"+ids,tgd.openTabAs)},setActive:function(){app.loadoutMode(!0),app.dynamicMode(!1),app.activeLoadout(_.clone(this))},remove:function(){var ref=_.findWhere(app.loadouts(),{loadoutId:this.loadoutId});app.loadouts.remove(ref),app.createLoadout(),app.saveLoadouts()},save:function(){var ref=_.findWhere(app.loadouts(),{loadoutId:this.loadoutId});ref&&app.loadouts.splice(app.loadouts().indexOf(ref),1),app.loadouts.push(this),app.saveLoadouts()},saveNew:function(){app.loadouts.push(this),app.saveLoadouts()},addUniqueItem:function(obj){this.ids.push(new tgd.LoadoutItem(obj))},addGenericItem:function(obj){this.generics.push(new tgd.LoadoutItem(obj))},findItemByHash:function(hash,characterId){var itemFound;return app.characters().forEach(function(character){var match=_.filter(character.items(),function(item){return characterId?item.id==hash&&item.characterId()==characterId:item.id==hash})[0];match&&(itemFound=_.clone(match))}),itemFound},findItemById:function(id){var itemFound;return app.characters().forEach(function(character){var match=_.findWhere(character.items(),{_id:id});match&&(itemFound=_.clone(match))}),itemFound},swapItems:function(swapArray,targetCharacterId,callback){var self=this;tgd.autoTransferStacks=!0;var itemIndex=-1,increments=parseInt(Math.round(95/(1*swapArray.length))),progressValue=5,loader=$(".bootstrap-dialog-message .progress").show().find(".progress-bar").width(progressValue+"%"),transferNextItem=function(){tgd.localLog("**************transferNextItem*************");var targetItem,swapItem,targetOwner,pair=swapArray[++itemIndex];progressValue+=increments,loader.width(progressValue+"%");var transferTargetItemToVault=function(complete){if(targetItem=pair.targetItem,"undefined"!=typeof targetItem)if(targetOwner=targetItem.character.id,tgd.localLog(" transferTargetItemToVault "+targetItem.description),"Vault"==targetOwner)complete();else{var originalCharacterId=targetItem.character.id;targetItem.store("Vault",function(profile){profile.id==originalCharacterId?($.toaster({priority:"danger",title:"Error",message:"Unable to unequip "+targetItem.description+" while playing in game"}),complete()):complete()})}else complete()},transferSwapItemToVault=function(complete){if(swapItem=pair.swapItem,tgd.localLog("^^^^^^^^^^"+swapItem.character.id+" transferSwapItemToVault "+swapItem.description),"Vault"==swapItem.character.id)complete();else{var originalCharacterId=swapItem.character.id;swapItem.store("Vault",function(profile){if(tgd.localLog(originalCharacterId+" transferSwapItemToVault result "+profile.id),profile.id==originalCharacterId){var equippedItem=swapItem;tgd.localLog("^^^^^^^^^unequipped failed for "+swapItem.description),tgd.localLog(swapArray);var swapAndTargetIDs=_.flatten(_.map(swapArray,function(pair){var tmp=[];return pair.swapItem&&tmp.push(pair.swapItem._id),pair.targetItem&&tmp.push(pair.targetItem._id),tmp}));tgd.localLog("swapAndTargetIDs: "+swapAndTargetIDs),tgd.localLog("targetItem character is "+targetItem.character.uniqueName());var candidates=_.filter(swapItem.character.get(swapItem.bucketType),function(item){var isCandidate=-1==swapAndTargetIDs.indexOf(item._id);return tgd.localLog(item.description+" is part of the swap and target ids? "+isCandidate),isCandidate});tgd.localLog(candidates.length+" candidates: "+_.pluck(candidates,"description")),candidates.length>0?(swapItem=candidates[0],tgd.localLog("candidate is "+swapItem._id+" and is currently sitting in "+swapItem.character.uniqueName()),swapItem.store("Vault",function(){tgd.localLog("^^^^^^^ xfered new candidate to vault"),complete()})):($.toaster({priority:"danger",title:"Error",message:"Unable to unequip "+equippedItem.description+" while playing in game"}),pair.swapItem=pair.targetItem=targetItem=swapItem=null,
tgd.localLog("No candidates can't xfer targetItem"),complete())}else complete()})}},transferTargetItemToDestination=function(complete){if("undefined"==typeof targetItem&&pair.targetItem&&(targetItem=pair.targetItem),targetItem){var action=0===_.where(self.ids(),{id:targetItem._id}).filter(function(item){return item.doEquip()===!0}).length?"store":"equip";if(tgd.localLog(targetItem.description+" transferTargetItemToDestination "+targetCharacterId+" action: "+action),"Vault"==targetCharacterId&&"Vault"==targetItem.character.id)tgd.localLog("transferTargetItemToDestination: item needs to be in Vault and is already in Vault"),complete();else{var originalCharacterId=targetItem.character.id;targetItem[action](targetCharacterId,function(profile){profile.id==originalCharacterId?($.toaster({priority:"danger",title:"Error",message:"Unable to unequip "+targetItem.description+" while playing in game"}),complete()):complete()})}}else complete()},transferSwapItemToDestination=function(complete){"undefined"==typeof swapItem&&pair.swapItem&&(swapItem=pair.swapItem),swapItem?(tgd.localLog(targetOwner+" (targetOwner) transferSwapItemToDestination "+swapItem.description),"Vault"==targetOwner&&"Vault"==swapItem.character.id?(tgd.localLog("transferSwapItemToDestination: item needs to be in Vault and is already in Vault"),complete()):swapItem.store(targetOwner,complete)):complete()},startSwapping=function(finish){tgd.localLog("startSwapping "),transferTargetItemToVault(function(){tgd.localLog("finished transferTargetItemToVault at "),transferSwapItemToVault(function(){tgd.localLog("finished transferSwapItemToVault at "),transferTargetItemToDestination(function(){tgd.localLog("finished transferTargetItemToDestination item to vault at "),transferSwapItemToDestination(function(){tgd.localLog("*********finished transferSwapItemToDestination swap items **************"),finish?finish():transferNextItem()})})})})},checkAndMakeFreeSpace=function(ref,spaceNeeded,fnHasFreeSpace){var item=ref;if("undefined"==typeof item)return BootstrapDialog.alert(self.description+": Item not found while attempting to transfer the item "+ref.description);if("Subclasses"==ref.bucketType)return fnHasFreeSpace();var otherBucketTypes,vault=_.findWhere(app.characters(),{id:"Vault"}),bucketType=item.bucketType,layout=_.filter(tgd.DestinyLayout,function(layout){return layout.bucketTypes.indexOf(bucketType)>-1&&-1==layout.extras.indexOf(bucketType)||-1==layout.bucketTypes.indexOf(bucketType)&&layout.extras.indexOf(bucketType)>-1})[0],actualBucketTypes=self.normalize(layout.bucketTypes,layout.extras),spaceNeededInVault=layout.counts[0]-spaceNeeded,spaceUsedInVault=_.filter(vault.items(),function(otherItem){return actualBucketTypes.indexOf(otherItem.bucketType)>-1}).length;if(tgd.localLog(bucketType+" spaceNeededInVault: "+spaceNeededInVault),tgd.localLog(bucketType+" spaceUsedInVault: "+spaceUsedInVault),spaceNeededInVault>=spaceUsedInVault)tgd.localLog("vault has at least 2 slots to make xfer"),fnHasFreeSpace();else{var maxFreeSpace=9,tmpItems=[],tmpIds=[],freeSpaceNeeded=spaceUsedInVault-spaceNeededInVault;tgd.localLog("Vault does not have enough free space, need to temp move something from here to free up x slots: "+freeSpaceNeeded),otherBucketTypes=[].concat(actualBucketTypes),otherBucketTypes.splice(otherBucketTypes.indexOf(bucketType),1),tgd.localLog("other bucket types: "+otherBucketTypes),tgd.localLog(otherBucketTypes+" being checked in other characters"),_.each(otherBucketTypes,function(bucketType){-1==tgd.DestinyNonUniqueBuckets.indexOf(bucketType)&&_.each(app.characters(),function(character){if(freeSpaceNeeded>0&&"Vault"!=character.id){tgd.localLog("checking "+character.uniqueName()+" the "+bucketType);var freeSpace=maxFreeSpace-character.get(bucketType).length;if(freeSpace>0){tgd.localLog(bucketType+" found with free space: "+freeSpace);var itemsToMove=vault.get(bucketType);tgd.localLog("vault has these many of those items to move "+itemsToMove.length),_.each(itemsToMove,function(item){freeSpaceNeeded>0&&freeSpace>0&&-1==tmpIds.indexOf(item._id)&&(tmpItems.push({item:item,character:character}),tmpIds.push(item._id),freeSpaceNeeded-=1,freeSpace-=1)})}}})}),tgd.localLog("so the plan is to move these from the vault "),tgd.localLog(tmpItems);var preCount=0,postCount=0,finish=function(){postCount++,postCount==tmpItems.length&&(tgd.localLog("********* temp items moved back, finished, transferNextItem ********* "),transferNextItem())},done=function(){preCount++,tgd.localLog("current: "+preCount+" total: "+tmpItems.length+" vault size: "),preCount==tmpItems.length&&(tgd.localLog("moved temp items out, now start swap with callback "),fnHasFreeSpace(function(){_.each(tmpItems,function(pair){pair.item.store("Vault",finish)})}))};_.each(tmpItems,function(pair){pair.item.store(pair.character.id,done)})}};pair?"undefined"!=typeof pair.swapItem?checkAndMakeFreeSpace(pair.swapItem,2,startSwapping):"undefined"!=typeof pair.targetItem?(tgd.localLog("no swapItem, transferTargetItem"),checkAndMakeFreeSpace(pair.targetItem,1,function(callback){transferTargetItemToDestination(function(){callback?callback():transferNextItem()})})):(tgd.localLog("******* if pair else (no target, swap) transferNextItem**********************"),transferNextItem()):(tgd.localLog("pair is not defined, calling callback"),tgd.autoTransferStacks=!1,callback&&callback())};app.activeLoadout(new tgd.Loadout),app.loadoutMode(!1),transferNextItem()},transfer:function(targetCharacterId,callback){var self=this,targetCharacter=_.findWhere(app.characters(),{id:targetCharacterId});if("undefined"==typeof targetCharacter)return BootstrapDialog.alert("Target character not found");var swapItem,targetCharacterIcon=targetCharacter.icon(),getFirstItem=function(sourceBucketIds,itemFound){return function(otherItem){return-1==sourceBucketIds.indexOf(otherItem._id)&&itemFound===!1?(itemFound=!0,sourceBucketIds.push(otherItem._id),otherItem):void 0}},masterSwapArray=[],sourceItems=self.items();if(sourceItems.length>0){var targetList=targetCharacter.items(),sourceGroups=_.groupBy(sourceItems,"bucketType"),targetGroups=_.groupBy(targetList,"bucketType");masterSwapArray=_.flatten(_.map(sourceGroups,function(group,key){var sourceBucket=sourceGroups[key],targetBucket=targetGroups[key]||[],swapArray=[];if(sourceBucket&&targetBucket)if(-1==tgd.DestinyNonUniqueBuckets.indexOf(key)){var maxBucketSize=10,targetBucketSize=targetBucket.length;if("Vault"==targetCharacter.id){var layout=_.filter(tgd.DestinyLayout,function(layout){return layout.bucketTypes.indexOf(key)>-1&&-1==layout.extras.indexOf(key)||-1==layout.bucketTypes.indexOf(key)&&layout.extras.indexOf(key)>-1})[0],actualBucketTypes=self.normalize(layout.bucketTypes,layout.extras);targetBucketSize=_.filter(targetCharacter.items(),function(item){return actualBucketTypes.indexOf(item.bucketType)>-1}).length,maxBucketSize=layout.counts[0]}var targetMaxed=targetBucketSize==maxBucketSize;if(tgd.localLog(key+" bucket max of "+maxBucketSize+" : "+targetMaxed),tgd.localLog("need to transfer "+sourceBucket.length+" items, the target is this full "+targetBucketSize),sourceBucket.length+targetBucketSize>maxBucketSize){tgd.localLog("using swap strategy");var sourceBucketIds=_.pluck(sourceBucket,"_id");swapArray=_.map(sourceBucket,function(item){var ownerIcon=item.character.icon();if(_.findWhere(targetBucket,{_id:item._id}))return item.doEquip()===!0?{targetItem:item,description:item.description+app.activeText().loadouts_to_equip,actionIcon:"assets/to-equip.png",swapIcon:targetCharacterIcon}:{description:item.description+app.activeText().loadouts_alreadythere_pt1+targetCharacter.classType()+app.activeText().loadouts_alreadythere_pt2+item.bucketType,targetIcon:item.icon,actionIcon:"assets/no-transfer.png",swapIcon:ownerIcon};var itemFound=!1;if("Shader"==item.bucketType)swapItem=_.filter(targetBucket,function(otherItem){return otherItem.bucketType==item.bucketType&&"Default Shader"!=otherItem.description&&-1==sourceBucketIds.indexOf(otherItem._id)})[0];else{tgd.localLog("looking for a swap item for "+item.description);var sourceBucketHashes=_.pluck(_.where(item.character.items(),{bucketType:item.bucketType}),"id");tgd.localLog("the owner of this swap item has these items: "+sourceBucketHashes),tgd.localLog("the target where this is going has these many items "+targetBucket.length);var candidates=_.filter(targetBucket,function(otherItem){var index=sourceBucketHashes.indexOf(otherItem.id);return tgd.localLog(index+" candidate: "+otherItem.description),-1==index&&otherItem.transferStatus<2});tgd.localLog("candidates: "+_.pluck(candidates,"description")),swapItem=_.filter(_.where(candidates,{type:item.type}),getFirstItem(sourceBucketIds,itemFound)),tgd.localLog("1.swapItem: "+swapItem.length),0===swapItem.length&&tgd.localLog(targetBucket),swapItem=swapItem.length>0?swapItem[0]:_.filter(candidates,getFirstItem(sourceBucketIds,itemFound))[0],swapItem||(swapItem=_.filter(targetBucket,getFirstItem(sourceBucketIds,itemFound))[0])}return swapItem?(tgd.localLog("2.swapItem: "+swapItem.description),targetBucket.splice(targetBucket.indexOf(swapItem),1),-1!=swapItem.armorIndex&&"Vault"!=item.character.id&&item.character.classType()!=targetCharacter.classType()?{description:item.description+app.activeText().loadouts_no_transfer,targetIcon:item.icon,actionIcon:"assets/no-transfer.png",swapIcon:ownerIcon}:{targetItem:item,swapItem:swapItem,description:item.description+app.activeText().loadouts_swap+swapItem.description,actionIcon:"assets/swap.png"}):(tgd.localLog("to transfer: "+item.description),{targetItem:item,description:item.description+app.activeText().loadouts_to_transfer,swapIcon:targetCharacterIcon,actionIcon:"assets/to-transfer.png"})})}else swapArray=_.map(sourceBucket,function(item){var ownerIcon=item.character.icon();return _.findWhere(targetBucket,{_id:item._id})?(tgd.localLog(item.description+" item is already in target bucket, doEquip? "+item.doEquip()),item.doEquip()===!0?{targetItem:item,description:item.description+app.activeText().loadouts_to_equip,actionIcon:"assets/to-equip.png",swapIcon:targetCharacterIcon}:{description:item.description+app.activeText().loadouts_alreadythere_pt1+targetCharacter.classType()+app.activeText().loadouts_alreadythere_pt2+item.bucketType,targetIcon:item.icon,actionIcon:"assets/no-transfer.png",swapIcon:ownerIcon}):"Subclasses"==item.bucketType?(tgd.localLog(item.description+" wont transfer sub classes "),{description:item.description+app.activeText().loadouts_no_transfer,targetIcon:item.icon,actionIcon:"assets/no-transfer.png",swapIcon:ownerIcon}):item.doEquip()===!0?{targetItem:item,description:item.description+app.activeText().loadouts_to_moveequip,actionIcon:"assets/to-equip.png",swapIcon:targetCharacterIcon}:(tgd.localLog("loadouts_to_transfer: "+item.description),{targetItem:item,description:item.description+app.activeText().loadouts_to_transfer,actionIcon:"assets/to-transfer.png",swapIcon:targetCharacterIcon})})}else swapArray=_.map(sourceBucket,function(item){return{targetItem:item,description:item.description+app.activeText().loadouts_to_transfer,actionIcon:"assets/to-transfer.png",swapIcon:targetCharacterIcon}});return swapArray}))}if(callback){if(!_.isFunction(callback))return masterSwapArray;callback(masterSwapArray)}else self.promptUserConfirm(masterSwapArray,targetCharacterId)},generateTemplate:function(masterSwapArray,targetCharacterId,indexes){var self=this,html=$(tgd.swapTemplate({swapArray:masterSwapArray})+$(".progress").find(".progress-bar").width(0).end().clone().wrap("<div>").parent().show().html()),targetCharacter=_.findWhere(app.characters(),{id:targetCharacterId}),swapIds=_.pluck(_.pluck(masterSwapArray,"swapItem"),"_id");return html.find(".item").click(!1),html.find(".swapItem").click(function(){var instanceId=$(this).attr("instanceid"),item=self.findItemById(instanceId);if(item){var items=targetCharacter.get(item.bucketType),candidates=_.filter(items,function(candidate){return-1==swapIds.indexOf(candidate._id)&&candidate.transferStatus<2});candidates.length>0&&(_.each(masterSwapArray,function(pair){if(pair&&pair.swapItem&&pair.swapItem._id==instanceId){var targetId=pair.targetItem._id;targetId in indexes&&indexes[targetId]+1<candidates.length?indexes[targetId]++:indexes[targetId]=0,pair.swapItem=candidates[indexes[targetId]]}}),self.loadoutsDialog.content(self.generateTemplate(masterSwapArray,targetCharacterId,indexes)))}}),html},promptUserConfirm:function(masterSwapArray,targetCharacterId,callback){if(masterSwapArray.length>0){var self=this;self.indexes={};var $template=self.generateTemplate(masterSwapArray,targetCharacterId,self.indexes),transfer=function(dialog){self.swapItems(masterSwapArray,targetCharacterId,function(){if($.toaster({settings:{timeout:15e3},priority:"success",title:"Success",message:app.activeText().loadouts_transferred}),setTimeout(function(){$(".donateLink").click(app.showDonate)},1e3),app.dynamicMode(!1),dialog.close(),callback){var targetCharacter=_.findWhere(app.characters(),{id:targetCharacterId});callback(targetCharacter)}})};self.loadoutsDialog=new tgd.dialog({buttons:[{label:app.activeText().loadouts_transfer,action:function(dialog){transfer(dialog)}},{label:app.activeText().cancel,action:function(dialog){dialog.close()}}]}).title(app.activeText().loadouts_transfer_confirm).content($template).show(!0,function(){$(document).unbind("keyup.dialog")},function(){$(document).unbind("keyup.dialog").bind("keyup.dialog",function(e){var code=e.which;13==code&&(transfer(self.loadoutsDialog.modal),$(document).unbind("keyup.dialog"))})})}}},tgd.locale={en:{agility:"Agility",armor:"Armor",best_combo:"Best Combo",cancel:"Cancel",cannot_equip:"Unknown error trying to equip ",cannot_unequip:"No more items to try to unequip the ",close_msg:"Close",disc:"Disc",discipline:"Discipline",donation_instructions:"This is a non-commercial project dedicated to Destiny. If you like this app provide a donation to keep this project alive and support the maintenance costs.",donation_title:"Donations for Tower Ghost for Destiny!",error_loading_inventory:"Error loading inventory ",gear_with_highest:"Equip Gear With Highest:",inte:"Int",intellect:"Intellect",invalid_transfer_amount:"Invalid amount entered: ",inventory_armor:"Armor",inventory_general:"General",inventory_postmaster:"Post Master",inventory_postmaster_messages:"Messages",inventory_postmaster_lost_items:"Lost Items",inventory_subclasses:"Sub Classes",inventory_weapons:"Weapons",itemDefs_undefined:"Could not load item definitions, please report the issue to my Github including the version number being used.",language_pack_downloaded:"Language Pack downloaded, please refresh to see the changes",language_text:"This will change the language for all items and the interface for some languages, more languages will be added in the future.",light:"Light",loadouts_alreadythere_pt1:" is already in the ",loadouts_alreadythere_pt2:"'s bucket of ",loadouts_delete:"Delete",loadouts_desktop:"check",loadouts_instructions:"No items in loadout, click items to add, ",loadouts_instructions_contd:" to equip.",loadouts_invalidbucket:" will not be moved. Because of this bucket: ",loadouts_mobile:"hold",loadouts_no_replacement:" will not be moved. There is no item to replace it.",loadouts_no_transfer:" will not be moved",loadouts_outofspace:" will not be moved, there is no space in ",loadouts_save:"Save",loadouts_save_new:"Save As",loadouts_swap:" will be swapped with ",loadouts_to_equip:" will be equipped.",loadouts_to_moveequip:" will be moved and equipped.",loadouts_to_transfer:" will be moved",loadouts_transfer:"Transfer",loadouts_transfer_confirm:"Transfer Confirm",loadouts_transferred:'<strong>Item(s) Transferred!</strong><br>If you like this app remember to <a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">buy me a beer</a>.',login_authenticating_pt1:"Logging into Bungie... Please be patient.",login_authenticating_pt2:"If log in screen remains for 2+ minutes, use these links for",login_authenticating_pt3:"to retry login. If the problem persists, reinstall the app.",login_help:"Please wait for the login window to auto close as TGD prepares your information.",login_instructions:"To get started you'll need to log in to your Bungie.net account via:",login_loading_updates:"Please wait, downloading auto updates",login_loading_inventory:"Please wait, loading arsenal from Bungie",login_title:"Welcome to Tower Ghost for Destiny!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"About",menu_advancedtooltips:"Advanced Tooltips",menu_all:"All",menu_autorefresh:"Auto Refresh (5 min)",menu_autotransfer:"Auto Transfer Stacks",menu_clear:"Clear Filters",menu_destinydbtooltips:"DestinyDB Tooltips",menu_destinydbmode:"DestinyDB Mode",menu_destinystatus:"DestinyStatus Report",menu_destinytrials:"DestinyTrials Report",menu_destinytracker:"DestinyTracker Report",menu_destinyguardiangg:"Guardian.GG Report",menu_damage:"Damage",menu_donate:"Donate",menu_filter_by:"Filter By",menu_filter_by_subclass_eq:"Subclass Equipped",menu_filter_by_weapon_eq:"Weapons Equipped",menu_filter_for_class:"Filter for Class",menu_help:"Help",menu_language:"Language",menu_loadouts:"Loadouts",menu_loadouts_create:"Create",menu_padheight:"Auto Pad Height",menu_progress:"Progress",menu_progress_1:"Missing Perks",menu_progress_2:"Missing Border",menu_progress_3:"Maxed",menu_refresh:"Refresh (secs)",menu_set:"Set",menu_set_showmissing:"Show Missing Items",menu_set_showduplicates:"Show Duplicate Items",menu_settings:"Settings",menu_shareurl:"Share URL with friends",menu_sortby:"Sort By",menu_sortby_damage:"Damage Type",menu_sortby_lightlvl:"Light Level",menu_sortby_name:"Name",menu_sortby_type:"Type",menu_sortby_tier_type:"Tier, Type",menu_sortby_tier_light:"Tier, Light",menu_sortby_tier_name:"Tier, Name",menu_tier:"Tier",menu_usexbox:"Use Xbox Account",menu_useps:"Use Playstation Account",menu_view:"View",menu_view_armor:"Armor",menu_view_by:"View By",menu_view_by_lightlvl:"Light Level",menu_view_by_stat_points:"Combined Stat Points",menu_view_general:"General",menu_view_options:"View Options",menu_view_weapons:"Weapons",missing_items:"Missing Items",most_points:"Most Points",movepopup_move:"Move",movepopup_store:"store",movepopup_equip:"equip",movepopup_vault:"vault",movepopup_extras:"extras",normalize_title:"Normalize - equally distribute item across your characters",paypal_code:"EN",pick_a_set:"Please pick a Set before selecting this option",strength:"Strength",recovery:"Recovery",str:"Str",text_shareurl:"Your inventory is updated by clicking on Share URL from the menu again.",this_icon:"This icon is ",tier_common:"Common",tier_exotic:"Exotic",tier_legendary:"Legendary",tier_rare:"Rare",tier_uncommon:"Uncommon",transfer:"Transfer",transfer_all:"All",transfer_amount:"Transfer Amount",transfer_ask:"Don't ask in the future",transfer_consolidate:"Consolidate (pull from all characters",transfer_one:"One",unable_create_loadout_for_type:"Currently unable to create loadouts with this item type.",unable_unequip:"Unable to unequip ",unable_to_create_loadout_for_bucket:"You cannot create a loadout with more than 10 items in this slot: ",unable_to_move_bucketitems:"This item cannot be transferred with the API.",vo_container_width:"Container Width",vo_layout_mode:"Vault Mode",vo_layout_mode_cust:"Custom",vo_layout_mode_def:"Default",vo_number_of_columns:"Number of Columns",vo_vault_columns:"Vault Columns",vo_vault_first:"First/Left",vo_vault_last:"Last/Right",vo_vault_position:"Vault Position",vo_vault_width:"Vault Width",whats_new_title:"Tower Ghost for Destiny Updates"},de:{agility:"Agil",armor:"Rstg",best_combo:"Beste Komb.",cancel:"Abbrechen",cannot_equip:"Unbekannter Fehler beim Ausrsten von ",cannot_unequip:"Keine Gegenstnde mehr zum Ablegen von ",close_msg:"Schlieen",disc:"Dis",discipline:"Dis",donation_instructions:"Dies ist ein nicht-kommerzielles Projekt, das Destiny gewidmet ist. Wenn dir diese App gefllt, denke doch ber eine Spende nach um das Projekt am Leben zu halten.",donation_title:"Spenden an Tower Ghost fr Destiny!",error_loading_inventory:"Fehler beim Laden des Inventars ",gear_with_highest:"Ausrstung mit hchstem:",inte:"Int",intellect:"Int",invalid_transfer_amount:"Ungltige Menge eingegeben: ",inventory_armor:"Rstung",inventory_general:"Allgemein",inventory_postmaster:"Post",inventory_postmaster_lost_items:"Verlorene Gegenstnde",inventory_postmaster_messages:"Nachrichten",inventory_subclasses:"Fokusse",inventory_weapons:"Waffen",itemDefs_undefined:"Konnte Gegenstandsinformationen nicht laden, bitte melde dieses Problem bei meinem GitHub und stelle sicher, dass deine Schrift auf Englisch gestellt ist.",language_pack_downloaded:"Sprachpaket heruntergeladen, bitte aktualisiere um die nderungen anzuzeigen",language_text:"Dies wird die Sprache fr alle Gegnstnde und bei manchen Sprachen das Interface verndern, weitere Sprachen werden in der Zukunft hinzugefgt.",light:"Licht",loadouts_alreadythere_pt1:" ist bereits im ",loadouts_alreadythere_pt2:"'s Bucket von ",loadouts_delete:"Lschen",loadouts_desktop:"prfen",loadouts_instructions:"Keine Gegenstnde in der Ausrstung, klicke Gegenstnde um sie hinzuzufgen, ",loadouts_instructions_contd:" zum Ausrsten.",loadouts_invalidbucket:" wird nicht verschoben. Wegen diesem Bucket: ",loadouts_mobile:"halten",loadouts_no_replacement:" wird nicht verschoben. Es gibt keinen Gegenstand als Ersatz.",loadouts_no_transfer:" wird nicht verschoben",loadouts_outofspace:" wird nicht verschoben, es ist kein Platz in ",loadouts_save:"Speichern",loadouts_save_new:"Speichern Als",loadouts_swap:" wird ausgetauscht mit ",loadouts_to_equip:" wird ausgerstet.",loadouts_to_moveequip:" wird verschoben und ausgerstet.",loadouts_to_transfer:" wird verschoben",loadouts_transfer:"bertragen",loadouts_transfer_confirm:"bertragungsbesttigung",loadouts_transferred:'<strong>Gegenstnde erfolgreich bertragen</strong><br> Wenn dir diese App gefllt, vergiss nicht <a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">mir ein Bier zu kaufen</a>',login_authenticating_pt1:"Bei Bungie einloggen... Bitte habe ein wenig Geduld.",login_authenticating_pt2:"Wenn der Login Bildschirm fr lnger als 2 Minuten bleibt, nutze diese Links fr",login_authenticating_pt3:"um das Einloggen erneut zu versuchen. Wenn das Problem weiterhin besteht, installiere die App erneut.",login_help:"Bitte warte bis sich das Loginfenster von selbst schliet, whrend TGD deine Daten vorbereitet.",login_instructions:"Zu Beginn musst du dich bei deinem Bungie.net Account einloggen via:",login_loading_inventory:"Bitte warten, lade Arsenal von Bungie",login_loading_updates:"Bitte warten, lade automatische Updates",login_title:"Willkommen bei Tower Ghost fr Destiny!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"ber",menu_advancedtooltips:"Erweiterte Tooltips",menu_all:"Alle",menu_autorefresh:"Automatisch Aktualiseren (5 min)",menu_autotransfer:"Stacks Automatisch bertragen",menu_clear:"Filter Zurcksetzen",menu_damage:"Schaden",menu_destinydbmode:"DestinyDB Modus",menu_destinydbtooltips:"DestinyDB Tooltips",menu_destinystatus:"DestinyStatus Bericht",menu_destinytrials:"DestinyTrials Bericht",menu_destinytracker:"DestinyTracker Bericht",menu_destinyguardiangg:"Guardian.GG Bericht",menu_donate:"Spenden",menu_filter_by:"Filtern",menu_filter_by_subclass_eq:"Unterklasse ausgerstet",menu_filter_by_weapon_eq:"Waffen ausgerstet",menu_filter_for_class:"Filter nach Klasse",menu_help:"Hilfe",menu_language:"Sprache",menu_loadouts:"Ausrstungen",menu_loadouts_create:"Erstellen",menu_padheight:"Automatische Feldhhe",menu_progress:"Fortschritt",menu_progress_1:"Fehlende Perks",menu_progress_2:"Volle Perks",menu_progress_3:"Voll",menu_refresh:"Aktualisieren",menu_set:"Setzen",menu_set_showduplicates:"Doppelte anzeigen",menu_set_showmissing:"Fehlende anzeigen",menu_settings:"Einstellungen",menu_shareurl:"URL mit Freunden teilen",menu_sortby:"Sortieren",menu_sortby_damage:"Schadenstyp",menu_sortby_lightlvl:"Licht Level",menu_sortby_name:"Name",menu_sortby_type:"Typ",menu_sortby_tier_type:"Seltenheit, Typ",menu_sortby_tier_light:"Seltenheit, Licht",menu_sortby_tier_name:"Seltenheit, Name",menu_tier:"Seltenheit",menu_useps:"Playstation Account Verwenden",menu_usexbox:"Xbox Account Verwenden",menu_view:"Anzeige",menu_view_armor:"Rstung",menu_view_by:"Anzeigen nach",menu_view_by_lightlvl:"Licht Level",menu_view_by_stat_points:"Komb Stat Pkte",menu_view_general:"Allgemein",menu_view_options:"Optionen Anzeigen",menu_view_weapons:"Waffen",missing_items:"Fehlende Gegenstnde",most_points:"Meisten Punkte",movepopup_equip:"Ausrsten",movepopup_extras:"Extras",movepopup_move:"Verschieben",movepopup_store:"Lagern",movepopup_vault:"Tresor",normalize_title:"Normalisieren - Gegenstnde gleichmig ber deine Charaktere verteilen",paypal_code:"DE",pick_a_set:"Bitte whle ein Set bevor du diese Option auswhlst",recovery:"Erhlg",str:"St",strength:"St",text_shareurl:"Dein Inventar wird aktualisiert, indem du erneut auf URL teilen im Men klickst.",this_icon:"Das Icon ist",tier_common:"Gewhnlich",tier_exotic:"Exotisch",tier_legendary:"Legendr",tier_rare:"Selten",tier_uncommon:"Ungewhnlich",transfer:"bertrage",transfer_all:"Alle",transfer_amount:"Menge bertragen",transfer_ask:"Nicht erneut fragen",transfer_consolidate:"Zusammenlegen (von allen Charakteren",transfer_one:"Eins",unable_create_loadout_for_type:"Es ist aktuell nicht mglich Ausrstungen mit diesem Gegenstand zu erstellen.",unable_to_create_loadout_for_bucket:"Du kannst keine Ausrstung mit mehr als 10 Gegenstnden in diesem Platz erstellen: ",unable_to_move_bucketitems:"Gegenstnde in diesem Bucket knnen nicht mit dem API bertragen werden.",unable_unequip:"Ablegen unmglich von ",vo_container_width:"Container Breite",vo_layout_mode:"Layout Modus",vo_layout_mode_cust:"Angepasst",vo_layout_mode_def:"Standard",vo_number_of_columns:"Spalten",vo_vault_columns:"Tresor Spalten",vo_vault_first:"Erste/Links",vo_vault_last:"Letzte/Rechts",vo_vault_position:"Tresor Position",vo_vault_width:"Tresor Breite",whats_new_title:"Tower Ghost fr Destiny Updates"},es:{agility:"Agility",armor:"Armor",best_combo:"Best Combo",cancel:"Cancelar",cannot_equip:"Error desconocido tratando de equipar ",cannot_unequip:"No mas elementos para tratar de unequip la ",close_msg:"Cerrar",disc:"Disc",discipline:"Discipline",donation_instructions:"Este es un projecto non-commercial dedicado para Destiny. Si usted disfurat esta aplicacion proveve una donacion para supportar los gastos.",donation_title:"Donaciones para Tower Ghost for Destiny!",error_loading_inventory:"Error cargando inventario",gear_with_highest:"Equip Gear With Highest:",inte:"Int",intellect:"Intellect",invalid_transfer_amount:"Cantidad no valida entrada: ",inventory_armor:"Armadura",inventory_general:"General",inventory_postmaster:"Post Master",inventory_postmaster_lost_items:"Lost Items",inventory_postmaster_messages:"Messages",inventory_subclasses:"Subclases",inventory_weapons:"Armas",itemDefs_undefined:"Por favor informar el asunto a mi Github y asegurese de que su fuente se establece en Ingles.",language_pack_downloaded:"Language Pack downloaded, please refresh to see the changes",language_text:"Esto cambiara el lenguage de la aplicacion y de los articulos.",light:"Light",loadouts_alreadythere_pt1:" ya esta en el ",loadouts_alreadythere_pt2:"'s cubo de ",loadouts_delete:"Borrar",loadouts_desktop:"cheque",loadouts_instructions:"No hay articulos en loadout, haga clic en los articulos a anadir, ",loadouts_instructions_contd:" para equipar.",loadouts_invalidbucket:" no sera trasladado, Debido a este cubo: ",loadouts_mobile:"sostener",loadouts_no_replacement:" no sera trasladado. No hay otro para reemplazarlo.",loadouts_no_transfer:" no sera trasladado",loadouts_outofspace:" no sera trasladado, no hay espacio en ",loadouts_save:"Guardar",loadouts_save_new:"Guardar Como",loadouts_swap:" sera intercambiado con ",loadouts_to_equip:" sera equipado.",loadouts_to_moveequip:" sera trasladado y equipado.",loadouts_to_transfer:" sera trasladado",loadouts_transfer:"Transferir",loadouts_transfer_confirm:"Confirmar Transferencia",loadouts_transferred:'<strong>Articulo(s) transferido con exito</strong><br> Si te gusta esta aplicacion, puedes <a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">comprarme una cervezita.</a>',login_authenticating_pt1:"Logging into Bungie... Please be patient.",login_authenticating_pt2:"If log in screen remains for 2+ minutes, use these links for",login_authenticating_pt3:"to retry login. If the problem persists, reinstall the app.",login_help:"Por favor, espere a que la ventana se cerra. TGD han preparado su informacion.",login_instructions:"Para empezar tendras que acceder a su cuenta a traves de Bungie.net:",login_loading_inventory:"Por favor espere, cargando arsenal de Bungie",login_loading_updates:"Please wait, downloading auto updates",login_title:"Bienvenido a Tower Ghost para Destiny!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"Acerca De",menu_advancedtooltips:"Advanced Tooltips",menu_all:"Todo",menu_autorefresh:"Auto Refrescar (5 min)",menu_autotransfer:"Auto Mover Pilas",menu_clear:"Aclaro Filtro",menu_damage:"Dao",menu_destinydbmode:"DestinyDB Modo",menu_destinydbtooltips:"DestinyDB Tooltips",menu_destinystatus:"DestinyStatus Reporte",menu_destinytrials:"DestinyTrials Reporte",menu_destinytracker:"DestinyTracker Reporte",menu_destinyguardiangg:"Guardian.GG Reporte",menu_donate:"Donar",menu_filter_by:"Filter By",menu_filter_by_subclass_eq:"Subclass Equipped",menu_filter_by_weapon_eq:"Weapons Equipped",menu_filter_for_class:"Filter for Class",menu_help:"Ayuda",menu_language:"Language",menu_loadouts:"Loadouts",menu_loadouts_create:"Crear",menu_padheight:"Auto Adjusto Altura",menu_progress:"Progreso",menu_progress_1:"Falta Perks",menu_progress_2:"Completo Perks",menu_progress_3:"Al Maxmimo",menu_refresh:"Refrescar (seg.)",menu_set:"Conjunto",menu_set_showduplicates:"Monstrar articulos duplicados",menu_set_showmissing:"Monstrar articulos que faltan",menu_settings:"Ajustes",menu_shareurl:"Compartir Con Amigos",menu_sortby:"Sort By",menu_sortby_damage:"Damage Type",menu_sortby_lightlvl:"Light Level",menu_sortby_name:"Name",menu_sortby_type:"Type",menu_sortby_tier_type:"Tier, Type",menu_sortby_tier_light:"Tier, Light",menu_sortby_tier_name:"Tier, Name",menu_tier:"Nivel",menu_useps:"Usa Playstation Cuenta",menu_usexbox:"Usa Xbox Cuenta",menu_view:"Vista",menu_view_armor:"Armaduras",menu_view_by:"View By",menu_view_by_lightlvl:"Light Level",menu_view_by_stat_points:"Combined Stat Points",menu_view_general:"General",menu_view_options:"Opciones de Vista",menu_view_weapons:"Armas",missing_items:"Articulos que faltan",most_points:"Most Points",movepopup_equip:"equipar",movepopup_extras:"extras",movepopup_move:"Mover a",movepopup_store:"almacenar",movepopup_vault:"bodega",normalize_title:"Normalizar - igualmente distribuir tema a traves de sus personajes",paypal_code:"ES",pick_a_set:"Por favor elija un Set antes de seleccionar esta opcion",recovery:"Recovery",str:"Str",strength:"Strength",text_shareurl:"Tu iventoria es actualizado cuando hagas click a Compartir URL denuevo.",this_icon:"Este icono es ",tier_common:"Comn",tier_exotic:"Extico",tier_legendary:"Legendario",tier_rare:"Raro",tier_uncommon:"Poco comn",transfer:"Transfer",transfer_all:"Todos",transfer_amount:"Transferencia monto",transfer_ask:"Don't ask in the future",transfer_consolidate:"Consolidate (pull from all characters",transfer_one:"Uno",unable_create_loadout_for_type:"Actualmente no se puede crear loadouts con este tipo de elemento.",unable_to_create_loadout_for_bucket:"No se puede crear un loadout con mas de 10 articulos en esta ranura: ",
unable_to_move_bucketitems:"Post Master no pueden ser transferidos con el programa.",unable_unequip:"Incapaz de inequippar ",vo_container_width:"Container Width",vo_layout_mode:"Layout Mode",vo_layout_mode_cust:"Custom",vo_layout_mode_def:"Default",vo_number_of_columns:"# de Columnas",vo_vault_columns:"Vault Columns",vo_vault_first:"Primero/Izquierda",vo_vault_last:"Ultimo/Derecha",vo_vault_position:"Position de Bodega",vo_vault_width:"Vault Width",whats_new_title:"Tower Ghost for Destiny Noticias"},fr:{agility:"Agility",armor:"Armor",best_combo:"Best Combo",cancel:"Cancel",cannot_equip:"Erreur inconnue essayant d'quiper ",cannot_unequip:"Peu plus d'lments pour tenter de dsquiper le ",close_msg:"Fermer",disc:"Disc",discipline:"Discipline",donation_instructions:"Ceci est un projet non commercial ddi au Destiny. Si vous aimez ce soft fournir un don de garder ce projet en vie et soutenir les cots de maintenance.",donation_title:"Dons pour Tower Ghost for Destiny!",error_loading_inventory:"Erreur inventaire de chargement",gear_with_highest:"Equip Gear With Highest:",inte:"Int",intellect:"Intellect",invalid_transfer_amount:"Le montant indiqu est incorrect: ",inventory_armor:"Armure",inventory_general:"General",inventory_postmaster:"Commis des postes",inventory_postmaster_lost_items:"Objets Perdus",inventory_postmaster_messages:"Messages",inventory_subclasses:"Sous Classes",inventory_weapons:"Armes",itemDefs_undefined:"S'il vous plat signaler le problme  mon Github et assurez-vous que votre police est l'anglais.",language_pack_downloaded:"Language Pack tlcharg, s'il vous plat rafrachir pour voir les changements",language_text:"Cela va changer la langue pour tous les articles et l'interface pour certaines langues, d'autres langues seront ajoutes dans le futur.",light:"Light",loadouts_alreadythere_pt1:" is already in the ",loadouts_alreadythere_pt2:"'s bucket of ",loadouts_delete:"Rayer",loadouts_desktop:"check",loadouts_instructions:"No items in loadout, click items to add, ",loadouts_instructions_contd:" to equip.",loadouts_invalidbucket:" will not be moved. Because of this bucket: ",loadouts_mobile:"hold",loadouts_no_replacement:" will not be moved. There is no item to replace it.",loadouts_no_transfer:" will not be moved",loadouts_outofspace:" will not be moved, there is no space in ",loadouts_save:"Sauver",loadouts_save_new:"Sauver As",loadouts_swap:" will be swapped with ",loadouts_to_equip:" will be equipped.",loadouts_to_moveequip:" will be moved and equipped.",loadouts_to_transfer:" will be moved",loadouts_transfer:"Transfert",loadouts_transfer_confirm:"Transfer Confirm",loadouts_transferred:'<strong>Articles transfr avec succs</strong><br> Si vous aimez ce soft pensez  <a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">achetez-moi une bire</a>',login_authenticating_pt1:"Logging into Bungie... Please be patient.",login_authenticating_pt2:"If log in screen remains for 2+ minutes, use these links for",login_authenticating_pt3:"to retry login. If the problem persists, reinstall the app.",login_help:"S'il vous plat attendre la fentre de connexion  proximit de l'automobile comme TGD prpare vos informations.",login_instructions:"Pour commencer, vous aurez besoin pour vous connecter  votre compte Bungie.net via:",login_loading_inventory:"Please wait, loading arsenal from Bungie",login_loading_updates:"Please wait, downloading auto updates",login_title:"Bienvenue  Tower Ghost for Destiny!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"Propos",menu_advancedtooltips:"Advanced Tooltips",menu_view_by:"View By",menu_view_by_lightlvl:"Light Level",menu_view_by_stat_points:"Combined Stat Points",menu_all:"Tout",menu_autorefresh:"Auto Actualiser (5 min)",menu_autotransfer:"Auto transfert s'entasser",menu_clear:"Filtres effacer",menu_damage:"Dommages",menu_destinydbmode:"DestinyDB Mode",menu_destinydbtooltips:"DestinyDB infobulles",menu_destinystatus:"DestinyStatus Report",menu_destinytrials:"DestinyTrials Report",menu_destinytracker:"DestinyTracker Report",menu_destinyguardiangg:"Guardian.GG Report",menu_donate:"Don",menu_filter_by:"Filter By",menu_filter_by_subclass_eq:"Subclass Equipped",menu_filter_by_weapon_eq:"Weapons Equipped",menu_filter_for_class:"Filter for Class",menu_help:"Aide",menu_language:"Language",menu_loadouts:"Loadouts",menu_loadouts_create:"Crer",menu_padheight:"Auto Pad Hauteur",menu_progress:"Progrs",menu_progress_1:"Missing Perks",menu_progress_2:"Missing Border",menu_progress_3:"Maxed",menu_refresh:"Actualisez (segundos)",menu_set:"Ensemble",menu_set_showduplicates:"Afficher les doublons d'objets",menu_set_showmissing:"Afficher les lments manquants",menu_settings:"Paramtres",menu_shareurl:"Partager URL",menu_sortby:"Sort By",menu_sortby_damage:"Damage Type",menu_sortby_lightlvl:"Light Level",menu_sortby_name:"Name",menu_sortby_type:"Type",menu_sortby_tier_type:"Tier, Type",menu_sortby_tier_light:"Tier, Light",menu_sortby_tier_name:"Tier, Name",menu_tier:"chelon",menu_useps:"Utiliser Playstation un compte",menu_usexbox:"Utiliser Xbox un compte",menu_view:"Voir",menu_view_armor:"Armure",menu_view_general:"General",menu_view_options:"Options d'affichage",menu_view_weapons:"Armes",missing_items:"Articles manquant",most_points:"Most Points",movepopup_equip:"quiper",movepopup_extras:"extras",movepopup_move:"Bouger",movepopup_store:"dpt",movepopup_vault:"vote",normalize_title:"Normalizar - igualmente distribuir tema a travs de sus personajes",paypal_code:"FR",pick_a_set:"S'il vous plat choisir un ensemble avant de choisir cette option",recovery:"Recovery",str:"Str",strength:"Strength",text_shareurl:"Votre inventaire est mis  jour en cliquant sur Partager URL dans le menu  nouveau.",this_icon:"Cette icne est ",tier_common:"Common",tier_exotic:"Exotic",tier_legendary:"Legendary",tier_rare:"Rare",tier_uncommon:"Uncommon",transfer:"Transfer",transfer_all:"Tous",transfer_amount:"Transferencia monto",transfer_ask:"Don't ask in the future",transfer_consolidate:"Consolidate (pull from all characters",transfer_one:"Un",unable_create_loadout_for_type:"Actuellement incapable de crer loadouts avec ce type d'article",unable_to_create_loadout_for_bucket:"Vous ne pouvez pas crer un loadout avec plus de 10 articles dans cette fente: ",unable_to_move_bucketitems:"Articles matre de poste ne peuvent tre transfrs avec l'API.",unable_unequip:"Impossible de dsquiper ",vo_container_width:"Container Width",vo_layout_mode:"Layout Mode",vo_layout_mode_cust:"Custom",vo_layout_mode_def:"Default",vo_number_of_columns:"Number of Columns",vo_vault_columns:"Vault Columns",vo_vault_first:"First/Left",vo_vault_last:"Last/Right",vo_vault_position:"Vault Position",vo_vault_width:"Vault Width",whats_new_title:"Tower Ghost for Destiny Nouvelles"},it:{agility:"Agility",armor:"Armor",best_combo:"Best Combo",cancel:"Cancel",cannot_equip:"Unknown error trying to equip ",cannot_unequip:"No more items to try to unequip the ",close_msg:"Close",disc:"Disc",discipline:"Discipline",donation_instructions:"This is a non-commercial project dedicated to Destiny. If you like this app provide a donation to keep this project alive and support the maintenance costs.",donation_title:"Donations for Tower Ghost for Destiny!",error_loading_inventory:"Error loading inventory ",gear_with_highest:"Equip Gear With Highest:",inte:"Int",intellect:"Intellect",invalid_transfer_amount:"Invalid amount entered: ",inventory_armor:"Armor",inventory_general:"General",inventory_postmaster:"Post Master",inventory_postmaster_messages:"Messages",inventory_postmaster_lost_items:"Lost Items",inventory_subclasses:"Sub Classes",inventory_weapons:"Weapons",itemDefs_undefined:"Could not load item definitions, please report the issue to my Github including the version number being used.",language_pack_downloaded:"Language Pack downloaded, please refresh to see the changes",language_text:"This will change the language for all items and the interface for some languages, more languages will be added in the future.",light:"Light",loadouts_alreadythere_pt1:" is already in the ",loadouts_alreadythere_pt2:"'s bucket of ",loadouts_delete:"Delete",loadouts_desktop:"check",loadouts_instructions:"No items in loadout, click items to add, ",loadouts_instructions_contd:" to equip.",loadouts_invalidbucket:" will not be moved. Because of this bucket: ",loadouts_mobile:"hold",loadouts_no_replacement:" will not be moved. There is no item to replace it.",loadouts_no_transfer:" will not be moved",loadouts_outofspace:" will not be moved, there is no space in ",loadouts_save:"Save",loadouts_save_new:"Save As",loadouts_swap:" will be swapped with ",loadouts_to_equip:" will be equipped.",loadouts_to_moveequip:" will be moved and equipped.",loadouts_to_transfer:" will be moved",loadouts_transfer:"Transfer",loadouts_transfer_confirm:"Transfer Confirm",loadouts_transferred:'<strong>Item(s) Transferred!</strong><br>If you like this app remember to <a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">buy me a beer</a>.',login_authenticating_pt1:"Logging into Bungie... Please be patient.",login_authenticating_pt2:"If log in screen remains for 2+ minutes, use these links for",login_authenticating_pt3:"to retry login. If the problem persists, reinstall the app.",login_help:"Please wait for the login window to auto close as TGD prepares your information.",login_instructions:"To get started you'll need to log in to your Bungie.net account via:",login_loading_inventory:"Please wait, loading arsenal from Bungie",login_loading_updates:"Please wait, downloading auto updates",login_title:"Welcome to Tower Ghost for Destiny!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"About",menu_advancedtooltips:"Advanced Tooltips",menu_all:"All",menu_autorefresh:"Auto Refresh (5 min)",menu_autotransfer:"Auto Transfer Stacks",menu_clear:"Clear Filters",menu_destinydbtooltips:"DestinyDB Tooltips",menu_destinydbmode:"DestinyDB Mode",menu_destinystatus:"DestinyStatus Report",menu_destinytrials:"DestinyTrials Report",menu_destinytracker:"DestinyTracker Report",menu_destinyguardiangg:"Guardian.GG Report",menu_damage:"Damage",menu_donate:"Donate",menu_filter_by:"Filter By",menu_filter_by_subclass_eq:"Subclass Equipped",menu_filter_by_weapon_eq:"Weapons Equipped",menu_filter_for_class:"Filter for Class",menu_help:"Help",menu_language:"Language",menu_loadouts:"Loadouts",menu_loadouts_create:"Create",menu_padheight:"Auto Pad Height",menu_progress:"Progress",menu_progress_1:"Missing Perks",menu_progress_2:"Missing Border",menu_progress_3:"Maxed",menu_refresh:"Refresh (secs)",menu_set:"Set",menu_set_showmissing:"Show Missing Items",menu_set_showduplicates:"Show Duplicate Items",menu_settings:"Settings",menu_shareurl:"Share URL with friends",menu_sortby:"Sort By",menu_sortby_damage:"Damage Type",menu_sortby_lightlvl:"Light Level",menu_sortby_name:"Name",menu_sortby_type:"Type",menu_sortby_tier_type:"Tier, Type",menu_sortby_tier_light:"Tier, Light",menu_sortby_tier_name:"Tier, Name",menu_tier:"Tier",menu_usexbox:"Use Xbox Account",menu_useps:"Use Playstation Account",menu_view:"View",menu_view_armor:"Armor",menu_view_by:"View By",menu_view_by_lightlvl:"Light Level",menu_view_by_stat_points:"Combined Stat Points",menu_view_general:"General",menu_view_options:"View Options",menu_view_weapons:"Weapons",missing_items:"Missing Items",most_points:"Most Points",movepopup_move:"Move",movepopup_store:"store",movepopup_equip:"equip",movepopup_vault:"vault",movepopup_extras:"extras",normalize_title:"Normalize - equally distribute item across your characters",paypal_code:"EN",pick_a_set:"Please pick a Set before selecting this option",recovery:"Recovery",str:"Str",strength:"Strength",text_shareurl:"Your inventory is updated by clicking on Share URL from the menu again.",this_icon:"This icon is ",tier_common:"Common",tier_exotic:"Exotic",tier_legendary:"Legendary",tier_rare:"Rare",tier_uncommon:"Uncommon",transfer:"Transfer",transfer_all:"All",transfer_amount:"Transfer Amount",transfer_ask:"Don't ask in the future",transfer_consolidate:"Consolidate (pull from all characters",transfer_one:"One",unable_create_loadout_for_type:"Currently unable to create loadouts with this item type.",unable_unequip:"Unable to unequip ",unable_to_create_loadout_for_bucket:"You cannot create a loadout with more than 10 items in this slot: ",unable_to_move_bucketitems:"This item cannot be transferred with the API.",vo_container_width:"Container Width",vo_layout_mode:"Vault Mode",vo_layout_mode_cust:"Custom",vo_layout_mode_def:"Default",vo_number_of_columns:"Number of Columns",vo_vault_columns:"Vault Columns",vo_vault_first:"First/Left",vo_vault_last:"Last/Right",vo_vault_position:"Vault Position",vo_vault_width:"Vault Width",whats_new_title:"Tower Ghost for Destiny Updates"},ja:{agility:"Agility",armor:"Armor",best_combo:"Best Combo",cancel:"Cancel",cannot_equip:"Unknown error trying to equip ",cannot_unequip:"No more items to try to unequip the ",close_msg:"Close",disc:"Disc",discipline:"Discipline",donation_instructions:"This is a non-commercial project dedicated to Destiny. If you like this app provide a donation to keep this project alive and support the maintenance costs.",donation_title:"Donations for Tower Ghost for Destiny!",error_loading_inventory:"Error loading inventory ",gear_with_highest:"Equip Gear With Highest:",inte:"Int",intellect:"Intellect",invalid_transfer_amount:"Invalid amount entered: ",inventory_armor:"Armor",inventory_general:"General",inventory_postmaster:"Post Master",inventory_postmaster_messages:"Messages",inventory_postmaster_lost_items:"Lost Items",inventory_subclasses:"Sub Classes",inventory_weapons:"Weapons",itemDefs_undefined:"Could not load item definitions, please report the issue to my Github including the version number being used.",language_pack_downloaded:"Language Pack downloaded, please refresh to see the changes",language_text:"This will change the language for all items and the interface for some languages, more languages will be added in the future.",light:"Light",loadouts_alreadythere_pt1:" is already in the ",loadouts_alreadythere_pt2:"'s bucket of ",loadouts_delete:"Delete",loadouts_desktop:"check",loadouts_instructions:"No items in loadout, click items to add, ",loadouts_instructions_contd:" to equip.",loadouts_invalidbucket:" will not be moved. Because of this bucket: ",loadouts_mobile:"hold",loadouts_no_replacement:" will not be moved. There is no item to replace it.",loadouts_no_transfer:" will not be moved",loadouts_outofspace:" will not be moved, there is no space in ",loadouts_save:"Save",loadouts_save_new:"Save As",loadouts_swap:" will be swapped with ",loadouts_to_equip:" will be equipped.",loadouts_to_moveequip:" will be moved and equipped.",loadouts_to_transfer:" will be moved",loadouts_transfer:"Transfer",loadouts_transfer_confirm:"Transfer Confirm",loadouts_transferred:'<strong>Item(s) Transferred!</strong><br>If you like this app remember to <a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">buy me a beer</a>.',login_authenticating_pt1:"Logging into Bungie... Please be patient.",login_authenticating_pt2:"If log in screen remains for 2+ minutes, use these links for",login_authenticating_pt3:"to retry login. If the problem persists, reinstall the app.",login_help:"Please wait for the login window to auto close as TGD prepares your information.",login_instructions:"To get started you'll need to log in to your Bungie.net account via:",login_loading_inventory:"Please wait, loading arsenal from Bungie",login_loading_updates:"Please wait, downloading auto updates",login_title:"Welcome to Tower Ghost for Destiny!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"About",menu_advancedtooltips:"Advanced Tooltips",menu_all:"All",menu_autorefresh:"Auto Refresh (5 min)",menu_autotransfer:"Auto Transfer Stacks",menu_clear:"Clear Filters",menu_destinydbtooltips:"DestinyDB Tooltips",menu_destinydbmode:"DestinyDB Mode",menu_destinystatus:"DestinyStatus Report",menu_destinytrials:"DestinyTrials Report",menu_destinytracker:"DestinyTracker Report",menu_destinyguardiangg:"Guardian.GG Report",menu_damage:"Damage",menu_donate:"Donate",menu_filter_by:"Filter By",menu_filter_by_subclass_eq:"Subclass Equipped",menu_filter_by_weapon_eq:"Weapons Equipped",menu_filter_for_class:"Filter for Class",menu_help:"Help",menu_language:"Language",menu_loadouts:"Loadouts",menu_loadouts_create:"Create",menu_padheight:"Auto Pad Height",menu_progress:"Progress",menu_progress_1:"Missing Perks",menu_progress_2:"Missing Border",menu_progress_3:"Maxed",menu_refresh:"Refresh (secs)",menu_set:"Set",menu_set_showmissing:"Show Missing Items",menu_set_showduplicates:"Show Duplicate Items",menu_settings:"Settings",menu_shareurl:"Share URL with friends",menu_sortby:"Sort By",menu_sortby_damage:"Damage Type",menu_sortby_lightlvl:"Light Level",menu_sortby_name:"Name",menu_sortby_type:"Type",menu_sortby_tier_type:"Tier, Type",menu_sortby_tier_light:"Tier, Light",menu_sortby_tier_name:"Tier, Name",menu_tier:"Tier",menu_usexbox:"Use Xbox Account",menu_useps:"Use Playstation Account",menu_view:"View",menu_view_armor:"Armor",menu_view_by:"View By",menu_view_by_lightlvl:"Light Level",menu_view_by_stat_points:"Combined Stat Points",menu_view_general:"General",menu_view_options:"View Options",menu_view_weapons:"Weapons",missing_items:"Missing Items",most_points:"Most Points",movepopup_move:"Move",movepopup_store:"store",movepopup_equip:"equip",movepopup_vault:"vault",movepopup_extras:"extras",normalize_title:"Normalize - equally distribute item across your characters",paypal_code:"EN",pick_a_set:"Please pick a Set before selecting this option",recovery:"Recovery",str:"Str",strength:"Strength",text_shareurl:"Your inventory is updated by clicking on Share URL from the menu again.",this_icon:"This icon is ",tier_common:"Common",tier_exotic:"Exotic",tier_legendary:"Legendary",tier_rare:"Rare",tier_uncommon:"Uncommon",transfer:"Transfer",transfer_all:"All",transfer_amount:"Transfer Amount",transfer_ask:"Don't ask in the future",transfer_consolidate:"Consolidate (pull from all characters",transfer_one:"One",unable_create_loadout_for_type:"Currently unable to create loadouts with this item type.",unable_unequip:"Unable to unequip ",unable_to_create_loadout_for_bucket:"You cannot create a loadout with more than 10 items in this slot: ",unable_to_move_bucketitems:"This item cannot be transferred with the API.",vo_container_width:"Container Width",vo_layout_mode:"Vault Mode",vo_layout_mode_cust:"Custom",vo_layout_mode_def:"Default",vo_number_of_columns:"Number of Columns",vo_vault_columns:"Vault Columns",vo_vault_first:"First/Left",vo_vault_last:"Last/Right",vo_vault_position:"Vault Position",vo_vault_width:"Vault Width",whats_new_title:"Tower Ghost for Destiny Updates"},pt:{agility:"Agility",armor:"Armor",best_combo:"Best Combo",cancel:"Cancel",cannot_equip:"Unknown error trying to equip ",cannot_unequip:"No more items to try to unequip the ",close_msg:"Close",disc:"Disc",discipline:"Discipline",donation_instructions:"This is a non-commercial project dedicated to Destiny. If you like this app provide a donation to keep this project alive and support the maintenance costs.",donation_title:"Donations for Tower Ghost for Destiny!",error_loading_inventory:"Error loading inventory ",gear_with_highest:"Equip Gear With Highest:",inte:"Int",intellect:"Intellect",invalid_transfer_amount:"Invalid amount entered: ",inventory_armor:"Armor",inventory_general:"General",inventory_postmaster:"Post Master",inventory_postmaster_messages:"Messages",inventory_postmaster_lost_items:"Lost Items",inventory_subclasses:"Sub Classes",inventory_weapons:"Weapons",itemDefs_undefined:"Could not load item definitions, please report the issue to my Github including the version number being used.",language_pack_downloaded:"Language Pack downloaded, please refresh to see the changes",language_text:"This will change the language for all items and the interface for some languages, more languages will be added in the future.",light:"Light",loadouts_alreadythere_pt1:" is already in the ",loadouts_alreadythere_pt2:"'s bucket of ",loadouts_delete:"Delete",loadouts_desktop:"check",loadouts_instructions:"No items in loadout, click items to add, ",loadouts_instructions_contd:" to equip.",loadouts_invalidbucket:" will not be moved. Because of this bucket: ",loadouts_mobile:"hold",loadouts_no_replacement:" will not be moved. There is no item to replace it.",loadouts_no_transfer:" will not be moved",loadouts_outofspace:" will not be moved, there is no space in ",loadouts_save:"Save",loadouts_save_new:"Save As",loadouts_swap:" will be swapped with ",loadouts_to_equip:" will be equipped.",loadouts_to_moveequip:" will be moved and equipped.",loadouts_to_transfer:" will be moved",loadouts_transfer:"Transfer",loadouts_transfer_confirm:"Transfer Confirm",loadouts_transferred:'<strong>Item(s) Transferred!</strong><br>If you like this app remember to <a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">buy me a beer</a>.',login_authenticating_pt1:"Logging into Bungie... Please be patient.",login_authenticating_pt2:"If log in screen remains for 2+ minutes, use these links for",login_authenticating_pt3:"to retry login. If the problem persists, reinstall the app.",login_help:"Please wait for the login window to auto close as TGD prepares your information.",login_instructions:"To get started you'll need to log in to your Bungie.net account via:",login_loading_inventory:"Please wait, loading arsenal from Bungie",login_loading_updates:"Please wait, downloading auto updates",login_title:"Welcome to Tower Ghost for Destiny!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"About",menu_advancedtooltips:"Advanced Tooltips",menu_all:"All",menu_autorefresh:"Auto Refresh (5 min)",menu_autotransfer:"Auto Transfer Stacks",menu_clear:"Clear Filters",menu_destinydbtooltips:"DestinyDB Tooltips",menu_destinydbmode:"DestinyDB Mode",menu_destinystatus:"DestinyStatus Report",menu_destinytrials:"DestinyTrials Report",menu_destinytracker:"DestinyTracker Report",menu_destinyguardiangg:"Guardian.GG Report",menu_damage:"Damage",menu_donate:"Donate",menu_filter_by:"Filter By",menu_filter_by_subclass_eq:"Subclass Equipped",menu_filter_by_weapon_eq:"Weapons Equipped",menu_filter_for_class:"Filter for Class",menu_help:"Help",menu_language:"Language",menu_loadouts:"Loadouts",menu_loadouts_create:"Create",menu_padheight:"Auto Pad Height",menu_progress:"Progress",menu_progress_1:"Missing Perks",menu_progress_2:"Missing Border",menu_progress_3:"Maxed",menu_refresh:"Refresh (secs)",menu_set:"Set",menu_set_showmissing:"Show Missing Items",menu_set_showduplicates:"Show Duplicate Items",menu_settings:"Settings",menu_shareurl:"Share URL with friends",menu_sortby:"Sort By",menu_sortby_damage:"Damage Type",menu_sortby_lightlvl:"Light Level",menu_sortby_name:"Name",menu_sortby_type:"Type",menu_sortby_tier_type:"Tier, Type",menu_sortby_tier_light:"Tier, Light",menu_sortby_tier_name:"Tier, Name",menu_tier:"Tier",menu_usexbox:"Use Xbox Account",menu_useps:"Use Playstation Account",menu_view:"View",menu_view_armor:"Armor",menu_view_by:"View By",menu_view_by_lightlvl:"Light Level",menu_view_by_stat_points:"Combined Stat Points",menu_view_general:"General",menu_view_options:"View Options",menu_view_weapons:"Weapons",missing_items:"Missing Items",most_points:"Most Points",movepopup_move:"Move",movepopup_store:"store",movepopup_equip:"equip",movepopup_vault:"vault",movepopup_extras:"extras",normalize_title:"Normalize - equally distribute item across your characters",paypal_code:"EN",pick_a_set:"Please pick a Set before selecting this option",recovery:"Recovery",str:"Str",strength:"Strength",text_shareurl:"Your inventory is updated by clicking on Share URL from the menu again.",this_icon:"This icon is ",tier_common:"Common",tier_exotic:"Exotic",tier_legendary:"Legendary",tier_rare:"Rare",tier_uncommon:"Uncommon",transfer:"Transfer",transfer_all:"All",transfer_amount:"Transfer Amount",transfer_ask:"Don't ask in the future",transfer_consolidate:"Consolidate (pull from all characters",transfer_one:"One",unable_create_loadout_for_type:"Currently unable to create loadouts with this item type.",unable_unequip:"Unable to unequip ",unable_to_create_loadout_for_bucket:"You cannot create a loadout with more than 10 items in this slot: ",unable_to_move_bucketitems:"This item cannot be transferred with the API.",vo_container_width:"Container Width",vo_layout_mode:"Vault Mode",vo_layout_mode_cust:"Custom",vo_layout_mode_def:"Default",vo_number_of_columns:"Number of Columns",vo_vault_columns:"Vault Columns",vo_vault_first:"First/Left",vo_vault_last:"Last/Right",vo_vault_position:"Vault Position",vo_vault_width:"Vault Width",whats_new_title:"Tower Ghost for Destiny Updates"},tr:{agility:"Agility",armor:"Armor",best_combo:"Best Combo",cancel:"Vazge",cannot_equip:"eyi donanrken hata olutu ",cannot_unequip:"zerinizdekini brakmak iin e yok ",close_msg:"Kapat",disc:"Disc",discipline:"Discipline",donation_instructions:"Bu program tamamen cretsiz ve Destiny ye balanm bir programdr.Herhangi bir cret talep etmemektedir yani kelepirdir. Programmz gelitirmek ve daha iyi bir deneyim salamamz istiyorsanz,ltfen balarnz ve desteinizi esirgemeyiniz.Teekkrler.",donation_title:"Destiny ye balar!",error_loading_inventory:"Cephaneniz yklenirken hata olutu ",gear_with_highest:"Equip Gear With Highest:",inte:"Int",intellect:"Intellect",invalid_transfer_amount:"Geersiz miktar girildi: ",inventory_armor:"Armorlar",inventory_general:"Grevler",inventory_postmaster:"Post Master",inventory_postmaster_lost_items:"Kayp eler",inventory_postmaster_messages:"Mesajlar",inventory_subclasses:"Sub Klaslar",inventory_weapons:"Silahlar",itemDefs_undefined:"e tanmlanamad, ltfen bu hatay bana ingilizce olarak GitHub sayfamdan belirtin.",language_pack_downloaded:"Dil paketi indirildi,ltfen yenileyin ve deiikliklere gz atn.",language_text:"Bu seenek,programn btn ieriinin dilini deitirecektir.Ileride programda daha fazla dil destei olacaktr.",light:"Light",loadouts_alreadythere_pt1:"zaten bunun ierisinde ",loadouts_alreadythere_pt2:"'s bucket of ",loadouts_delete:"Sil",loadouts_desktop:"kontrol",loadouts_instructions:"Tehizatnda donanmak iin e yok.Donanmak iin tkla, ",loadouts_instructions_contd:" ekle.",loadouts_invalidbucket:" aktarlmayacak. nk setiin bu eler yznden: ",loadouts_mobile:"tut",loadouts_no_replacement:" aktarlmayacak. Bu enin yerine koyabileceimiz baka bir e yok.",loadouts_no_transfer:" aktarlmayacak",loadouts_outofspace:" aktarlmayacak, nk yandaki yerde yeterli alann yok ",loadouts_save:"Kaydet",loadouts_save_new:"Kaydet As",loadouts_swap:" ile takas yaplacak ",loadouts_to_equip:" donanlacak.",loadouts_to_moveequip:" aktarlacak ve donanlacak.",loadouts_to_transfer:" aktarlacak",loadouts_transfer:"Transfer",loadouts_transfer_confirm:"Aktarmay Onayla",loadouts_transferred:'<strong>e(ler) baar ile aktarld!</strong><br> Eer bu kolaylk hounuza gittiyse,<a style="color:#3080CF; cursor:pointer;" class="donateLink" target="_system">bana bi ay smarlayn</a>',login_authenticating_pt1:"Bungie'ye giri yaplyor.. Ltfen sabrl olun :).",login_authenticating_pt2:"Eer ykleme ekran 2 dakikadan uzun srdyse, Yenilemek iin bu linkleri kullann",login_authenticating_pt3:"ve yeniden giri yapmay deneyin. Eer sorun devam ederse,program silip tekrar ykleyin.",login_help:"Ykleme ekrannn otomatik kapanmasn bekleyiniz.Yklendikten sonra program sizi cephanenize ynlendirecektir.",login_instructions:"Program kullanabilmek iin Bungie.Net hesabna giri yapman gerekiyor:",login_loading_inventory:"Ltfen Bekleyin, Cephaneniz Bungie tarafndan ykleniyor",login_loading_updates:"Please wait, downloading auto updates",login_title:"Tower Ghost for Destiny ye Hogeldiniz!",menu_viewformat:"View Format",menu_viewimagegrid:"Image Grid",menu_viewitemlist:"Items List",menu_about:"Hakknda",menu_advancedtooltips:"Advanced Tooltips",menu_all:"Hepsi",menu_autorefresh:"Otomatik yenileme (5 mins)",menu_autotransfer:"Otomatik Transfer",menu_clear:"Arama Filtrelerini Temizle",menu_damage:"Hasar Tr",menu_destinydbmode:"DestinyDB Modu",menu_destinydbtooltips:"DestinyDB Aralar",menu_destinystatus:"DestinyStatus Raporu",menu_destinytrials:"DestinyTrials Raporu",menu_destinytracker:"DestinyTracker Raporu",menu_destinyguardiangg:"Guardian.GG Raporu",menu_donate:"Ba",menu_filter_by:"Filter By",menu_filter_by_subclass_eq:"Subclass Equipped",menu_filter_by_weapon_eq:"Weapons Equipped",menu_filter_for_class:"Filter for Class",menu_help:"Yardm",menu_language:"Dil",menu_loadouts:"Tehizatlar",menu_loadouts_create:"Olutur",menu_padheight:"Otomatik Ped Ykseklii",menu_progress:"Ilerleme",menu_progress_1:"Ilerlemesi eksik olan eler",menu_progress_2:"Ilerlemesi Tam olan eler",menu_progress_3:"Maksimum olan eler",menu_refresh:"Yenile",menu_set:"Set",menu_set_showduplicates:"Birden Fazla Olan eleri Gster",menu_set_showmissing:"Eksik eleri Gster",menu_settings:"Ayarlar",menu_shareurl:"URL'yi Arkadalarnla payla",menu_sortby:"Sort By",menu_sortby_damage:"Damage Type",menu_sortby_lightlvl:"Light Level",menu_sortby_name:"Name",menu_sortby_type:"Type",menu_sortby_tier_type:"Tier, Type",menu_sortby_tier_light:"Tier, Light",menu_sortby_tier_name:"Tier, Name",menu_tier:"e Tr",menu_useps:"PlayStation Hesabn Kullan",menu_usexbox:"Xbox Hesabn Kullan",menu_view:"Grntle",menu_view_armor:"Armorlar",menu_view_by:"View By",menu_view_by_lightlvl:"Light Level",menu_view_by_stat_points:"Combined Stat Points",menu_view_general:"Grevler",menu_view_options:"Grntleme Ayarlar",menu_view_weapons:"Silahlar",missing_items:"Kayp eler",most_points:"Most Points",movepopup_equip:"donan",movepopup_extras:"ekstralar",movepopup_move:"ta",movepopup_store:"al",movepopup_vault:"vault",normalize_title:"Normalize - bir eyi btn karakterler arasnda eit olarak bltrr",paypal_code:"TR",pick_a_set:"Ltfen bir set sein",recovery:"Recovery",str:"Str",strength:"Strength",text_shareurl:"Inventoriniz SHARE URL seenei ile tekrar yenilenebilir.",this_icon:"Bu ikon ",tier_common:"Yaygn",tier_exotic:"Exotic",tier_legendary:"Legendary",tier_rare:"Rare",tier_uncommon:"Nadir",transfer:"Transfer",transfer_all:"Hepsi",transfer_amount:"Aktarlacak Miktar",transfer_ask:"Don't ask in the future",transfer_consolidate:"Consolidate (pull from all characters",transfer_one:"Bir Adet",unable_create_loadout_for_type:"Bu e tipi ile tehizat oluturmak mmkn deil.",unable_to_create_loadout_for_bucket:"Bu slot ierisinde 10'dan fazla e ile tehizat oluturamazsn: ",unable_to_move_bucketitems:"Setiin eler bu uygulama ile aktarlamaz.",unable_unequip:"zerinizden kartlamyor ",vo_container_width:"Container Width",vo_layout_mode:"Layout Mode",vo_layout_mode_cust:"Custom",vo_layout_mode_def:"Default",vo_number_of_columns:"Columns",vo_vault_columns:"Vault Columns",vo_vault_first:"Ilk/Sol",vo_vault_last:"Son/Sa",vo_vault_position:"Vault pozisyonu",vo_vault_width:"Vault Width",whats_new_title:"Tower Ghost for Destiny Gncellemeleri"}},tgd.getStoredValue=function(key){var saved="";return window.localStorage&&window.localStorage.getItem&&(saved=window.localStorage.getItem(key)),_.isEmpty(saved)?tgd.defaults[key]:saved},tgd.StoreObj=function(key,compare,writeCallback){var value=ko.observable(compare?tgd.getStoredValue(key)==compare:tgd.getStoredValue(key));this.read=function(){return value()},this.write=function(newValue){window.localStorage.setItem(key,newValue),value(newValue),writeCallback&&writeCallback(newValue);
}},function(){tgd.localLog("init auto updates");try{var fs,script,serverRoot,isCordova="undefined"!=typeof cordova;if(script=document.querySelector("script[server]"),script&&(serverRoot=script.getAttribute("server")),!serverRoot)throw new Error('Add a "server" attribute to the bootstrap.js script!');fs=new CordovaPromiseFS({persistent:isCordova||isFirefox,Promise:Promise}),tgd.loader=new CordovaAppLoader({fs:fs,localRoot:"app",serverRoot:serverRoot,mode:"mirror",cacheBuster:!0,checkTimeout:3e4}),tgd.checkUpdates=function(){$.toaster({priority:"info",title:"Info",message:"Checking for updates",settings:{timeout:tgd.defaults.toastTimeout}}),tgd.loader.check(serverRoot+"bootstrap.json?locale="+(localStorage.appLocale||localStorage.locale||"en")).then(function(updateAvailable){return updateAvailable&&($.toaster({priority:"info",title:"Info",message:"Downloading updates",settings:{timeout:tgd.defaults.toastTimeout}}),tgd.localLog("Downloading auto updates"),$("#tgdLoader").show()),tgd.loader.download(function(progress){$("#tgdLoaderProgress").width((100*progress.percentage).toFixed(0)+"%")})})["catch"](function(e){$("#tgdLoader").hide(),$.toaster({priority:"danger",title:"Error",message:"Problem checking for updates: "+e.message,settings:{timeout:tgd.defaults.toastTimeout}})}).then(function(manifest){return $("#tgdLoader").hide(),manifest&&$.toaster({priority:"info",title:"Info",message:"Installing updates",settings:{timeout:tgd.defaults.toastTimeout}}),tgd.loader.update()},function(err){$("#tgdLoader").hide(),$.toaster({priority:"danger",title:"Error",message:"Auto-update error:"+err,settings:{timeout:tgd.defaults.toastTimeout}})})},("true"==localStorage.autoUpdates||"true"==tgd.defaults.autoUpdates&&_.isEmpty(localStorage.autoUpdates))&&(tgd.localLog("Checking for auto updates"),tgd.checkUpdates())}catch(e){tgd.localLog("update crash"+e)}}(),tgd.cartesianProductOf=function(x){return _.reduce(x,function(a,b){return _.flatten(_.map(a,function(x){return _.map(b,function(y){return x.concat([y])})}),!0)},[[]])},tgd.sum=function(arr){return _.reduce(arr,function(memo,num){return memo+num},0)},tgd.average=function(arr){return _.reduce(arr,function(memo,num){return memo+num},0)/arr.length},tgd.joinStats=function(arrItems){var tmp={};return _.each(arrItems,function(item){_.each(item.activeRoll||item.stats,function(value,key){key in tmp||(tmp[key]=0),tmp[key]+=value})}),tmp},tgd.hashCode=function(str){if(Array.prototype.reduce)return str.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0);var i,chr,len,hash=0;if(0===str.length)return hash;for(i=0,len=str.length;len>i;i++)chr=str.charCodeAt(i),hash=(hash<<5)-hash+chr,hash|=0;return hash},tgd.version="3.8.6.5",tgd.moveItemPositionHandler=function(element,item){if(tgd.localLog("moveItemPositionHandler"),app.destinyDbMode()===!0)return tgd.localLog("destinyDbMode"),window.open(item.href,tgd.openTabAs),!1;if(app.loadoutMode()===!0){tgd.localLog("loadoutMode");var existingItem,itemFound=!1;item._id>0?(existingItem=_.findWhere(app.activeLoadout().ids(),{id:item._id}),existingItem&&(app.activeLoadout().ids.remove(existingItem),itemFound=!0)):(existingItem=_.filter(app.activeLoadout().generics(),function(itm){return item.id==itm.hash&&item.characterId()==itm.characterId}),existingItem.length>0&&(app.activeLoadout().generics.removeAll(existingItem),itemFound=!0)),itemFound===!1&&(item.transferStatus>=2&&"Subclasses"!=item.bucketType?$.toaster({priority:"danger",title:"Warning",message:app.activeText().unable_create_loadout_for_type,settings:{timeout:tgd.defaults.toastTimeout}}):"0"===item._id?app.activeLoadout().addGenericItem({hash:item.id,bucketType:item.bucketType,characterId:item.characterId()}):_.where(app.activeLoadout().items(),{bucketType:item.bucketType}).length<10?app.activeLoadout().addUniqueItem({id:item._id,bucketType:item.bucketType,doEquip:!1}):$.toaster({priority:"danger",title:"Error",message:app.activeText().unable_to_create_loadout_for_bucket+item.bucketType,settings:{timeout:tgd.defaults.toastTimeout}}))}else{tgd.localLog("else"),app.activeItem(item);var $movePopup=$("#move-popup");if(item.transferStatus>=2&&"Subclasses"!=item.bucketType||"Post Master"==item.bucketType||"Messages"==item.bucketType||"Invisible"==item.bucketType||"Lost Items"==item.bucketType||"Bounties"==item.bucketType||"Mission"==item.bucketType||"Armsday Order"==item.typeName)return void $.toaster({priority:"danger",title:"Error",message:app.activeText().unable_to_move_bucketitems,settings:{timeout:tgd.defaults.toastTimeout}});element==tgd.activeElement?($movePopup.hide(),tgd.activeElement=null,tgd.localLog("hide")):(tgd.localLog("show"),tgd.activeElement=element,$ZamTooltips.hide(),window.isMobile?($("body").css("padding-bottom",$movePopup.height()+"px"),setTimeout(function(){$movePopup.show().addClass("mobile")},50)):(tgd.localLog("display"),$movePopup.removeClass("navbar navbar-default navbar-fixed-bottom").addClass("desktop").show().position({my:"left bottom",at:"left top",collision:"none",of:element,using:function(pos,ui){var obj=$(this),box=$(ui.element.element).find(".move-popup").width();obj.removeAttr("style"),box+pos.left>$(window).width()&&(pos.left=pos.left-box),obj.css(pos).width(box)}})))}};var Item=function(model,profile){var self=this;model&&model.id&&(model.equipRequiredLevel=0,model.isEquipment=!0),_.each(model,function(value,key){self[key]=value}),this.character=profile,this.init(model),this.characterId=ko.observable(self.character.id),this.isFiltered=ko.observable(!1),this.isVisible=ko.pureComputed(this._isVisible,this),this.columnMode=ko.computed(this._columnMode,this),this.opacity=ko.computed(this._opacity,this),this.primaryStatValue=ko.pureComputed(this._primaryStatValue,this)};Item.prototype={init:function(item){var self=this,info={};if(item.itemHash in _itemDefs?info=_itemDefs[item.itemHash]:(info={bucketTypeHash:"1498876634",itemName:"Classified",tierTypeName:"Exotic",icon:"/img/misc/missing_icon.png",itemTypeName:"Classified"},tgd.localLog("found an item without a definition! "+JSON.stringify(item)),tgd.localLog(item.itemHash)),info.bucketTypeHash in tgd.DestinyBucketTypes){if("2422292810"==info.bucketTypeHash&&info.deleteOnAction===!1)return;var description,tierTypeName,itemDescription,itemTypeName,perks,stats,bucketType,primaryStat,statPerks,rolls,bonus,armorIndex;try{description=decodeURIComponent(info.itemName),tierTypeName=decodeURIComponent(info.tierTypeName),itemDescription=decodeURIComponent(info.itemDescription),itemTypeName=decodeURIComponent(info.itemTypeName)}catch(e){description=info.itemName,tierTypeName=info.tierTypeName,itemDescription=info.itemDescription,itemTypeName=info.itemTypeName}info.icon=""===info.icon?"/img/misc/missing_icon.png":info.icon,perks=self.parsePerks(item.id,item.talentGridHash,item.perks,item.nodes,item.itemInstanceId),stats=self.parseStats(perks,item.stats,item.itemHash),statPerks=_.where(perks,{isStat:!0}),bucketType=item.bucketType||self.character.getBucketTypeHelper(item,info),armorIndex=tgd.DestinyArmorPieces.indexOf(bucketType),primaryStat=self.parsePrimaryStat(item,bucketType),bonus=0==statPerks.length?0:tgd.bonusStatPoints(armorIndex,primaryStat),rolls=self.normalizeRolls(stats,statPerks,primaryStat,bonus,description),futureRolls=self.calculateFutureRolls(stats,statPerks,primaryStat,armorIndex,bonus,description),$.extend(self,{id:item.itemHash,href:"https://destinydb.com/items/"+item.itemHash,_id:item.itemInstanceId,characterId:ko.observable(self.character.id),damageType:item.damageType,damageTypeName:tgd.DestinyDamageTypes[item.damageType],isEquipment:item.isEquipment,isEquipped:ko.observable(item.isEquipped),isGridComplete:item.isGridComplete,locked:ko.observable(item.locked),description:description,itemDescription:itemDescription,classType:info.classType,bucketType:bucketType,type:info.itemSubType,typeName:itemTypeName,tierType:info.tierType,tierTypeName:tierTypeName,icon:tgd.dataDir+info.icon,maxStackSize:info.maxStackSize,equipRequiredLevel:item.equipRequiredLevel,canEquip:item.canEquip,weaponIndex:tgd.DestinyWeaponPieces.indexOf(bucketType),armorIndex:armorIndex,transferStatus:item.transferStatus,perks:perks,stats:stats,hasLifeExotic:_.where(perks,{name:"The Life Exotic"}).length>0,perksInProgress:0===_.filter(perks,function(perk){return perk.active===!1&&-1===perk.isExclusive}).length,primaryStat:ko.observable(primaryStat),rolls:rolls,futureRolls:futureRolls,primaryValues:{CSP:tgd.sum(_.values(stats)),bonus:bonus,Default:primaryStat},backgroundPath:"Emblem"==itemTypeName?app.makeBackgroundUrl(info.secondaryIcon):"",actualBucketType:_.reduce(tgd.DestinyLayout,function(memo,layout){return(layout.bucketTypes.indexOf(bucketType)>-1&&-1==layout.extras.indexOf(bucketType)||-1==layout.bucketTypes.indexOf(bucketType)&&layout.extras.indexOf(bucketType)>-1)&&(memo=layout.array),memo},""),hasUnlockedStats:_.where(statPerks,{active:!0}).length>0||0==statPerks.length}),self.primaryValues.MaxLightCSP=Math.ceil(tgd.calculateStatRoll(self,tgd.DestinyLightCap,!0)),self.primaryValues.MaxLightPercent=Math.round(self.primaryValues.MaxLightCSP/tgd.DestinyMaxCSP[self.bucketType]*100)}},calculateFutureRolls:function(stats,statPerks,primaryStat,armorIndex,currentBonus,description){var futureRolls=[];if(0==statPerks.length)futureRolls=[stats];else{var futureBonus=tgd.bonusStatPoints(armorIndex,tgd.DestinyLightCap),allStatsLocked=0==_.where(statPerks,{active:!0}).length;futureRolls=_.map(statPerks,function(statPerk){var tmp=_.clone(stats),isStatActive=statPerk.active,otherStatName=_.reduce(stats,function(memo,stat,name){return name!=statPerk.name&&stat>0?name:memo},"");tmp[isStatActive?statPerk.name:otherStatName]=tmp[isStatActive?statPerk.name:otherStatName]-(allStatsLocked?0:currentBonus);var sum=tgd.sum(tmp),weight=tmp[statPerk.name]/sum;return tmp[statPerk.name]=Math.round(sum*tgd.DestinyLightCap/primaryStat*weight)+futureBonus,tmp[otherStatName]=Math.round(sum*tgd.DestinyLightCap/primaryStat*(1-weight)),tmp})}return futureRolls},normalizeRolls:function(stats,statPerks,primaryStat,bonus,description){var arrRolls=[];if(0==statPerks.length)arrRolls=[stats];else{var hasUnlockedStats=_.where(statPerks,{active:!0}).length>0;arrRolls=_.map(statPerks,function(statPerk){var tmp=_.clone(stats);if(hasUnlockedStats&&0==statPerk.active){var otherStatName=_.reduce(stats,function(memo,stat,name){return name!=statPerk.name&&stat>0?name:memo},"");tmp[otherStatName]=tmp[otherStatName]-bonus,tmp[statPerk.name]=tmp[statPerk.name]+bonus}else 0==hasUnlockedStats&&(tmp[statPerk.name]=tmp[statPerk.name]+bonus);return tmp})}return arrRolls},parsePrimaryStat:function(item,bucketType){var primaryStat="";if(item.primaryStat&&(primaryStat=item.primaryStat&&item.primaryStat.value?item.primaryStat.value:item.primaryStat),item&&item.objectives&&item.objectives.length>0){var progress=(100*tgd.average(_.map(item.objectives,function(objective){var result=0;return objective.objectiveHash in _objectiveDefs&&_objectiveDefs[objective.objectiveHash]&&_objectiveDefs[objective.objectiveHash].completionValue&&(result=objective.progress/_objectiveDefs[objective.objectiveHash].completionValue),result}))).toFixed(0)+"%";primaryStat=""===primaryStat?progress:primaryStat+"/"+progress}return("Materials"==bucketType||"Consumables"==bucketType||("Lost Items"==bucketType||"Invisible"==bucketType)&&item.stackSize>1)&&(primaryStat=item.stackSize),primaryStat},parseStats:function(perks,stats,itemHash){var parsedStats={};return stats&&stats.length&&stats.length>0&&(_.each(stats,function(stat){if(stat.statHash in window._statDefs){var p=window._statDefs[stat.statHash];parsedStats[p.statName]=stat.value}}),(_.findWhere(perks,{name:"Tripod",active:!0})||[1274330686,2808364178].indexOf(itemHash)>-1)&&(parsedStats.Magazine=3)),parsedStats},parsePerks:function(id,talentGridHash,perks,nodes,itemInstanceId){var parsedPerks=[];if(id)parsedPerks=perks;else if(_.isArray(perks)&&perks.length>0){var talentGrid=_talentGridDefs[talentGridHash];if(talentGrid&&talentGrid.nodes){_.each(perks,function(perk){if(perk.perkHash in window._perkDefs){var isInherent,p=window._perkDefs[perk.perkHash],nodeIndex=talentGrid.nodes.indexOf(_.filter(talentGrid.nodes,function(o){return _.flatten(_.pluck(o.steps,"perkHashes")).indexOf(p.perkHash)>-1})[0]);nodeIndex>0&&(isInherent=_.reduce(talentGrid.nodes[nodeIndex].steps,function(memo,step){if(memo===!1){var isPerk=_.values(step.perkHashes).indexOf(p.perkHash)>-1;isPerk&&0===step.activationRequirement.gridLevel&&(memo=!0)}return memo},!1)),parsedPerks.push({iconPath:tgd.dataDir+p.displayIcon,name:p.displayName,description:"<strong>"+p.displayName+"</strong>: "+p.displayDescription,active:perk.isActive,isExclusive:talentGrid.exclusiveSets.indexOf(nodeIndex),isInherent:isInherent,hash:p.perkHash})}});var statNames=_.pluck(tgd.DestinyArmorStats,"statName"),perkHashes=_.pluck(parsedPerks,"hash"),perkNames=_.pluck(parsedPerks,"name"),talentPerks={},talentGridNodes=talentGrid.nodes;_.each(nodes,function(node){if(node.hidden===!1){var nodes=_.findWhere(talentGridNodes,{nodeHash:node.nodeHash});if(nodes&&nodes.steps){var perk=nodes.steps[node.stepIndex],isSkill=_.intersection(perk.nodeStepName.split(" "),statNames);if(0!=isSkill.length||!node.isActivated||-1!=tgd.DestinyUnwantedNodes.indexOf(perk.nodeStepName)||-1!=perkNames.indexOf(perk.nodeStepName)||0!==perk.perkHashes.length&&-1!==perkHashes.indexOf(perk.perkHashes[0])){if(isSkill.length>0){var statName=isSkill[0];talentPerks[statName]={active:1==node.isActivated&&-1==[7,1].indexOf(node.state),name:statName,description:"",iconPath:"",isExclusive:-1,isStat:!0,hash:_.findWhere(tgd.DestinyArmorStats,{statName:statName})}}}else talentPerks[perk.nodeStepName]={active:!0,name:perk.nodeStepName,description:"<strong>"+perk.nodeStepName+"</strong>: "+perk.nodeStepDescription,iconPath:tgd.dataDir+perk.icon,isExclusive:-1,hash:perk.icon.match(/icons\/(.*)\.png/)[1]}}}}),_.each(talentPerks,function(perk){parsedPerks.push(perk)})}}return parsedPerks},_opacity:function(){return this.equipRequiredLevel<=this.character.level()||"Vault"==this.character.id?1:.3},_columnMode:function(){var self=this,className="";return className="Vault"==self.characterId()?"col-xs-"+app.vaultColumns():4==tgd.DestinyBucketColumns[self.bucketType]?"col-xs-"+tgd.bootstrapGridColumns/4:"col-xs-"+tgd.bootstrapGridColumns/3,self.isGridComplete&&(className+=" complete"),className},isEquippable:function(avatarId){var self=this;return ko.pureComputed(function(){var equippableSubclass="Subclasses"==self.bucketType&&!self.isEquipped()&&self.character.id==avatarId||"Subclasses"!==self.bucketType;return self.characterId()==avatarId&&!self.isEquipped()&&"Vault"!==avatarId&&"Materials"!=self.bucketType&&"Consumables"!=self.bucketType&&-1==self.description.indexOf("Engram")&&-1==self.typeName.indexOf("Armsday")&&equippableSubclass||self.characterId()!=avatarId&&"Vault"!==avatarId&&"Materials"!=self.bucketType&&"Consumables"!=self.bucketType&&-1==self.description.indexOf("Engram")&&equippableSubclass&&self.transferStatus<2})},isStoreable:function(avatarId){var self=this;return ko.pureComputed(function(){return self.characterId()!=avatarId&&"Vault"!==avatarId&&"Subclasses"!==self.bucketType&&self.transferStatus<2||self.isEquipped()&&self.character.id==avatarId})},clone:function(){var self=this,model={};for(var i in self)if(self.hasOwnProperty(i)){var val=ko.unwrap(self[i]);"function"!=typeof val&&(model[i]=val)}var newItem=new Item(model,self.character);return newItem},hasPerkSearch:function(search){var foundPerk=!1,self=this;if(self.perks){var vSearch=search.toLowerCase();self.perks.forEach(function(perk){(perk.name.toLowerCase().indexOf(vSearch)>-1||perk.description.toLowerCase().indexOf(vSearch)>-1)&&(foundPerk=!0)})}return foundPerk},hashProgress:function(state){var self=this;return"undefined"!=typeof self.progression?"1"==state&&self.progression===!1?!0:"2"==state&&self.progression===!0&&self.isGridComplete===!1?!0:"3"==state&&self.progression===!0&&self.isGridComplete===!0?!0:!1:!1},hasGeneral:function(type){return"Engrams"==type&&this.description.indexOf("Engram")>-1&&this.isEquipment===!1?!0:type in tgd.DestinyGeneralItems&&tgd.DestinyGeneralItems[type].indexOf(this.id)>-1?!0:!1},_primaryStatValue:function(){if(this.primaryStat&&"function"==typeof this.primaryStat){var primaryStat=ko.unwrap(this.primaryStat());return this.objectives&&"string"==typeof primaryStat&&primaryStat.indexOf("/")>-1&&(primaryStat=parseInt(primaryStat.split("/")[0])),primaryStat}},_isVisible:function(){var $parent=app,self=this;if("undefined"==typeof self.id)return!1;var dmgFilter=!0,progressFilter=!0,weaponFilter=!0,armorFilter=!0,showDuplicate=!0,setFilter=!0,searchFilter=""===$parent.searchKeyword()||""!==$parent.searchKeyword()&&self.description.toLowerCase().indexOf($parent.searchKeyword().toLowerCase())>-1,tierFilter="0"==$parent.tierFilter()||$parent.tierFilter()==self.tierType,itemStatValue="";this.primaryStatValue&&this.primaryStatValue()&&(itemStatValue=this.primaryStatValue().toString());var operator=$parent.searchKeyword().substring(0,1);if(""!==itemStatValue&&-1==itemStatValue.indexOf("%")&&(">"==operator||"<"==operator||$.isNumeric($parent.searchKeyword()))){var operand="=",searchValue=$parent.searchKeyword();">"===operator||"<"===operator?(operand=operator+operand,searchValue=searchValue.replace(operator,"")):operand="="+operand,searchFilter=new Function("return "+itemStatValue+operand+searchValue.toString())()}if(self.armorIndex>-1||self.weaponIndex>-1){if(setFilter=0===$parent.setFilter().length||$parent.setFilter().indexOf(self.id)>-1,searchFilter=searchFilter||self.hasPerkSearch($parent.searchKeyword()),self.weaponIndex>-1)dmgFilter=0===$parent.dmgFilter().length||$parent.dmgFilter().indexOf(self.damageTypeName)>-1,weaponFilter="0"==$parent.weaponFilter()||$parent.weaponFilter()==self.typeName;else{var types=_.map(_.pluck(self.perks,"name"),function(name){return name&&name.split(" ")[0]});dmgFilter=0===$parent.dmgFilter().length||_.intersection($parent.dmgFilter(),types).length>0,armorFilter="0"==$parent.armorFilter()||$parent.armorFilter()==self.bucketType}progressFilter="0"==$parent.progressFilter()||self.hashProgress($parent.progressFilter())}generalFilter="0"==$parent.generalFilter()||self.hasGeneral($parent.generalFilter()),showDuplicate=$parent.customFilter()===!1||$parent.customFilter()===!0&&self.isFiltered()===!0;var isVisible=searchFilter&&dmgFilter&&setFilter&&tierFilter&&progressFilter&&weaponFilter&&armorFilter&&generalFilter&&showDuplicate;return isVisible},unequip:function(callback){var self=this;if(tgd.localLog("trying to unequip too!"),self.isEquipped()===!0){tgd.localLog("and its actually equipped");var otherEquipped=!1,itemIndex=-1,otherItems=_.filter(self.character.items(),function(item){return item._id!=self._id&&item.bucketType==self.bucketType});if(otherItems.length>0){var minTier=_.min(_.pluck(otherItems,"tierType")),tryNextItem=function(){var item=otherItems[++itemIndex];return _.isUndefined(item)?void(callback?callback(!1):(tgd.localLog("transfer error 5"),$.toaster({priority:"danger",title:"Error",message:app.activeText().cannot_unequip+self.description,settings:{timeout:tgd.defaults.toastTimeout}}))):(tgd.localLog(item.description),void(otherEquipped===!1&&(item!=self&&item.equip?(tgd.localLog("trying to equip "+item.description),item.equip(self.characterId(),function(isEquipped,result){tgd.localLog(item.description+" result was "+isEquipped),isEquipped===!0?(otherEquipped=!0,callback(!0)):isEquipped===!1&&result&&result.ErrorCode&&1634===result.ErrorCode?callback(!1):(tryNextItem(),tgd.localLog("tryNextItem"))})):(tryNextItem(),tgd.localLog("tryNextItem")))))};if(tgd.localLog("tryNextItem"),tgd.localLog("trying to unequip item, the min tier of the items I can equip is: "+minTier),6==minTier){var otherItemUnequipped=!1,otherBucketTypes=self.weaponIndex>-1?_.clone(tgd.DestinyWeaponPieces):_.clone(tgd.DestinyArmorPieces);otherBucketTypes.splice(self.weaponIndex>-1?self.weaponIndex:self.armorIndex,1),_.each(otherBucketTypes,function(bucketType){var itemEquipped=self.character.itemEquipped(bucketType);itemEquipped&&itemEquipped.tierType&&6==itemEquipped.tierType&&(tgd.localLog("going to unequip "+itemEquipped.description),itemEquipped.unequip(function(result){result?tryNextItem():(tgd.localLog("transfer error 6"),$.toaster({priority:"danger",title:"Error",message:app.activeText().unable_unequip+itemEquipped.description,settings:{timeout:tgd.defaults.toastTimeout}}),callback(!1))}),otherItemUnequipped=!0)}),otherItemUnequipped||(tgd.localLog("no other exotic equipped, safe to equip"),tryNextItem())}else tryNextItem()}else tgd.localLog("refused to unequip"),callback(!1)}else tgd.localLog("but not equipped"),callback(!0)},equip:function(targetCharacterId,callback){var self=this,done=function(){tgd.localLog("making bungie call to equip "+self.description),app.bungie.equip(targetCharacterId,self._id,function(e,result){if(result&&result.Message&&"Ok"==result.Message){var done=function(){tgd.localLog(self),tgd.localLog("result was OKed for "+self.description),tgd.localLog(result),self.isEquipped(!0),self.character.items().forEach(function(item){item._id!=self._id&&item.bucketType==self.bucketType&&item.isEquipped()===!0&&item.isEquipped(!1)}),"Emblem"==self.bucketType&&(self.character.icon(self.icon),self.character.background(self.backgroundPath)),callback&&callback(!0)};self instanceof Item?done():(app.findReference(self,function(item){self=item,done()}),tgd.localLog("changing reference of self to actual item"))}else tgd.localLog("transfer error 7 "+result),callback?callback(!1,result):result&&result.Message?$.toaster({priority:"info",title:"Error",message:result.Message,settings:{timeout:tgd.defaults.toastTimeout}}):BootstrapDialog.alert(self.description+":"+app.activeText().cannot_equip+(result&&result.error)?result.error:"")})},sourceCharacterId=self.characterId();if(tgd.localLog("equip called from "+sourceCharacterId+" to "+targetCharacterId),targetCharacterId==sourceCharacterId)if(tgd.localLog("item is already in the character"),6==self.tierType&&self.hasLifeExotic===!1){var otherExoticFound=!1,otherBucketTypes=self.weaponIndex>-1?_.clone(tgd.DestinyWeaponPieces):_.clone(tgd.DestinyArmorPieces);otherBucketTypes.splice(self.weaponIndex>-1?self.weaponIndex:self.armorIndex,1),_.each(otherBucketTypes,function(bucketType){var otherExotic=_.filter(_.where(self.character.items(),{bucketType:bucketType,tierType:6}),function(item){return item.isEquipped()});otherExotic.length>0&&(otherExoticFound=!0,otherExotic[0].unequip(done))}),otherExoticFound===!1&&done()}else done();else tgd.localLog("item is NOT already in the character"),self.store(targetCharacterId,function(newProfile){tgd.localLog("item is now in the target destination"),self.character=newProfile,self.characterId(newProfile.id),self.equip(targetCharacterId,callback)})},transfer:function(sourceCharacterId,targetCharacterId,amount,cb){var x,y,self=this,characters=app.characters();if(0===characters.length)return app.refresh(),BootstrapDialog.alert("Attempted a transfer with no characters loaded, how is that possible? Please report this issue to my Github.");var isVault="Vault"==targetCharacterId,ids=_.pluck(characters,"id");if(x=characters[ids.indexOf(sourceCharacterId)],y=characters[ids.indexOf(targetCharacterId)],_.isUndefined(y))return app.refresh();var itemsInDestination=_.where(y.items(),{bucketType:self.bucketType}).length,maxBucketSize=self.bucketType in tgd.DestinyBucketSizes?tgd.DestinyBucketSizes[self.bucketType]:10;return itemsInDestination==maxBucketSize&&"Vault"!=y.id?BootstrapDialog.alert("Cannot transfer "+self.description+" because "+self.bucketType+" is full."):void app.bungie.transfer(isVault?sourceCharacterId:targetCharacterId,self._id,self.id,amount,isVault,function(e,result){if(result&&result.Message&&"Ok"==result.Message){if("Materials"==self.bucketType||"Consumables"==self.bucketType){tgd.localLog("[from: "+sourceCharacterId+"] [to: "+targetCharacterId+"] [amount: "+amount+"]");var theClone,existingItem=_.find(_.where(y.items(),{description:self.description}),function(i){return i.primaryStat()<i.maxStackSize}),remainder=self.primaryStat()-amount,isOverflow="undefined"==typeof existingItem?!1:existingItem.primaryStat()+amount>existingItem.maxStackSize;tgd.localLog("[remainder: "+remainder+"] [overflow: "+isOverflow+"] [underflow: "+(0>remainder)+"]");var tmpAmount=0;void 0!==existingItem?(tgd.localLog("existing stack in destination"),tmpAmount=Math.min(existingItem.maxStackSize-existingItem.primaryStat(),amount),tgd.localLog("tmpAmount: "+tmpAmount),isOverflow?(tgd.localLog("overflow: "+(amount-tmpAmount)),existingItem.primaryStat(existingItem.maxStackSize),tgd.localLog("existingItem.primaryStat updated to "+existingItem.maxStackSize)):tgd.localLog("no overflow")):tgd.localLog("no existing stack in destination or existing stacks are full");var idxSelf=x.items.indexOf(self);if(x.items.remove(self),tgd.localLog("removed self from x.items @ index "+idxSelf),remainder>0)tgd.localLog("[remainder: "+remainder+"] [clone on source: "+remainder+"]"),theClone=self.clone(),theClone.characterId(sourceCharacterId),theClone.character=x,theClone.primaryStat(remainder),x.items.splice(idxSelf,0,theClone),tgd.localLog("inserted clone to x.items @ "+idxSelf+" with primaryStat "+remainder);else if(0>remainder){tgd.localLog("[remainder: "+remainder+"] [no clone] [underflow]");var sourceRemaining=amount-self.primaryStat();tgd.localLog("need to remove "+sourceRemaining+" more from "+sourceCharacterId);for(var sourceExistingItems=_.where(x.items(),{description:self.description}),sourceIdx=sourceExistingItems.length-1;sourceRemaining>0&&sourceIdx>=0;){var sourceRightMost=sourceExistingItems[sourceIdx],sourceTmpAmount=Math.min(sourceRemaining,sourceRightMost.primaryStat());tgd.localLog("removing "+sourceTmpAmount+" from right most"),sourceRightMost.primaryStat(sourceRightMost.primaryStat()-sourceTmpAmount),sourceRightMost.primaryStat()<=0&&(x.items.remove(sourceRightMost),tgd.localLog("right most dropped to 0 or less, removing")),sourceRemaining-=sourceTmpAmount,tgd.localLog("still need to remove "+sourceRemaining+" from "+sourceCharacterId),sourceIdx-=1}}else tgd.localLog("no remainder, no clone");var newAmount;if(void 0!==existingItem?isOverflow?newAmount=amount-tmpAmount:(idxExisting=y.items.indexOf(existingItem),y.items.remove(existingItem),tgd.localLog("removed existingItem from y.items @ index "+idxExisting),newAmount=amount+existingItem.primaryStat()):newAmount=amount,self.characterId(targetCharacterId),self.character=y,self.primaryStat(newAmount),void 0!==existingItem?isOverflow?(y.items.push(self),tgd.localLog("adding self to y.items @ tail with amount: "+self.primaryStat())):(y.items.splice(idxExisting,0,self),tgd.localLog("adding self to y.items @ index "+idxExisting+" with amount: "+self.primaryStat())):(y.items.push(self),tgd.localLog("adding self to y.items @ tail with amount: "+self.primaryStat())),newAmount>self.maxStackSize)for(tgd.localLog("exceeded maxStackSize, need to do some visual splitting");self.primaryStat()>self.maxStackSize;){var extraAmount=self.primaryStat()-self.maxStackSize;idxSelf=y.items.indexOf(self),theClone=self.clone(),theClone.characterId(targetCharacterId),theClone.character=y,theClone.primaryStat(self.maxStackSize),y.items.splice(idxSelf,0,theClone),tgd.localLog("inserted clone to y.items @ "+idxSelf+" with primaryStat "+theClone.primaryStat()),self.primaryStat(extraAmount)}if(0!==remainder){tgd.localLog("running cleanup code...");for(var selfExistingItems=_.where(x.items(),{description:self.description}),idx=0;idx<selfExistingItems.length;){if(idx+1>=selfExistingItems.length){tgd.localLog("nothing to cleanup");break}var cur=selfExistingItems[idx];if(cur.primaryStat()<cur.maxStackSize){var next=selfExistingItems[idx+1],howMuch=Math.min(cur.maxStackSize-cur.primaryStat(),next.primaryStat());tgd.localLog("shifting left..."),cur.primaryStat(cur.primaryStat()+howMuch),next.primaryStat(next.primaryStat()-howMuch),next.primaryStat()<=0&&(tgd.localLog("drained a stack in cleanup"),x.items.remove(next))}idx+=1}}tgd.localLog("---------------------")}else tgd.localLog("removing "+self.description+" from "+x.uniqueName()+" currently at "+x.items().length),x.items.remove(function(item){return item._id==self._id}),tgd.localLog("after removal "+x.items().length),self.character=y,y.items.push(self),setTimeout(function(){self.characterId(targetCharacterId)},500),tgd.localLog("adding "+self.description+" to "+y.uniqueName());setTimeout(function(){cb&&cb(y,x)},500)}else cb?(tgd.localLog(self.description+"  error during transfer!!!"),tgd.localLog(result),cb(y,x,result)):result&&result.Message&&(tgd.localLog("transfer error 1"),$.toaster({priority:"info",title:"Error",message:result.Message,settings:{timeout:tgd.defaults.toastTimeout}}))})},handleTransfer:function(targetCharacterId,cb){var self=this;return function(y,x,result){if(result&&result.ErrorCode&&(1656==result.ErrorCode||1623==result.ErrorCode))tgd.localLog("reloading bucket "+self.bucketType),x._reloadBucket(self.bucketType,void 0,function(){y._reloadBucket(self.bucketType,void 0,function(){tgd.localLog("retransferring"),app.findReference(self,function(newItem){newItem.store(targetCharacterId,cb)})})});else if(result&&result.ErrorCode&&1642==result.ErrorCode)tgd.localLog(self._id+" error code 1642 no item slots using adhoc method for "+self.description),x._reloadBucket(self.bucketType,void 0,function(){y._reloadBucket(self.bucketType,void 0,function(){var adhoc=new tgd.Loadout;self._id>0?adhoc.addUniqueItem({id:self._id,bucketType:self.bucketType,doEquip:!1}):adhoc.addGenericItem({hash:self.id,bucketType:self.bucketType,characterId:self.characterId()});var msa=adhoc.transfer(targetCharacterId,!0);msa.length>0&&tgd.localLog(msa[0]),adhoc.swapItems(msa,targetCharacterId,function(){cb&&cb(y,x)})})});else if(result&&result.ErrorCode&&1648==result.ErrorCode){var vaultItems=_.findWhere(app.characters(),{id:"Vault"}).items(),targetItem=_.where(vaultItems,{id:self.id});targetItem.length>0&&targetItem[0].store(targetCharacterId,function(){self.character.id=targetCharacterId,self.store("Vault",cb)})}else cb?cb(y,x):result&&result.Message&&(tgd.localLog("transfer error 2"),$.toaster({priority:"info",title:"Error",message:result.Message,settings:{timeout:tgd.defaults.toastTimeout}}))}},store:function(targetCharacterId,callback){var self=this,sourceCharacterId=self.characterId(),transferAmount=1,done=function(){"Vault"==targetCharacterId?self.unequip(function(result){result===!0?self.transfer(sourceCharacterId,"Vault",transferAmount,self.handleTransfer(targetCharacterId,callback)):callback?callback(self.character):(tgd.localLog("transfer error 3"),$.toaster({priority:"danger",title:"Error",message:"Unable to unequip "+self.description,settings:{timeout:tgd.defaults.toastTimeout}}))}):"Vault"!==sourceCharacterId?(tgd.localLog("from character to vault to character "+self.description),self.unequip(function(result){result===!0?"Subclasses"==self.bucketType?callback&&callback(self.character):(tgd.localLog(self.character.uniqueName()+" xfering item to Vault "+self.description),self.transfer(sourceCharacterId,"Vault",transferAmount,self.handleTransfer(targetCharacterId,function(){tgd.localLog(self.character.id+" xfered item to vault and now to "+targetCharacterId),self.character.id==targetCharacterId?(tgd.localLog("took the long route ending it short "+self.description),callback&&callback(self.character)):(tgd.localLog("taking the short route "+self.description),self.transfer("Vault",targetCharacterId,transferAmount,self.handleTransfer(targetCharacterId,callback)))}))):callback?callback(self.character):(tgd.localLog("transfer error 4"),$.toaster({priority:"danger",title:"Error",message:"Unable to unequip "+self.description,settings:{timeout:tgd.defaults.toastTimeout}}))})):(tgd.localLog("from vault to character"),
self.transfer("Vault",targetCharacterId,transferAmount,self.handleTransfer(targetCharacterId,callback)))};if("Materials"==self.bucketType||"Consumables"==self.bucketType)if(1==self.primaryStat())done();else if(app.autoXferStacks()===!0||tgd.autoTransferStacks===!0)transferAmount=self.primaryStat(),done();else{var characterTotal=0,dialogItself=new tgd.dialog({message:function(){var itemTotal=0;for(i=0;i<app.orderedCharacters().length;i++){var c=app.orderedCharacters()[i],charTotal=_.reduce(_.filter(c.items(),{description:self.description}),function(memo,j){return memo+j.primaryStat()},0);self.character==c&&(characterTotal=charTotal),itemTotal+=charTotal}var $content=$('<div><div class="controls controls-row">'+app.activeText().transfer_amount+': <button type="button" class="btn btn-default" id="dec">  -  </button> <input type="text" id="materialsAmount" value="'+self.primaryStat()+'" size="4"> <button type="button" class="btn btn-default" id="inc">  +  </button><button type="button" class="btn btn-default pull-right" id="all"> '+app.activeText().transfer_all+" ("+characterTotal+') </button><button type="button" class="btn btn-default pull-right" id="one"> '+app.activeText().transfer_one+' </button></div><div><hr></div><div class="controls controls-row"><label><input type="checkbox" id="consolidate" /> '+app.activeText().transfer_consolidate+" ("+itemTotal+'))</label><br><label><input type="checkbox" id="neverAsk" /> '+app.activeText().transfer_ask+" </label></div></div>"),btnDec=$content.find("#dec");btnDec.click(function(){var num=parseInt($("input#materialsAmount").val());isNaN(num)||$("input#materialsAmount").val(Math.max(num-1,1))});var btnInc=$content.find("#inc");btnInc.click(function(){var num=parseInt($("input#materialsAmount").val());isNaN(num)||$("input#materialsAmount").val(Math.min(num+1,characterTotal))});var btnOne=$content.find("#one");btnOne.click(function(){var num=parseInt($("input#materialsAmount").val());isNaN(num)||$("input#materialsAmount").val(1)});var btnAll=$content.find("#all");btnAll.click(function(){var num=parseInt($("input#materialsAmount").val());isNaN(num)||$("input#materialsAmount").val(characterTotal)});var inputAmt=$content.find("#materialsAmount"),handleCheckChanged=function(checked){btnDec.attr("disabled",checked),btnInc.attr("disabled",checked),btnOne.attr("disabled",checked),btnAll.attr("disabled",checked),inputAmt.attr("disabled",checked),inputAmt.attr("readOnly",checked)};return $content.find("#consolidate").click(function(){handleCheckChanged(this.checked)}),$content.find("#neverAsk").click(function(){app.autoXferStacks(!0)}),$content},buttons:[{label:app.activeText().transfer,cssClass:"btn-primary",action:function(){finishTransfer($("input#consolidate")[0].checked)}},{label:app.activeText().close_msg,action:function(dialogItself){dialogItself.close()}}]}).title(app.activeText().transfer+" "+self.description).show(!0),finishTransfer=function(consolidate){consolidate?(self.consolidate(targetCharacterId,self.description),dialogItself.modal.close()):(transferAmount=parseInt($("input#materialsAmount").val()),!isNaN(transferAmount)&&transferAmount>0&&characterTotal>=transferAmount?(done(),dialogItself.modal.close()):BootstrapDialog.alert(app.activeText().invalid_transfer_amount+transferAmount))};setTimeout(function(){$("#materialsAmount").select().bind("keyup",function(e){13==e.keyCode&&finishTransfer(!1)})},500)}else{var adhoc=new tgd.Loadout;adhoc.addUniqueItem({id:self._id,bucketType:self.bucketType,doEquip:!1});var result=adhoc.transfer(targetCharacterId,!0)[0];result&&result.swapItem?adhoc.promptUserConfirm([result],targetCharacterId,callback):done()}},normalize:function(characters){app.normalizeSingle(this.description,characters,!1,void 0)},consolidate:function(targetCharacterId,description,selectedCharacters){var activeCharacters="undefined"==typeof selectedCharacters?[]:selectedCharacters,getNextStack=function(){var i=0,chars=_.filter(app.orderedCharacters(),function(c){return c.id!==targetCharacterId&&0===activeCharacters.length||activeCharacters.indexOf(c.id)>-1}),stacks=_.flatten(_.map(chars,function(c){return _.filter(c.items(),{description:description})}));return function(){return i>=stacks.length?void 0:stacks[i++]}}(),nextTransfer=function(callback){var theStack=getNextStack();if("undefined"==typeof theStack)return void(void 0!==callback&&callback());var transferAmount=theStack.primaryStat();"Vault"==targetCharacterId?theStack.transfer(theStack.character.id,"Vault",transferAmount,function(){nextTransfer(callback)}):"Vault"==theStack.character.id?theStack.transfer("Vault",targetCharacterId,transferAmount,function(){nextTransfer(callback)}):theStack.character.id==targetCharacterId?nextTransfer(callback):theStack.transfer(theStack.character.id,"Vault",transferAmount,function(){theStack.transfer("Vault",targetCharacterId,transferAmount,function(){nextTransfer(callback)})})};nextTransfer(void 0)},extrasGlue:function(){var self=this,selectedStatus=[];for(i=0;i<app.orderedCharacters().length;i++){var id=app.orderedCharacters()[i].id;selectedStatus[id]="Vault"!==id}new tgd.dialog({message:function(dialogItself){var getTotalSelectedItemCount=function(){var c=0;for(i=0;i<app.orderedCharacters().length;i++)if(selectedStatus[app.orderedCharacters()[i].id]===!0){var ct=_.reduce(_.filter(app.orderedCharacters()[i].items(),{description:self.description}),function(memo,i){return memo+i.primaryStat()},0);c+=parseInt(ct)}return c},$content=$(tgd.normalizeTemplate({item:self,characters:app.orderedCharacters(),selected:selectedStatus,total:getTotalSelectedItemCount()})),charButtonClicked=function(self,id){selectedStatus[id]=!selectedStatus[id],$content.find("#total").text(getTotalSelectedItemCount()),self.find("img").css("border",selectedStatus[id]===!0?"solid 3px yellow":"none")};return $.each(app.orderedCharacters(),function(i,val){var id=val.id,sel="#char"+i.toString();$content.find(sel).click(function(){charButtonClicked($(this),id)})}),$content},buttons:[{label:"Normalize",cssClass:"btn-primary",action:function(dialogItself){var characters=_.filter(app.orderedCharacters(),function(c){return selectedStatus[c.id]===!0});return characters.length<=1?void BootstrapDialog.alert("Need to select two or more characters."):(self.normalize(characters),void dialogItself.close())}},{label:"Consolidate",cssClass:"btn-primary",action:function(dialogItself){var characters=_.pluck(_.filter(app.orderedCharacters(),function(c){return selectedStatus[c.id]===!0}),"id");self.consolidate(self.character.id,self.description,characters),dialogItself.close()}},{label:"Close",action:function(dialogItself){dialogItself.close()}}]}).title("Extras for "+self.description).show(!0)},toggleLock:function(){var self=this,characterId="Vault"==self.characterId()?_.find(app.orderedCharacters(),function(c){return"Vault"!==c.id}).id:self.character.id,newState=!self.locked();app.bungie.setlockstate(characterId,self._id,newState,function(results,response){return 1!==response.ErrorCode?BootstrapDialog.alert("setlockstate error: "+JSON.stringify(response)):void self.locked(newState)})},openInDestinyTracker:function(){window.open("http://db.destinytracker.com/items/"+this.id,tgd.openTabAs)},openInArmory:function(){window.open("https://www.bungie.net/en/armory/Detail?type=item&item="+this.id,tgd.openTabAs)},openInDestinyDB:function(){window.open(this.href,tgd.openTabAs)},getValue:function(type){var value;return value="Light"==type?this.primaryValues.Default:"MaxLightCSP"==type?this.primaryValues.MaxLightCSP:"MaxLightPercent"==type?this.primaryValues.MaxLightPercent:"All"==type?this.primaryValues.CSP:_.isObject(this.stats)&&type in this.stats?parseInt(this.stats[type]):0}},Profile.prototype={init:function(profile){var self=this;"Vault"==self.id?(self.background(app.makeBackgroundUrl("assets/vault_emblem.jpg",!0)),self.icon("assets/vault_icon.jpg"),self.gender("Tower"),self.classType("Vault")):self.updateCharacter(profile);var processedItems=[];_.each(profile.items,function(item){var processedItem=new Item(item,self);"id"in processedItem&&processedItems.push(processedItem)}),self.items(processedItems),"Vault"!=self.id&&"undefined"==typeof profile.processed&&self._reloadBucket(self,void 0,_.noop,!0)},setFarmTarget:function(){app.farmTarget(this.id)},updateCharacter:function(profile){var self=this;profile&&profile.processed?(self.background(profile.characterBase.background),self.icon(profile.characterBase.icon),self.gender(profile.characterBase.gender),self.classType(profile.characterBase.classType),self.level(profile.characterBase.level),self.stats(profile.characterBase.stats),self.race(profile.characterBase.race),self.percentToNextLevel(0)):(self.background(app.makeBackgroundUrl(tgd.dataDir+profile.backgroundPath,!0)),self.icon(tgd.dataDir+profile.emblemPath),self.gender(tgd.DestinyGender[profile.characterBase.genderType]),self.classType(tgd.DestinyClass[profile.characterBase.classType]),self.level(profile.characterLevel),self.stats(profile.characterBase.stats),"STAT_LIGHT"in self.stats()||(self.stats().STAT_LIGHT=0),self.percentToNextLevel(profile.percentToNextLevel),self.race(_raceDefs[profile.characterBase.raceHash].raceName))},refresh:function(profile,event){tgd.localLog("refresh event called");var self=this;"Vault"==self.id?self._reloadBucket(self,event):app.bungie.character(self.id,function(result){result&&result.data&&(self.updateCharacter(result.data),self._reloadBucket(self,event))})},getBucketTypeHelper:function(item,info){return"undefined"==typeof info?"":4!==item.location?tgd.DestinyBucketTypes[info.bucketTypeHash]:item.isEquipment||tgd.lostItemsHelper.indexOf(item.itemHash)>-1||4==item.location&&item.itemInstanceId>0?"Lost Items":tgd.invisibleItemsHelper.indexOf(item.itemHash)>-1?"Invisible":"Messages"},reloadBucketFilter:function(buckets){var self=this;return function(item){var info={};if(info=item.itemHash in _itemDefs?_itemDefs[item.itemHash]:{bucketTypeHash:"1498876634",itemName:"Classified",tierTypeName:"Exotic",icon:"/img/misc/missing_icon.png",itemTypeName:"Classified"},info&&info.bucketTypeHash&&info.bucketTypeHash in tgd.DestinyBucketTypes){var itemBucketType=self.getBucketTypeHelper(item,info);if(buckets.indexOf(itemBucketType)>-1)return!0}}},reloadBucketHandler:function(buckets,done){var self=this;return function(results,response){if(!(results&&results.data&&results.data.buckets))return results&&results.ErrorCode&&99==results.ErrorCode?(done(),BootstrapDialog.alert(results.Message)):(done(),app.refresh(),BootstrapDialog.alert("Code 20: "+app.activeText().error_loading_inventory+JSON.stringify(response)));var items=_.filter(app.bungie.flattenItemArray(results.data.buckets),self.reloadBucketFilter(buckets));_.each(items,function(item){var processedItem=new Item(item,self);"id"in processedItem&&self.items.push(processedItem)}),done()}},calculatePowerLevelWithItems:function(items){if(0===items.length)return 0;var index=items.filter(this.filterItemByType("Artifact",!0)).length,weights=tgd.DestinyBucketWeights[index];if(weights){var eligibleGear=_.filter(items,function(item){return item.bucketType in weights}),primaryStatsGear=_.map(eligibleGear,function(item){return item.primaryStatValue()*(weights[item.bucketType]/100)}),powerLevel=Math.floor(tgd.sum(primaryStatsGear));return powerLevel}return 0},_equippedGear:function(){return _.filter(this.items(),function(item){return item.isEquipped()})},_equippedStats:function(){return tgd.joinStats(this.equippedGear())},_equippedSP:function(){return _.filter(this.equippedStats(),function(value,stat){return _.where(tgd.DestinyArmorStats,{statName:stat}).length>0})},_sumCSP:function(){return tgd.sum(this.equippedSP())},_equippedTier:function(){var theoreticalTier=Math.floor(this.sumCSP()/tgd.DestinySkillTier),effectiveTier=tgd.sum(_.map(this.equippedSP(),function(value){return Math.floor(value/tgd.DestinySkillTier)}));return effectiveTier+"/"+theoreticalTier},_tierCSP:function(){return this.equippedTier().split("/")[1]*tgd.DestinySkillTier},_potentialCSP:function(){return tgd.sum(_.map(_.filter(this.equippedGear(),function(item){return item.armorIndex>-1}),function(item){return Math.floor(tgd.calculateStatRoll(item,tgd.DestinyLightCap,!0))}))},_classLetter:function(){return this.classType()[0].toUpperCase()},_uniqueName:function(){return this.level()+" "+this.race()+" "+this.gender()+" "+this.classType()},_iconBG:function(){return app.makeBackgroundUrl(this.icon(),!0)},_powerLevel:function(){return"Vault"==this.id?"":this.calculatePowerLevelWithItems(this.equippedGear())},_reloadBucket:function(model,event,callback,excludeMessage){function done(){function reallyDone(){self.reloadingBucket=!1,element&&element.removeClass("fa-spin"),excludeMessage||$.toaster({priority:"info",title:"Success",message:"Refresh completed for "+self.uniqueName(),settings:{timeout:tgd.defaults.toastTimeout}})}needsInvisibleRefresh?app.bungie.account(function(results,response){if(!(results&&results.data&&results.data.inventory&&results.data.inventory.buckets&&results.data.inventory.buckets.Invisible))return reallyDone(),app.refresh(),BootstrapDialog.alert("Code 40: "+app.activeText().error_loading_inventory+JSON.stringify(response));var invisible=results.data.inventory.buckets.Invisible;invisible.forEach(function(b){b.items.forEach(function(item){self.items.push(new Item(item,self,!0))})}),reallyDone()}):reallyDone(),callback&&callback()}var element,self=this;if(!self.reloadingBucket){excludeMessage||$.toaster({priority:"info",title:"Success",message:"Refreshing "+self.uniqueName(),settings:{timeout:tgd.defaults.toastTimeout}});var buckets=[];"string"==typeof model||model instanceof String?buckets.push(model):model instanceof tgd.Layout?buckets.push.apply(buckets,model.bucketTypes):model instanceof Profile&&(_.each(tgd.DestinyLayout,function(layout){buckets.push.apply(buckets,layout.bucketTypes)}),buckets.splice(buckets.indexOf("Invisible"),1)),self.reloadingBucket=!0,"undefined"!=typeof event&&(element=$(event.target).is(".fa")?$(event.target):$(event.target).find(".fa"),element.is(".fa")===!1&&(element=$(event.target).is(".emblem")?$(event.target):$(event.target).find(".emblem"),element.is(".emblem")===!1&&(element=$(event.target).parent().find(".emblem"))),element.addClass("fa-spin"));var needsInvisibleRefresh=buckets.indexOf("Invisible")>-1,itemsToRemove=_.filter(self.items(),function(item){return buckets.indexOf(item.bucketType)>-1});self.items.removeAll(itemsToRemove),"Vault"==self.id?app.bungie.vault(self.reloadBucketHandler(buckets,done)):app.bungie.inventory(self.id,self.reloadBucketHandler(buckets,done))}},_weapons:function(){return _.filter(this.items(),function(item){return item.weaponIndex>-1?item:void 0})},_armor:function(){return _.filter(this.items(),function(item){return item.armorIndex>-1&&-1==tgd.DestinyGeneralExceptions.indexOf(item.bucketType)?item:void 0})},_general:function(){return _.filter(this.items(),function(item){return(-1==item.armorIndex||tgd.DestinyGeneralExceptions.indexOf(item.bucketType)>-1)&&-1==item.weaponIndex&&"Post Master"!==item.bucketType&&"Messages"!==item.bucketType&&"Invisible"!==item.bucketType&&"Lost Items"!==item.bucketType&&"Subclasses"!==item.bucketType?item:void 0})},_invisible:function(){return _.filter(this.items(),function(item){return"Invisible"==item.bucketType?item:void 0})},_lostItems:function(){return _.filter(this.items(),function(item){return"Lost Items"==item.bucketType?item:void 0})},filterItemByType:function(type,isEquipped){return function(item){return item.bucketType==type&&item.isEquipped()==isEquipped}},all:function(type){var items=_.where(this.items(),{bucketType:type}),activeSort=parseInt(app.activeSort());return 0===activeSort?items=_.sortBy(items,function(item){return[-1*item.tierType,item.type]}).reverse():1===activeSort?items=_.sortBy(items,function(item){return item.type}):2===activeSort?items=_.sortBy(items,function(item){return-1*item.primaryStatValue()}):3===activeSort?items=_.sortBy(items,function(item){return item.damageType}):4===activeSort?items=_.sortBy(items,function(item){return item.description}):5===activeSort?items=_.sortBy(items,function(item){return[-1*item.tierType,-1*item.primaryStatValue()]}).reverse():6===activeSort&&(items=_.sortBy(items,function(item){return[-1*item.tierType,-1*item.description]}).reverse()),items},get:function(type){return this.all(type).filter(this.filterItemByType(type,!1))},getVisible:function(type){return _.filter(this.get(type),function(item){return item.isVisible()})},itemEquipped:function(type){return ko.utils.arrayFirst(this.items(),this.filterItemByType(type,!0))},itemEquippedVisible:function(type){var ie=this.itemEquipped(type);return _.isEmpty(ie)?!1:ie.isVisible()},toggleStats:function(){this.statsShowing(!this.statsShowing())},queryRolls:function(items,callback){function done(){count++,items.length==count&&callback()}function getRolls(item,callback){app.bungie.getItemDetail(item.characterId(),item._id,function(detail){item.rolls=_.reduce(detail.data.statsOnNodes,function(rolls,stat,key,stats){var index=_.keys(stats).indexOf(key);return _.each(stat.currentNodeStats,function(node){_.each(rolls,function(roll,rollIndex){var key=_statDefs[node.statHash].statName;(0===index||index>0&&0===rollIndex)&&(roll[key]=(roll[key]||0)+node.value)})}),_.each(stat.nextNodeStats,function(node){_.each(rolls,function(roll,rollIndex){var key=_statDefs[node.statHash].statName;1===rollIndex&&(roll[key]=(roll[key]||0)+node.value)})}),rolls},[{},{}]),window.localStorage.setItem("rolls_"+item._id,JSON.stringify(item.rolls)),callback()})}var count=0;_.each(items,function(item){if(item.rolls)done();else{var cachedRolls=window.localStorage.getItem("rolls_"+item._id);cachedRolls?(item.rolls=JSON.parse(cachedRolls),tgd.sum(item.rolls[0])!=tgd.sum(item.stats)?(console.log("getting new rolls"),getRolls(item,done)):done()):1==_.keys(item.stats).length?(item.rolls=[item.stats],done()):getRolls(item,done)}})},reduceMaxSkill:function(type,buckets,items){var character=this;tgd.localLog("highest set is above max cap");var fullSets=[],alternatives=[];_.each(buckets,function(bucket){candidates=_.filter(items,function(item){return _.isObject(item.stats)&&item.bucketType==bucket&&item.equipRequiredLevel<=character.level()&&item.canEquip===!0&&(3!=item.classType&&tgd.DestinyClass[item.classType]==character.classType()||3===item.classType&&item.armorIndex>-1&&item.typeName.indexOf(character.classType())>-1||item.weaponIndex>-1||"Ghost"==item.bucketType)}),tgd.localLog("candidates considering "+candidates.length),_.each(candidates,function(candidate){candidate.stats[type]>0?fullSets.push([candidate]):alternatives.push([candidate])})}),tgd.localLog("full sets considering "+fullSets.length);var statAlternatives=_.flatten(fullSets);tgd.localLog("full sets considering "+fullSets.length),_.each(fullSets,function(set){var mainItem=set[0],currentStat=mainItem.stats[type];tgd.localLog(currentStat+" for main item: "+mainItem.description),_.each(buckets,function(bucket){if(bucket!=mainItem.bucketType)if(currentStat<tgd.DestinySkillCap){if(candidates=_.filter(statAlternatives,function(item){return item.bucketType==bucket&&(6!=item.tierType&&6==mainItem.tierType||6!=mainItem.tierType)}),candidates.length>0){primaryStats=_.map(candidates,function(item){return item.stats[type]}),tgd.localLog(bucket+" choices are "+primaryStats);var maxCandidateValue=_.max(primaryStats);maxCandidate=candidates[primaryStats.indexOf(maxCandidateValue)];var deltas={};_.each(candidates,function(candidate,index){tgd.localLog(candidate.description+" considering candidate currentStat "+candidate.stats[type]);var delta=currentStat+candidate.stats[type]-tgd.DestinySkillCap;if(delta>=0){var allStatsSummed=currentStat+candidate.getValue("All")-candidate.stats[type]-tgd.DestinySkillCap;allStatsSummed>=0&&(deltas[index]=allStatsSummed)}});var values=_.values(deltas),keys=_.keys(deltas);values.length>0&&(maxCandidate=candidates[keys[values.indexOf(_.min(values))]],tgd.localLog(" new max candidate is "+maxCandidate.description)),currentStat+=maxCandidate.stats[type],tgd.localLog("new currentStat is "+currentStat),set.push(maxCandidate)}}else tgd.localLog("adding alternative, maxCap is full on this set"),candidates=_.filter(alternatives,function(item){return item.bucketType==bucket}),candidates.length>0&&(primaryStats=_.map(candidates,function(item){return item.getValue("All")}),set.push(candidates[primaryStats.indexOf(_.max(primaryStats))]))})});var availableSets=[];_.map(fullSets,function(set){var sumSet=tgd.joinStats(set);sumSet[type]>=tgd.DestinySkillCap&&(availableSets.push({set:set,sumSet:sumSet}),tgd.localLog(sumSet))});var sumSetValues=_.sortBy(_.map(availableSets,function(combo){var score=tgd.sum(_.map(combo.sumSet,function(value,key){var result=Math.floor(value/tgd.DestinySkillTier);return result>5?5:result}));combo.sum=tgd.sum(_.values(combo.sumSet));var subScore=combo.sum/1e3;return combo.score=score+subScore,combo}),"score"),highestSetObj=sumSetValues[sumSetValues.length-1];return[highestSetObj.sum,highestSetObj.set]},findMaxLightSet:function(items,callback){var buckets=[].concat(tgd.DestinyArmorPieces),groups={},statGroups={},highestArmorTier=0,highestArmorValue=0,highestTierValue=0,character=this;tgd.maxTierPossible=Math.floor(tgd.sum(tgd.DestinyMaxCSP)/tgd.DestinySkillTier),tgd.maxTierPointsPossible=Math.floor(tgd.sum(tgd.DestinyMaxCSP)/tgd.DestinySkillTier)*tgd.DestinySkillTier,_.each(buckets,function(bucket){groups[bucket]=_.filter(items,function(item){return item.bucketType==bucket&&item.equipRequiredLevel<=character.level()&&item.canEquip===!0&&(3!=item.classType&&tgd.DestinyClass[item.classType]==character.classType()||3==item.classType&&item.armorIndex>-1&&item.typeName.indexOf(character.classType())>-1||item.weaponIndex>-1||"Ghost"==item.bucketType)});var csps=_.map(groups[bucket],function(item){return item.getValue("MaxLightCSP")});statGroups[bucket]={max:_.max(csps),min:_.min(csps)}}),highestArmorValue=tgd.sum(_.map(statGroups,function(stat){return stat.max})),console.log(statGroups),console.log("highestArmorValue:"+highestArmorValue),console.log(_.object(_.map(statGroups,function(stat,key){return[key,stat.max]}))),highestArmorTier=Math.floor(highestArmorValue/tgd.DestinySkillTier),console.log("highestArmorTier :"+highestArmorTier),highestTierValue=highestArmorTier*tgd.DestinySkillTier,console.log("highestTierValue :"+highestTierValue),groups=_.object(_.map(groups,function(items,bucketType){var minCSP=highestTierValue-(highestArmorValue-statGroups[bucketType].max);return[bucketType,_.sortBy(_.filter(items,function(item){return item.getValue("MaxLightCSP")>=minCSP}),function(item){return-1*item.getValue("MaxLightCSP")})]})),callback(groups)},findBestArmorSetV2:function(items,callback){$("body").css("cursor","progress");var candidates,buckets=[].concat(tgd.DestinyArmorPieces),sets=[],bestSets=[],backups=[],groups={},statGroups={},highestArmorTier=0,highestArmorValue=0,highestTierValue=0,character=this;setTimeout(function(){_.each(buckets,function(bucket){groups[bucket]=_.filter(items,function(item){return item.bucketType==bucket&&item.equipRequiredLevel<=character.level()&&item.canEquip===!0&&(3!=item.classType&&tgd.DestinyClass[item.classType]==character.classType()||3==item.classType&&item.armorIndex>-1&&item.typeName.indexOf(character.classType())>-1||item.weaponIndex>-1||"Ghost"==item.bucketType)});var csps=_.map(groups[bucket],function(item){return item.getValue("All")});statGroups[bucket]={max:_.max(csps),min:_.min(csps)}}),highestArmorValue=tgd.sum(_.map(statGroups,function(stat){return stat.max})),highestArmorTier=Math.floor(highestArmorValue/tgd.DestinySkillTier),highestTierValue=highestArmorTier*tgd.DestinySkillTier,_.each(groups,function(items,bucketType){var minCSP=highestTierValue-(highestArmorValue-statGroups[bucketType].max);candidates=_.filter(items,function(item){return item.getValue("All")>=minCSP}),_.each(candidates,function(candidate){sets.push([candidate])})}),backups=_.flatten(sets),_.each(sets,function(set){var mainPiece=set[0],arrRolls=_.map(mainPiece.rolls,function(roll){var mainClone=_.clone(mainPiece,!0),subSets=[[mainClone]];return mainClone.activeRoll=roll,mainClone.isActiveRoll=_.reduce(mainClone.stats,function(isActiveRoll,value,key){return isActiveRoll===!0&&(mainClone.activeRoll[key]||0)==value},!0),subSets});_.each(arrRolls,function(subSets){candidates=_.groupBy(_.filter(backups,function(item){return item.bucketType!=mainPiece.bucketType&&(6!=item.tierType&&6==mainPiece.tierType||6!=mainPiece.tierType)&&mainPiece._id!=item._id}),"bucketType"),_.each(candidates,function(items){subSets.push(items)});var combos=tgd.cartesianProductOf(subSets),scoredCombos=_.map(combos,function(items){var tmp=tgd.joinStats(items);return{set:items,score:tgd.sum(_.map(tmp,function(value,key){var result=Math.floor(value/tgd.DestinySkillTier);return result>5?5:result}))+tgd.sum(_.values(tmp))/1e3}}),highestScore=Math.floor(_.max(_.pluck(scoredCombos,"score")));_.each(scoredCombos,function(combo){combo.score>=highestScore&&bestSets.push(combo)})})});var highestFinalScore=Math.floor(_.max(_.pluck(bestSets,"score"))),lastSets=[];_.each(bestSets,function(combo){combo.score>=highestFinalScore&&lastSets.push(combo)}),callback(_.sortBy(lastSets,"score")),$("body").css("cursor","default")},600)},findHighestItemBy:function(type,buckets,items){var candidates,character=this,sets=[],backups=[],primaryStats={};_.each(buckets,function(bucket){candidates=_.filter(items,function(item){return item.bucketType==bucket&&item.equipRequiredLevel<=character.level()&&item.canEquip===!0&&(3!=item.classType&&tgd.DestinyClass[item.classType]==character.classType()||3==item.classType&&item.armorIndex>-1||item.weaponIndex>-1)&&("All"==type&&item.armorIndex>-1||"All"!=type)}),_.each(candidates,function(candidate){("Light"==type||"All"==type||"Light"!=type&&candidate.stats[type]>0)&&(6==candidate.tierType&&candidate.hasLifeExotic===!1?sets:backups)[candidate.isEquipped()?"unshift":"push"]([candidate])})}),backups=_.flatten(backups),_.each(_.groupBy(_.flatten(sets),"bucketType"),function(items,bucketType){primaryStats[bucketType]=_.max(_.map(items,function(item){return item.getValue(type)}))}),_.each(backups,function(spare){var maxCandidate=primaryStats[spare.bucketType]||0;maxCandidate<spare.getValue(type)&&sets.push([spare])}),_.each(sets,function(set){var main=set[0];_.each(buckets,function(bucket){if(bucket!=main.bucketType&&(candidates=_.where(backups,{bucketType:bucket}),tgd.localLog(candidates.length+" best candidate for bucket: "+bucket),candidates.length>0)){primaryStats=_.map(candidates,function(item){return item.getValue(type)});var maxCandidate=_.max(primaryStats),candidate=candidates[primaryStats.indexOf(maxCandidate)];set.push(candidate)}})});var sumSets=_.map(sets,function(set){return tgd.sum(_.map(set,function(item){return item.getValue(type)}))});return highestSetValue=_.max(sumSets),highestSet=_.sortBy(sets[sumSets.indexOf(highestSetValue)],function(item){return-1*item.tierType}),[highestSetValue,highestSet]},equipAction:function(type,highestSetValue,highestSet){var character=this;$.toaster({priority:"success",title:"Result",message:" The highest set available for "+type+"  is  "+highestSetValue,settings:{timeout:7e3}});var count=0,done=function(){if(count++,count==highestSet.length){var msa=adhoc.transfer(character.id,!0);tgd.localLog(msa),adhoc.swapItems(msa,character.id,function(){$.toaster({settings:{timeout:7e3},priority:"success",title:"Result",message:" Completed equipping the highest "+type+" set at "+highestSetValue}),character.statsShowing(!1)})}},adhoc=new tgd.Loadout;_.each(highestSet,function(candidate){var itemEquipped=character.itemEquipped(candidate.bucketType);if(itemEquipped&&itemEquipped._id&&itemEquipped._id!==candidate._id){var message;"Light"==type&&candidate.primaryStatValue()>itemEquipped.primaryStatValue()||"Light"!=type?(adhoc.addUniqueItem({id:candidate._id,bucketType:candidate.bucketType,doEquip:!0}),message=candidate.bucketType+" can have a better item with "+candidate.description,tgd.localLog(message)):message=candidate.description+" skipped because the equipped item ("+itemEquipped.description+") is equal or greater light",$.toaster({priority:"info",title:"Equip",message:message,settings:{timeout:tgd.defaults.toastTimeout}}),done()}else done()})},renderBestGroups:function(groups){console.log("renderBestGroups",groups);var id=(new Date).getTime(),$template=$(tgd.maxLightTemplates({id:id}));new tgd.dialog({buttons:[{label:app.activeText().movepopup_equip,action:function(dialog){}},{label:app.activeText().loadouts_save,action:function(dialog){}},{label:app.activeText().cancel,action:function(dialog){dialog.close()}}]}).title("Armor Builds for Max Light Level").content($template).show(!0,function(){groups=null},function(){var armorSelection=new tgd.ArmorSelection(groups);console.log(armorSelection),ko.applyBindings(armorSelection,document.getElementById("container_"+id))})},renderBestSets:function(type,bestSets){var character=this,weaponsEquipped=_.filter(character.equippedGear(),function(item){return item.weaponIndex>-1}),weaponTypes=_.map(app.weaponTypes(),function(type){return type.name.split(" ")[0]}).concat(tgd.DestinyWeaponPieces),highestTier=Math.floor(_.max(_.pluck(bestSets,"score"))),armorBuilds={},arrArmorBuilds=[];_.each(bestSets,function(combo){if(combo.score>=highestTier){var statTiers="",statValues="",stats=tgd.joinStats(combo.set),sortedKeys=_.sortBy(_.keys(stats));combo.stats=[],_.each(sortedKeys,function(name){statTiers=statTiers+" <strong>"+name.substring(0,3)+"</strong> T"+Math.floor(stats[name]/tgd.DestinySkillTier),statValues=statValues+stats[name]+"/",combo.stats.push(stats[name])}),combo.light=character.calculatePowerLevelWithItems(combo.set.concat(weaponsEquipped)),combo.statTiers=$.trim(statTiers),combo.statValues=statValues.substring(0,statValues.length-1),combo.perks=_.filter(_.flatten(_.map(combo.set,function(item){return _.map(item.perks,function(perk){return perk.bucketType=item.bucketType,perk})})),function(perk){return perk.active===!0&&"Class Items"!=perk.bucketType&&_.intersection(weaponTypes,perk.name.split(" ")).length>0||perk.active===!0&&"Helmet"==perk.bucketType&&-1==perk.isExclusive&&perk.isInherent===!1}),combo.similarityScore=_.values(_.countBy(_.map(_.filter(combo.perks,function(perk){return"Class Items"!=perk.bucketType&&"Helmet"!=perk.bucketType}),function(perk){return _.intersection(weaponTypes,perk.name.split(" "))[0]}))),combo.similarityScore=3/combo.similarityScore.length+tgd.sum(combo.similarityScore),combo.hash=_.pluck(_.sortBy(combo.set,"bucketType"),"_id").join(","),combo.id=tgd.hashCode(combo.statTiers),combo.statTiers in armorBuilds||(armorBuilds[combo.statTiers]=[]),armorBuilds[combo.statTiers].push(combo)}}),_.each(armorBuilds,function(statTiers,key){var newTiers=_.reduce(statTiers,function(memo,combo){return _.findWhere(memo,{hash:combo.hash})||memo.push(combo),memo},[]);arrArmorBuilds.push(_.first(_.sortBy(newTiers,function(combo){return[combo.similarityScore,combo.score]}).reverse(),200))}),armorBuilds={},arrArmorBuilds=_.sortBy(arrArmorBuilds,function(builds){return-1*_.max(_.pluck(builds,"similarityScore"))});var renderTemplate=function(builds){var _template=$(tgd.armorTemplates({builds:builds}));return _template.find(".itemImage,.perkImage").bind("error",function(){tgd.imageErrorHandler(this.src.replace(location.origin,"").replace("www/",""),this)()}),_template},assignBindingHandlers=function(){$("a.itemLink").each(function(){var element=$(this),itemId=element.attr("itemId"),instanceId=element.attr("instanceId");element.click(!1),Hammer(element[0],{time:2e3}).on("tap",function(ev){$ZamTooltips.lastElement=element,$ZamTooltips.show("destinydb","items",itemId,element)}).on("press",function(ev){arrArmorBuilds=_.map(_.filter(arrArmorBuilds,function(sets){return _.filter(sets,function(combos){return _.pluck(combos.set,"_id").indexOf(instanceId)>-1;
}).length>0}),function(sets){return _.filter(sets,function(combos){return _.pluck(combos.set,"_id").indexOf(instanceId)>-1})}),armorTemplateDialog.content(renderTemplate(arrArmorBuilds)),setTimeout(assignBindingHandlers,10)})}),$(".prevCombo").bind("click",function(){var currentRow=$(this).parents(".row"),currentId=currentRow.attr("id"),newId=currentId.split("_")[0]+"_"+(parseInt(currentId.split("_")[1])-1);currentRow.hide(),$("#"+newId).show()}),$(".nextCombo").bind("click",function(){var currentRow=$(this).parents(".row"),currentId=currentRow.attr("id"),newId=currentId.split("_")[0]+"_"+(parseInt(currentId.split("_")[1])+1);currentRow.hide(),$("#"+newId).show()})},$template=renderTemplate(arrArmorBuilds),armorTemplateDialog=new tgd.dialog({buttons:[{label:app.activeText().movepopup_equip,action:function(dialog){if(0===$("input.armorBuild:checked").length)BootstrapDialog.alert("Error: Please select one armor build to equip.");else{var selectedBuild=$("input.armorBuild:checked").val(),selectedStatTier=selectedBuild.split("_")[0],selectedIndex=selectedBuild.split("_")[1];highestCombo=_.filter(arrArmorBuilds,function(sets){return sets[0].statTiers==selectedStatTier})[0][selectedIndex],character.equipAction(type,highestCombo.score.toFixed(3),highestCombo.set),dialog.close()}}},{label:app.activeText().loadouts_save,action:function(dialog){if(0===$("input.armorBuild:checked").length)BootstrapDialog.alert("Error: Please select one armor build to equip.");else{var selectedBuild=$("input.armorBuild:checked").val(),selectedStatTier=selectedBuild.split("_")[0],selectedIndex=selectedBuild.split("_")[1];highestCombo=_.filter(arrArmorBuilds,function(sets){return sets[0].statTiers==selectedStatTier})[0][selectedIndex],app.createLoadout();var loadoutName=highestCombo.score+" "+$("<div></div>").html(highestCombo.statTiers).text();app.activeLoadout().name(loadoutName),_.each(highestCombo.set,function(item){app.activeLoadout().addUniqueItem({id:item._id,bucketType:item.bucketType,doEquip:!0})}),dialog.close()}}},{label:app.activeText().cancel,action:function(dialog){dialog.close()}}]}).title("Armor Build"+(arrArmorBuilds.length>1?"s":"")+" Found for Tier "+highestTier).content($template).show(!0,function(){armorBuilds=null,arrArmorBuilds=null},function(){assignBindingHandlers()})},equipBest:function(type,armor,items){var character=this,activeItems=_.filter(items,function(item){return item.armorIndex>-1&&("Ghost"==item.bucketType||"Ghost"!==item.bucketType&&item.characterId()==character.id)});"OptimizedBest"==type&&(activeItems=_.reduce(_.groupBy(activeItems,"bucketType"),function(memo,group){var sortedItems=_.sortBy(group,function(item){return-1*item.getValue("All")});return memo=memo.concat(_.first(sortedItems,3))},[])),"Best"==type||"OptimizedBest"==type?character.findBestArmorSetV2(activeItems,function(sets){character.renderBestSets(type,sets)}):"MaxLight"==type&&character.findMaxLightSet(activeItems,function(groups){character.renderBestGroups(groups)})},equipHighest:function(type){var character=this;return function(){if("Vault"!=character.id){var highestSet,highestSetValue,bestArmorSets,bestWeaponSets,armor=[].concat(tgd.DestinyArmorPieces),weapons=tgd.DestinyWeaponPieces,items=_.flatten(_.map(app.characters(),function(avatar){return avatar.items()}));"Best"==type||"OptimizedBest"==type||"MaxLight"==type?character.equipBest(type,armor,items):"Light"==type?(bestArmorSets=character.findHighestItemBy("Light",armor,items)[1],bestWeaponSets=character.findHighestItemBy("Light",weapons,items)[1],highestSet=bestArmorSets.concat(bestWeaponSets),highestSetValue=character.calculatePowerLevelWithItems(highestSet),character.equipAction(type,highestSetValue,highestSet)):"All"==type?(bestArmorSets=character.findHighestItemBy("All",armor,items),highestSet=bestArmorSets[1],highestSetValue=bestArmorSets[0],character.equipAction(type,highestSetValue,highestSet)):(bestArmorSets=character.findHighestItemBy(type,armor,items),bestArmorSets[0]<tgd.DestinySkillCap?(highestSetValue=bestArmorSets[0],highestSet=bestArmorSets[1]):(bestArmorSets=character.reduceMaxSkill(type,armor,items),highestSetValue=bestArmorSets[0],highestSet=bestArmorSets[1]),character.equipAction(type,highestSetValue,highestSet))}}}},window.Hammer.Tap.prototype.defaults.threshold=9;var app=function(){var self=this;this.loadingUser=ko.observable(!1),this.hiddenWindowOpen=ko.observable(!1),this.loadoutMode=ko.observable(!1),this.destinyDbMode=ko.observable(!1),this.dynamicMode=ko.observable(!1),this.viewOptionsEnabled=ko.observable(!1),this.activeLoadout=ko.observable(new tgd.Loadout),this.loadouts=ko.observableArray(),this.searchKeyword=ko.observable(tgd.defaults.searchKeyword),this.preferredSystem=ko.pureComputed(new tgd.StoreObj("preferredSystem")),this.appLocale=ko.pureComputed(new tgd.StoreObj("appLocale")),this.locale=ko.pureComputed(new tgd.StoreObj("locale")),this.layoutMode=ko.pureComputed(new tgd.StoreObj("layoutMode")),this.ccWidth=ko.pureComputed(new tgd.StoreObj("ccWidth")),this.vaultColumns=ko.pureComputed(new tgd.StoreObj("vaultColumns")),this.vaultWidth=ko.pureComputed(new tgd.StoreObj("vaultWidth")),this.vaultPos=ko.pureComputed(new tgd.StoreObj("vaultPos")),this.xsColumn=ko.pureComputed(new tgd.StoreObj("xsColumn")),this.smColumn=ko.pureComputed(new tgd.StoreObj("smColumn")),this.mdColumn=ko.pureComputed(new tgd.StoreObj("mdColumn")),this.lgColumn=ko.pureComputed(new tgd.StoreObj("lgColumn")),this.activeView=ko.pureComputed(new tgd.StoreObj("activeView")),this.activeSort=ko.pureComputed(new tgd.StoreObj("activeSort")),this.autoUpdates=ko.pureComputed(new tgd.StoreObj("autoUpdates","true")),this.doRefresh=ko.pureComputed(new tgd.StoreObj("doRefresh","true")),this.autoXferStacks=ko.pureComputed(new tgd.StoreObj("autoXferStacks","true")),this.padBucketHeight=ko.pureComputed(new tgd.StoreObj("padBucketHeight","true")),this.dragAndDrop=ko.pureComputed(new tgd.StoreObj("dragAndDrop","true")),this.farmViewEnabled=ko.pureComputed(new tgd.StoreObj("farmViewEnabled","true")),this.farmMode=ko.pureComputed(new tgd.StoreObj("farmMode","true")),this.farmTarget=ko.pureComputed(new tgd.StoreObj("farmTarget")),this.farmItems=ko.observableArray(),this.farmItemCounts=ko.observable({}),this.advancedTooltips=ko.pureComputed(new tgd.StoreObj("advancedTooltips","true")),this.sectionsTemplate=ko.pureComputed(new tgd.StoreObj("sectionsTemplate")),this.tooltipsEnabled=ko.pureComputed(new tgd.StoreObj("tooltipsEnabled","true",function(newValue){$ZamTooltips.isEnabled=newValue})),this.refreshSeconds=ko.pureComputed(new tgd.StoreObj("refreshSeconds")),this.tierFilter=ko.pureComputed(new tgd.StoreObj("tierFilter")),this.weaponFilter=ko.observable(tgd.defaults.weaponFilter),this.armorFilter=ko.observable(tgd.defaults.armorFilter),this.generalFilter=ko.observable(tgd.defaults.generalFilter),this.dmgFilter=ko.observableArray(tgd.defaults.dmgFilter),this.progressFilter=ko.observable(tgd.defaults.progressFilter),this.setFilter=ko.observableArray(tgd.defaults.setFilter),this.activeClasses=ko.observableArray(tgd.defaults.activeClasses),this.shareView=ko.observable(tgd.defaults.shareView),this.shareUrl=ko.observable(tgd.defaults.shareUrl),this.showMissing=ko.observable(tgd.defaults.showMissing),this.customFilter=ko.observable(tgd.defaults.customFilter),this.showDuplicate=ko.observable(tgd.defaults.showDuplicate),this.showArmorSC=ko.observable(tgd.defaults.showArmorSC),this.showArmorPerks=ko.observable(tgd.defaults.showArmorPerks),this.armorViewBy=ko.observable(tgd.defaults.armorViewBy),this.sortedLoadouts=ko.pureComputed(function(){return self.loadouts().sort(function(left,right){return left.name==right.name?0:left.name<right.name?-1:1})}),this.activeItem=ko.observable(),this.activeUser=ko.observable({}),this.allLayouts=ko.observableArray().extend({rateLimit:{timeout:1e3,method:"notifyWhenChangesStop"}}),this.activeLayouts=ko.pureComputed(function(){return _.filter(self.allLayouts(),function(layout){return self.activeView()==layout.id||"0"==self.activeView()})}),this.tierTypes=ko.observableArray(),this.weaponTypes=ko.observableArray(),this.characters=ko.observableArray().extend({rateLimit:{timeout:1e3,method:"notifyWhenChangesStop"}}),this.orderedCharacters=ko.pureComputed(function(){return self.characters().sort(function(a,b){return a.order()-b.order()})}),this.currentLocale=ko.computed(function(){var locale=self.locale();return""!==self.appLocale()&&(locale=self.appLocale()),locale}),this.activeText=ko.pureComputed(function(){return tgd.locale[self.currentLocale()]}),this.createLoadout=function(){self.loadoutMode(!0),self.activeLoadout(new tgd.Loadout)},this.cancelLoadout=function(){self.loadoutMode(!1),self.dynamicMode(!1),self.activeLoadout(new tgd.Loadout)},this.startMultiSelect=function(){self.dynamicMode(!0),self.createLoadout()},this.showFarmHelp=function(){(new tgd.dialog).title(self.activeText().menu_help+" for Farm Mode").content(tgd.farmhelpTemplate()).show()},this.showHelp=function(){self.toggleBootstrapMenu(),(new tgd.dialog).title(self.activeText().menu_hel).content(tgd.helpTemplate()).show()},this.showLanguageSettings=function(){self.toggleBootstrapMenu(),new tgd.dialog({message:tgd.languagesTemplate({locale:self.currentLocale(),languages:tgd.languages})}).title(self.activeText().menu_language).show(!0,_.noop,function(){tgd.localLog("showed modal"),$(".btn-setLanguage").on("click",function(){self.appLocale(this.value),self.autoUpdates(!0),tgd.checkUpdates(),BootstrapDialog.alert("Downloading updated language files"),$(".btn-setLanguage").removeClass("btn-primary"),$(this).addClass("btn-primary")})})},this.handleGoogleResponse=function(data){data&&data.response?data.response.errorType?BootstrapDialog.alert("Error: "+data.response.errorType):data.response.orderId?BootstrapDialog.alert("Donation accepted Ref# "+data.response.orderId):BootstrapDialog.alert("Unknown error has occurred"):BootstrapDialog.alert("No response returned")},this.showDonate=function(){self.toggleBootstrapMenu(),(new tgd.dialog).title(self.activeText().donation_title).content(tgd.donateTemplate()).show(!0,_.noop,function(){$("a.donatePaypal").click(function(){return window.open("https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=XGW27FTAXSY62&lc="+self.activeText().paypal_code+"&no_note=1&no_shipping=1&currency_code=USD",tgd.openTabAs),!1}),$("div.supportsIAB").toggle(isChrome===!0||isAndroid===!0||isIOS===!0),$("div.chromeWallet").toggle(isChrome===!0),$("div.googlePlay").toggle(isAndroid===!0),$("div.appleIAP").toggle(isIOS===!0),$("a.donate").bind("click",function(){isChrome?google.payments.inapp.buy({parameters:{env:"prod"},sku:$(this).attr("sku"),success:self.handleGoogleResponse,failure:self.handleGoogleResponse}):(isAndroid||isIOS)&&inappbilling.buy(function(){BootstrapDialog.alert("Donation accepted, thank you for your support")},_.noop,$(this).attr("sku"))})})},this.showAbout=function(){self.toggleBootstrapMenu(),(new tgd.dialog).title(self.activeText().menu_about).content(tgd.aboutTemplate()).show()},this.clearFilters=function(model,element){return self.toggleBootstrapMenu(),self.activeView(tgd.defaults.activeView),self.searchKeyword(tgd.defaults.searchKeyword),self.refreshSeconds(tgd.defaults.refreshSeconds),self.tierFilter(tgd.defaults.tierFilter),self.weaponFilter(tgd.defaults.weaponFilter),self.armorFilter(tgd.defaults.armorFilter),self.generalFilter(tgd.defaults.generalFilter),self.dmgFilter([]),self.progressFilter(tgd.defaults.progressFilter),self.setFilter([]),self.shareView(tgd.defaults.shareView),self.shareUrl(tgd.defaults.shareUrl),self.showMissing(tgd.defaults.showMissing),self.showDuplicate(tgd.defaults.showDuplicate),self.customFilter(tgd.defaults.customFilter),self.showArmorPerks(tgd.defaults.showArmorPerks),self.armorViewBy(tgd.defaults.armorViewBy),$(element.target).removeClass("active"),!1},this.renderCallback=function(context,content,element,callback){element&&(lastElement=element),content=content.replace(/(<img\ssrc=")(.*?)("\s?>)/g,"");var activeItem,query,instanceId=$(lastElement).attr("instanceId"),$content=$("<div>"+content+"</div>");if(instanceId>0)query={_id:instanceId};else{var id=$(lastElement).attr("href");query={id:parseInt(id.split("/")[id.split("/").length-1])}}if(self.characters().forEach(function(character){var item=_.findWhere(character.items(),query);item&&(activeItem=item)}),activeItem){if($content.find("h2.destt-has-icon").text(activeItem.description),tgd.DestinyGeneralItems["Glimmer Credit"].indexOf(activeItem.id)>-1&&$content.find("div.destt-info span").after(" valued at "+200*activeItem.primaryStat()+"G"),activeItem.equipRequiredLevel){var classType=3==activeItem.classType?"":" for  "+tgd.DestinyClass[activeItem.classType];$content.find(".destt-required-level").remove(),$content.find(".destt-title").after('<span class="destt-info" style="float:right;">Required Level: <span>'+activeItem.equipRequiredLevel+classType+"</span></span>")}$content.find("h3.destt-has-icon").text(activeItem.typeName);var primaryStatMin=$content.find(".destt-primary-min");if(0===primaryStatMin.length&&(activeItem.armorIndex>-1||activeItem.weaponIndex>-1)&&""!==activeItem.primaryStat()){var statType=activeItem.armorIndex>-1?"DEFENSE":"ATTACK",statBlock='<div class="destt-primary"><div class="destt-primary-min">'+activeItem.primaryStat()+'</div><div class="destt-primary-max destt-primary-no-max">'+statType+"</div></div>";$content.find(".destt-desc").before(statBlock)}else primaryStatMin.html(activeItem.primaryStat());if($content.find(".destt-desc").text(activeItem.itemDescription),$content.find(".fhtt-emblem").length>0&&$content.find("span").remove(),$content.find(".fhtt-emblem-icon").length>0&&$content.find(".fhtt-emblem-icon").html($("<img>").attr("src",activeItem.icon)),0===$content.find("[class*='destt-damage-color-']").length&&activeItem.damageType>1){var burnIcon=$("<div></div>").addClass("destt-primary-damage-"+activeItem.damageType);$content.find(".destt-primary").addClass("destt-damage-color-"+activeItem.damageType).prepend(burnIcon)}if(!_.isEmpty(activeItem.stats)){var stats=$content.find(".destt-stat");0===stats.length&&($content.find(".destt-desc").after(tgd.statsTemplate({stats:activeItem.stats})),stats=$content.find(".destt-stat"));var itemStats,itemDef=_itemDefs[activeItem.id];if(itemDef&&itemDef.stats&&(itemStats=_.map(itemDef.stats,function(obj,key){return obj.name=_statDefs[key].statName,obj})),stats.html(stats.find(".stat-bar").map(function(index,stat){var $stat=$("<div>"+stat.outerHTML+"</div>"),label=$stat.find(".stat-bar-label"),labelText=$.trim(label.text());if(labelText in activeItem.stats){var newLabelText,armoryLabelText,ddbLabelText;label.text(labelText+": "+activeItem.stats[labelText]);var statObj=_.findWhere(itemStats,{name:labelText});if(statObj&&statObj.minimum&&statObj.maximum&&statObj.minimum>0&&statObj.maximum>0&&(armoryLabelText=statObj.minimum+"/"+statObj.maximum),"block"==$stat.find(".stat-bar-static-value").css("display"))ddbLabelText=$.trim($stat.find(".stat-bar-static-value").text().replace(/ /g,"")),newLabelText=ddbLabelText.indexOf("/")>-1&&ddbLabelText!=armoryLabelText||-1==ddbLabelText.indexOf("/")&&ddbLabelText>0&&armoryLabelText.split("/")[0]!=ddbLabelText&&armoryLabelText.split("/")[1]!=ddbLabelText?"D:"+ddbLabelText+" A:"+armoryLabelText:-1==ddbLabelText.indexOf("/")?"Min/Max: "+armoryLabelText:"Min/Max: "+ddbLabelText,$stat.find(".stat-bar-static-value").text(newLabelText);else{var ddbLabelText=($stat.find(".stat-bar-empty").html(),$.trim($stat.find(".stat-bar-value").text().replace(/ /g,"")));newLabelText=ddbLabelText.indexOf("/")>-1&&ddbLabelText!=armoryLabelText?"D:"+ddbLabelText+" A:"+armoryLabelText:"Min/Max: "+armoryLabelText,$stat.find(".stat-bar-empty").html($("<div><div></div></div>").find("div").addClass("stat-bar-minmax").text(newLabelText).parent().html()+$stat.find(".stat-bar-empty").html())}}return $stat.html()}).get().join("")),self.advancedTooltips()===!0&&itemStats){var magazineRow=stats.find(".stat-bar:last");if(activeItem.weaponIndex>-1){var desireableStats=["Aim assistance","Equip Speed","Recoil direction","Inventory Size"];_.each(desireableStats,function(statName){var statObj=_.findWhere(itemStats,{name:statName});if(statObj){var clonedRow=magazineRow.clone();if("Inventory Size"==statName&&"Rocket Launcher"==activeItem.typeName){var chest=activeItem.character.itemEquipped("Chest"),boots=activeItem.character.itemEquipped("Boots"),rocketsAvailable=2,inventorySize=statObj.value,magazineSize=activeItem.stats.Magazine;_.findWhere(activeItem.perks,{name:"Tripod",active:!0})&&(magazineSize=3),_.findWhere(activeItem.perks,{name:"Field Scout",active:!0})&&(inventorySize+=50),chest&&chest.perks&&(_.findWhere(boots.perks,{hash:3129120313,active:!0})&&(inventorySize+=10),(_.findWhere(chest.perks,{hash:2426858846,active:!0})||_.findWhere(boots.perks,{hash:2426858846,active:!0}))&&(inventorySize+=100)),inventorySize>=30&&60>=inventorySize?rocketsAvailable=Math.max(magazineSize,2):inventorySize>=70&&120>=inventorySize?rocketsAvailable=Math.max(magazineSize+1,3):inventorySize>=130&&(rocketsAvailable=Math.max(magazineSize+2,4)),clonedRow.find(".stat-bar-label").html("Rockets: "+inventorySize),clonedRow.find(".stat-bar-static-value").html("PVP: "+rocketsAvailable),magazineRow.before(clonedRow)}else if("Inventory Size"!==statName){var label=statObj.name;"Recoil direction"==statName?label="Recoil":"Aim assistance"==statName&&(label="Aim Assist"),clonedRow.find(".stat-bar-label").html(label+":"+statObj.value),statObj.minimum>0&&statObj.maximum>0&&clonedRow.find(".stat-bar-static-value").html("Min/Max : "+statObj.minimum+"/"+statObj.maximum),magazineRow.before(clonedRow)}}})}else if(activeItem.armorIndex>-1){var clonedRow=magazineRow.clone(),maxLightLevel=tgd.DestinyLightCap,isItemLeveled=activeItem.hasUnlockedStats,itemCSP=activeItem.getValue("All"),maxBonusPoints=tgd.bonusStatPoints(activeItem.armorIndex,maxLightLevel),currentBonusPoints=tgd.bonusStatPoints(activeItem.armorIndex,activeItem.primaryValues.Default),currentBaseStat=itemCSP-(isItemLeveled?currentBonusPoints:0);isItemLeveled||(itemCSP=itemCSP+"("+(itemCSP+currentBonusPoints)+")");var maxBaseStat=tgd.calculateStatRoll(activeItem,maxLightLevel,!1),maxStatRoll=tgd.DestinyMaxCSP[activeItem.bucketType]-maxBonusPoints,maxRollStats=(currentBaseStat/maxStatRoll*100).toFixed(0)+"%-"+(maxBaseStat/maxStatRoll*100).toFixed(0)+"%",statDetails=maxRollStats+" ("+Math.floor(maxBaseStat+maxBonusPoints)+"/"+Math.floor(maxStatRoll+maxBonusPoints)+")";clonedRow.find(".stat-bar-label").html("Stat Roll : "+itemCSP),clonedRow.find(".stat-bar-value, .stat-bar-empty").hide(),clonedRow.find(".stat-bar-static-value").show().html(statDetails),magazineRow.after(clonedRow)}}}if(activeItem.perks.length>0){var activePerksTemplate=tgd.perksTemplate({perks:_.filter(activeItem.perks,function(perk){var hasStat=_.has(perk,"isStat");return perk.active===!0&&0==hasStat||perk.active===!1&&self.advancedTooltips()===!0&&0==hasStat||1==hasStat&&0==perk.isStat})}),weaponTypes=_.pluck(app.weaponTypes(),"name");weaponTypes.indexOf(activeItem.typeName)>-1?1==$content.find(".destt-talent").length&&$content.find(".destt-talent-description").text().indexOf("Year 1")?$content.find(".destt-talent").replaceWith(activePerksTemplate):0===$content.find(".destt-talent").length&&$content.find(".destt-stat").after(activePerksTemplate):activeItem.armorIndex>-1&&($content.find(".destt-talent").length>0?$content.find(".destt-talent").replaceWith(activePerksTemplate):$content.find(".destt-stat").after(activePerksTemplate)),$content.find("img").bind("error",function(){var perkName=$(this).attr("data-name"),src=_.findWhere(activeItem.perks,{name:perkName}).iconPath,element=$('img[data-name="'+perkName+'"]')[0];tgd.imageErrorHandler(src,element)()})}activeItem.objectives&&activeItem.objectives.length>0&&_.each(activeItem.objectives,function(objective){var info=_objectiveDefs[objective.objectiveHash],label="",value=0;info.displayDescription&&(label="<strong>"+info.displayDescription+"</strong>:"),info&&info.completionValue&&(value=Math.floor(objective.progress/info.completionValue*100)+"% ("+objective.progress+"/"+info.completionValue+")"),$content.find(".destt-desc").after(label+value+"<br>")})}var width=$(window).width();340>width&&($content.find(".fhtt.des").css("width",width-15+"px"),$content.find(".stat-bar-empty").css("width","125px")),callback($content.html())},this.toggleAutoUpdates=function(){self.toggleBootstrapMenu(),self.autoUpdates(!self.autoUpdates()),self.autoUpdates()?tgd.checkUpdates():(localStorage.setItem("manifest",null),localStorage.setItem("last_update_files",null),tgd.loader.reset())},this.toggleViewOptions=function(){self.toggleBootstrapMenu(),self.viewOptionsEnabled(!self.viewOptionsEnabled()),self.viewOptionsEnabled()?($(".character").css("margin","auto"),$(".character-box").css("position","relative")):($(".character").css("margin",""),$(".character-box").css("position","fixed"))},this.toggleRefresh=function(){self.toggleBootstrapMenu(),self.doRefresh(!self.doRefresh())},this.togglePadBucketHeight=function(){self.toggleBootstrapMenu(),self.padBucketHeight(!self.padBucketHeight()),self.redraw()},this.toggleDragAndDrop=function(){self.toggleBootstrapMenu(),self.dragAndDrop(!self.dragAndDrop()),self.dragAndDrop()===!0&&(self.padBucketHeight(!0),location.reload())},this.toggleFarmMode=function(){self.farmViewEnabled(!self.farmViewEnabled())},this.toggleTransferStacks=function(){self.toggleBootstrapMenu(),self.autoXferStacks(!self.autoXferStacks())},this.toggleDestinyDbMode=function(){self.toggleBootstrapMenu(),self.destinyDbMode(!self.destinyDbMode())},this.toggleDestinyDbTooltips=function(){self.toggleBootstrapMenu(),self.tooltipsEnabled(!self.tooltipsEnabled())},this.toggleAdvancedTooltips=function(){self.toggleBootstrapMenu(),self.advancedTooltips(!self.advancedTooltips())},this.toggleShareView=function(){if(self.toggleBootstrapMenu(),!self.shareView()){var username=self.preferredSystem().toLowerCase()+"/"+self.bungie.gamertag();self.shareUrl(tgd.remoteServer+"/share/?"+username),self.apiRequest({action:"save_inventory",username:username,data:self.generateStatic()},function(){self.shareView(!self.shareView())})}},this.toggleDuplicates=function(model,event){if(self.toggleBootstrapMenu(),self.showDuplicate(!self.showDuplicate()),self.customFilter(self.showDuplicate()),self.showDuplicate()){var items=_.flatten(_.map(app.characters(),function(avatar){return avatar.items()})),ids=_.pluck(items,"id");_.each(items,function(item){var itemCount=_.filter(ids,function(id){return id==item.id}).length;item.isFiltered(itemCount>1)})}},this.toggleArmorPerks=function(){self.toggleBootstrapMenu(),self.showArmorPerks(!self.showArmorPerks()),self.customFilter(self.showArmorPerks()),self.showArmorPerks()&&(self.activeView(2),_.each(app.characters(),function(character){var weaponsEquipped=_.filter(character.weapons(),function(item){return item.isEquipped()}),weaponTypes=_.map(weaponsEquipped,function(item){return item&&item.typeName&&item.typeName.split(" ")[0]});_.each(character.armor(),function(item){var itemPerks=_.pluck(item.perks,"name"),matches=_.filter(itemPerks,function(perk){return _.filter(perk.split(" "),function(name){return weaponTypes.indexOf(name)>-1}).length>0});item.isFiltered(matches.length>0)})}))},this.toggleArmorSC=function(){self.toggleBootstrapMenu(),self.showArmorSC(!self.showArmorSC()),self.customFilter(self.showArmorSC()),self.showArmorSC()&&(self.activeView(2),_.each(app.characters(),function(character){var damagedBasedSubclass=_.filter(character.items(),function(item){return item.bucketType.indexOf("Subclasses")>-1&&item.isEquipped()===!0});damagedBasedSubclass.length>0&&(damagedBasedSubclass=damagedBasedSubclass[0].damageTypeName,_.each(character.armor(),function(item){var itemPerks=_.pluck(item.perks,"name"),matches=_.filter(itemPerks,function(perk){return _.filter(perk.split(" "),function(name){return damagedBasedSubclass.indexOf(name)>-1}).length>0});item.isFiltered(matches.length>0)}))}))},this.toggleArmorClass=function(){var classType=this.toString();if(self.toggleBootstrapMenu(),self.activeClasses[-1==self.activeClasses().indexOf(classType)?"push":"remove"](classType),self.customFilter(self.activeClasses().length>0),self.customFilter()){self.activeView(2);var classTypeNums=_.map(self.activeClasses(),function(className){return _.values(tgd.DestinyClass).indexOf(className)});_.each(app.characters(),function(character){_.each(character.armor(),function(item){item.isFiltered(classTypeNums.indexOf(item.classType)>-1)})})}},this.showArmorClass=function(classType){return self.activeClasses().indexOf(classType)>-1},this.toggleShowMissing=function(){self.toggleBootstrapMenu(),0===self.setFilter().length?$.toaster({priority:"danger",title:"Warning",message:self.activeText().pick_a_set,settings:{timeout:tgd.defaults.toastTimeout}}):self.showMissing(!self.showMissing())},this.openStatusReport=function(type){return function(){self.toggleBootstrapMenu();var sReportURL,prefSystem=self.preferredSystem().toLowerCase(),info=self.bungie.systemIds[prefSystem];return 1===type?sReportURL="http://destinystatus.com/"+prefSystem+"/"+info.id:2===type?sReportURL="http://my.destinytrialsreport.com/"+("xbl"==prefSystem?"xbox":"ps")+"/"+info.id:3===type?sReportURL="http://destinytracker.com/destiny/player/"+("xbl"==prefSystem?"xbox":"ps")+"/"+info.id:4===type&&(sReportURL="http://guardian.gg/en/profile/"+info.type+"/"+info.id),window.open(sReportURL,tgd.openTabAs),!1}},this.setArmorView=function(){var type=this.toString();self.armorViewBy(type)},this.setVaultColumns=function(){var columns=this.toString();self.vaultColumns(columns),self.redraw()},this.setVaultWidth=function(){var width=this.toString();self.vaultWidth(width),self.redraw()},this.setCCWidth=function(model,evt){var width=$(evt.target).text();width="Default"==width?"":width,self.ccWidth(width),self.redraw()},this._setSetFilter=function(collection){self.toggleBootstrapMenu(),collection in _collections||"All"==collection?(("Year 2 Items"==collection||"Year 1 Items"==collection)&&(_collections[collection]=_.pluck(_.filter(_.flatten(_.map(app.characters(),function(character){return character.items()})),function(item){return"Year 2 Items"==collection?item.primaryStatValue()>tgd.DestinyY1Cap||_collections[collection].indexOf(item.id)>-1:item.primaryStatValue()<=tgd.DestinyY1Cap&&-1==_collections["Year 2 Items"].indexOf(item.id)}),"id")),self.setFilter("All"==collection?[]:_collections[collection]),"All"==collection?self.showMissing(!1):collection.indexOf("Weapons")>-1?(self.activeView(1),self.armorFilter(0),self.generalFilter(0)):collection.indexOf("Armor")>-1&&(self.activeView(2),self.weaponFilter(0),self.generalFilter(0))):(self.setFilter([]),self.showMissing(!1))},this.setSetFilter=function(collection){return this._setSetFilter},this.setViewFormat=function(model,event){self.toggleBootstrapMenu(),self.sectionsTemplate($(event.target).closest("li").attr("value"))},this.setSort=function(model,event){self.toggleBootstrapMenu(),self.activeSort($(event.target).closest("li").attr("value"))},this.setView=function(model,event){self.toggleBootstrapMenu(),self.activeView($(event.target).closest("li").attr("value"))},this.setDmgFilter=function(){self.toggleBootstrapMenu();var dmgType=this.toString();-1==self.dmgFilter.indexOf(dmgType)?self.dmgFilter.push(dmgType):self.dmgFilter.remove(dmgType)},this.setTierFilter=function(){var tier=this.toString();self.toggleBootstrapMenu(),self.tierFilter(tier)},this._setWeaponFilter=function(weaponType){self.toggleBootstrapMenu(),self.activeView(1);var type=weaponType.name;tgd.localLog("weapon type: "+type),self.weaponFilter(type)},this.setWeaponFilter=function(weaponType){return this._setWeaponFilter},this._setArmorFilter=function(){self.toggleBootstrapMenu(),self.activeView(2);var armorType=this;tgd.localLog("armor type: "+armorType),self.armorFilter(armorType)},this.setArmorFilter=function(armorType){return this._setArmorFilter.bind(armorType)},this.setGeneralFilter=function(){var searchType=this.toString();self.toggleBootstrapMenu(),"Engrams"!=searchType&&self.activeView(3),self.generalFilter(searchType)},this.setProgressFilter=function(model,event){self.toggleBootstrapMenu(),self.progressFilter($(event.target).closest("li").attr("value"))},this.missingSets=ko.pureComputed(function(){var allItemNames=_.pluck(_.flatten(_.map(self.characters(),function(character){return character.items()})),"description"),armorFilter=ko.unwrap(self.armorFilter),weaponFilter=ko.unwrap(self.weaponFilter),missingIds=_.filter(self.setFilter(),function(id){var isMissing=!0,isVisible=!1;if(id in _itemDefs){var info=_itemDefs[id],description=decodeURIComponent(info.itemName);if(isMissing=-1==allItemNames.indexOf(description),info.bucketTypeHash in tgd.DestinyBucketTypes){var bucketType=tgd.DestinyBucketTypes[info.bucketTypeHash],typeName=decodeURIComponent(info.itemTypeName);isVisible=!(0!==self.armorFilter()&&armorFilter!=bucketType||0!==self.weaponFilter()&&weaponFilter!=typeName)}}return isMissing&&isVisible});return missingIds}),this.addWeaponTypes=function(weapons){weapons.forEach(function(item){item.isEquipment===!0&&item.type>1&&0===_.where(self.weaponTypes(),{name:item.typeName}).length&&self.weaponTypes.push({name:item.typeName,type:item.type})})},this.addTierTypes=function(items){items.forEach(function(item){item.tierTypeName&&item.tierType>0&&0===_.where(self.tierTypes(),{name:item.tierTypeName}).length&&self.tierTypes.push({name:item.tierTypeName,tier:item.tierType})})},this.makeBackgroundUrl=function(path,excludeDomain){return'url("'+(excludeDomain?"":self.bungie.getUrl())+path+'")'},this.hasBothAccounts=function(){return!_.isEmpty(self.activeUser().psnId)&&!_.isEmpty(self.activeUser().gamerTag)},this.useXboxAccount=function(){self.toggleBootstrapMenu(),self.preferredSystem("XBL"),self.characters.removeAll(),self.loadingUser(!0),self.search()},this.usePlaystationAccount=function(){self.toggleBootstrapMenu(),self.preferredSystem("PSN"),self.characters.removeAll(),self.loadingUser(!0),self.search()},this.redraw=function(){setTimeout(self.bucketSizeHandler,1e3),setTimeout(self.quickIconHighlighter,1e3)};var loadingData=!1;this.search=function(){function done(profile){profiles.push(profile),count++,count==total&&(self.characters(profiles),self.tierTypes.sort(function(a,b){return a.tier-b.tier}),self.weaponTypes.sort(function(a,b){return a.name>b.name?1:a.name<b.name?-1:0}),loadingData=!1,self.loadingUser(!1),$ZamTooltips.init(),setTimeout(function(){self.loadLoadouts()},5e3),self.farmModeHandler(self.farmMode()))}if("user"in self.activeUser()&&loadingData!==!0){loadingData=!0;var total=0,count=0,profiles=[];self.bungie.search(self.preferredSystem(),function(e){if(e&&e.error||!e)return loadingData=!1,self.loadingUser(!1),self.preferredSystem("PSN"==self.preferredSystem()?"XBL":"PSN"),void self.search();if("undefined"==typeof e.data)return e&&"undefined"!=typeof e.Message?BootstrapDialog.alert(e.Message):BootstrapDialog.alert("Code 10: "+self.activeText().error_loading_inventory+JSON.stringify(e));var avatars=e.data.characters,characterIds=_.sortBy(_.map(avatars,function(character){return character.characterBase.characterId})),items=self.bungie.flattenItemArray(e.data.inventory.buckets),vaultItems=_.where(items,function(item){return"Invisible"!=item.bucketName}),globalItems=_.where(items,{bucketName:"Invisible"});_.each(avatars,function(avatar){avatar.index=characterIds.indexOf(avatar.characterBase.characterId)+1,avatar.items=globalItems}),avatars.push({characterBase:{characterId:"Vault"},items:vaultItems,index:parseInt(self.vaultPos())}),total=avatars.length,_.map(avatars,function(avatar){var profile=new Profile(avatar);done(profile)})})}},this.loadData=function(ref){(self.loadingUser()===!1||self.hiddenWindowOpen()===!0)&&(self.loadingUser(!0),self.bungie=new tgd.bungie(self.bungie_cookies,function(){self.characters.removeAll(),self.bungie.user(function(user){
return user.error?"network error:502"==user.error?self.logout():void(isMobile?self.hiddenWindowOpen()===!1?(self.hiddenWindowOpen(!0),self.openHiddenBungieWindow()):setTimeout(function(){self.loadData(ref)},1e3):(self.activeUser(user),self.loadingUser(!1))):(ref&&ref.close&&(ref.close(),self.hiddenWindowOpen(!1),ref=null),self.activeUser(user),user.psnId&&user.gamerTag&&($.toaster({settings:{timeout:1e4},priority:"info",title:"Info",message:"Currently using "+self.preferredSystem()+", <br><a href='' id='useOtherAccount'>click here to use "+("XBL"==self.preferredSystem()?"PSN":"XBL")+"</a>"}),$("#useOtherAccount").click(function(){"XBL"==self.preferredSystem()?self.usePlaystationAccount():self.useXboxAccount()})),self.locale(self.activeUser().user.locale),self.loadingUser(!1),void _.defer(function(){self.search()}))})}))},this.toggleBootstrapMenu=function(){$(".navbar-toggle").is(":visible")&&$(".navbar-toggle").click()},this.refreshButton=function(){self.toggleBootstrapMenu(),self.refresh()},this.logout=function(){self.clearCookies(),self.bungie.logout(function(){window.location.reload()})},this.refresh=function(){if(self.bungie.gamertag()){var count=0,finish=function(){count++,count==self.characters().length&&$.toaster({priority:"success",title:"Success",message:"All the inventory has been updated.",settings:{timeout:tgd.defaults.toastTimeout}})};self.bungie.account(function(result){if(result&&result.data&&result.data.characters){var characters=result.data.characters;_.each(self.characters(),function(character){if("Vault"!=character.id){var result=_.filter(characters,function(avatar){return avatar.characterBase.characterId==character.id})[0];character.updateCharacter(result)}character._reloadBucket(character,void 0,finish,!0)})}else tgd.localLog(result)})}},this.refreshHandler=function(){clearInterval(self.refreshInterval),self.loadoutMode()===!0?(self.dynamicMode()===!1&&self.toggleBootstrapMenu(),$("body").css("padding-bottom","260px")):$("body").css("padding-bottom","80px"),self.doRefresh()===!0&&self.loadoutMode()===!1&&(tgd.localLog("refresh handler enabled"),self.refreshInterval=setInterval(function(){tgd.localLog("refreshing"),self.refresh(),tgd.autoRefreshTime=(new Date).getTime()},1e3*self.refreshSeconds()))},this.bucketSizeHandler=function(){var buckets=$("div.profile .itemBucket:visible").css({height:"auto","min-height":"auto"});if(self.padBucketHeight()===!0){var bucketSizes={},itemHeight=0,vaultPos=parseInt(self.vaultPos())-1;vaultPos=0>vaultPos?0:vaultPos;var vaultColumns=tgd.bootstrapGridColumns/self.vaultColumns();buckets.each(function(){var bucketType=this.className.split(" ")[2],isVault=this.className.indexOf("Vault")>-1,columnsPerBucket=isVault?vaultColumns:tgd.DestinyBucketColumns[bucketType],$visibleBucketItems=$(this).find(".bucket-item:visible"),visibleBucketHeight=$visibleBucketItems.eq(0).height(),bucketHeight=Math.ceil($visibleBucketItems.length/columnsPerBucket)*(visibleBucketHeight+2);visibleBucketHeight&&visibleBucketHeight>itemHeight&&!isVault&&(itemHeight=visibleBucketHeight),bucketType in bucketSizes?bucketSizes[bucketType].push(bucketHeight):bucketSizes[bucketType]=[bucketHeight]}),_.each(bucketSizes,function(sizes,type){var maxHeight=_.max(sizes),profileSizes=sizes.slice(0);profileSizes.splice(vaultPos,1);var maxProfilesHeight=_.max(profileSizes),minNumRows=3;"Bounties"==type?minNumRows=4:tgd.DestinyFiveRowBuckets.indexOf(type)>-1&&(minNumRows=5),maxProfilesHeight=Math.max(itemHeight*minNumRows,maxProfilesHeight);var itemBuckets=buckets.filter("."+type);itemBuckets.css("min-height",maxHeight),itemBuckets.find(".itemBucketBG").css("height",maxProfilesHeight)});var vaultSubClass=$('div.profile .title2:visible strong:contains("Vault Sub")').parent().parent().css("height","auto"),notVaultSubClass=$('div.profile .title2:visible strong:contains("Sub")').not(':contains("Vault")').first().parent().parent().css("height","auto");vaultSubClass.css("min-height",notVaultSubClass.height()),vaultSubClass.css("visibility","hidden")}else buckets.find(".itemBucketBG").css("height","auto")},this.globalClickHandler=function(e){$("#move-popup").is(":visible")&&"itemLink"!==e.target.className&&"itemLink"!==e.target.parentNode.className&&($("#move-popup").hide(),tgd.activeElement=null)},this.quickIconHighlighter=function(){var scrollTop=$(window).scrollTop();$(".profile").each(function(index,item){var $item=$(item),characterId=$item.attr("id"),$quickIcon=$(".quickScrollView ."+characterId),$characterBox=$(".character-box."+characterId),top=$item.position().top-55,bottom=top+$item.height(),isActive=scrollTop>=top&&bottom>=scrollTop&&scrollTop>0;$quickIcon.toggleClass("activeProfile",isActive),$characterBox.toggleClass("active",isActive),$characterBox.toggleClass("not-active",!isActive),$characterBox.css({width:$characterBox.parent().width()+"px"})})},this.readBungieCookie=function(ref,loop){try{ref.executeScript({code:"document.cookie"},function(result){tgd.localLog("result "+result),(result||"").toString().indexOf("bungled")>-1&&(self.bungie_cookies=result,window.localStorage.setItem("bungie_cookies",result),self.loadData(ref,loop))})}catch(e){tgd.localLog(e)}},this.openHiddenBungieWindow=function(){window.ref=window.open("https://www.bungie.net/en/User/Profile","_blank","location=no,hidden=yes"),ref.addEventListener("loadstop",function(event){self.readBungieCookie(ref,1)})},this.findReference=function(item,callback){if(item&&item.id>0){var subscriptions=[],newItemHandler=function(items){var foundItem=_.where(items,{_id:item._id});foundItem.length>0&&(_.each(subscriptions,function(sub){sub.dispose()}),callback(foundItem[0]))},allItems=_.flatten(_.map(app.characters(),function(character){return subscriptions.push(character.items.subscribe(newItemHandler)),character.items()}));newItemHandler(allItems)}},this.clearCookies=function(){window.localStorage.setItem("bungie_cookies","");try{window.cookies.clear(function(){tgd.localLog("Cookies cleared")})}catch(e){}},this.openBungieWindow=function(type){return function(){var loop;if(isNWJS){var gui=require("nw.gui");gui.Window.get();window.ref=gui.Window.open("https://www.bungie.net/en/User/SignIn/"+type+"?bru=%252Fen%252FUser%252FProfile","Test Popup")}else isChrome||isMobile?window.ref=window.open("https://www.bungie.net/en/User/SignIn/"+type+"?bru=%252Fen%252FUser%252FProfile","_blank","location=yes"):window.ref=window.open("https://www.bungie.net/en/User/SignIn/"+type,"_blank","toolbar=0,location=0,menubar=0");isMobile?(ref.addEventListener("loadstop",function(event){self.readBungieCookie(ref,loop)}),ref.addEventListener("exit",function(){_.isEmpty(self.bungie_cookies)&&self.readBungieCookie(ref,loop)})):isNWJS?window.ref.on("loaded",function(){location.reload()}):(clearInterval(loop),loop=setInterval(function(){if(window.ref.closed)if(clearInterval(loop),isMobile||isChrome)self.loadData();else{$.toaster({priority:"success",title:"Loading",message:"Please wait while Firefox acquires your arsenal",settings:{timeout:tgd.defaults.toastTimeout}});var event=new CustomEvent("request-cookie-from-ps",{});window.dispatchEvent(event),setTimeout(function(){tgd.localLog("loadData"),self.loadData()},5e3)}},100))}},this.scrollTo=function(distance,callback){isWindowsPhone?($("html,body").scrollTop(distance),callback&&callback()):$("body").animate({scrollTop:distance},300,"swing",callback)},this.scrollToActiveIndex=function(newIndex){var index=$(".quickScrollView img").filter(function(){var classAttr=$(this).attr("class"),className=_.isUndefined(classAttr)?"":classAttr;return className.indexOf("activeProfile")>-1}).index(".quickScrollView img");self.scrollTo($(".profile:eq("+index+")").position().top-50,function(){$.toaster({priority:"info",title:"View",message:tgd.DestinyViews[newIndex],settings:{timeout:tgd.defaults.toastTimeout}})})},this.shiftViewLeft=function(){var newIndex=parseInt(self.activeView())-1;0>newIndex&&(newIndex=3),self.activeView(newIndex),self.scrollToActiveIndex(newIndex)},this.shiftViewRight=function(){var newIndex=parseInt(self.activeView())+1;4==newIndex&&(newIndex=0),self.activeView(newIndex),self.scrollToActiveIndex(newIndex)},this.requests={};this.apiRequest=function(params,callback){var apiURL=tgd.remoteServer+"/api3.cfm";$.ajax({url:apiURL,data:params,type:"POST",success:function(data){var response="string"==typeof data?JSON.parse(data):data;callback(response)}})},this.staticApiRequest=function(params,callback){var apiURL=tgd.remoteServer+"/static_api.cfm";$.ajax({url:apiURL,data:params,type:"POST",success:function(data){var response="string"==typeof data?JSON.parse(data):data;callback(response)}})},this.saveLoadouts=function(includeMessage){var _includeMessage=_.isUndefined(includeMessage)?!0:includeMessage;if(self.activeUser()&&self.activeUser().user&&self.activeUser().user.membershipId){var params={action:"save",membershipId:parseFloat(self.activeUser().user.membershipId),loadouts:ko.toJSON(self.loadouts())};self.apiRequest(params,function(results){_includeMessage===!0&&(results.success?$.toaster({priority:"success",title:"Saved",message:"Loadouts saved to the cloud",settings:{timeout:tgd.defaults.toastTimeout}}):BootstrapDialog.alert("Error has occurred saving loadouts"))})}else BootstrapDialog.alert("Error reading your membershipId, could not save loadouts")},this.loadLoadouts=function(){if(0===self.loadouts().length){var _loadouts=window.localStorage.getItem("loadouts");_loadouts=_.isEmpty(_loadouts)?[]:_.map(JSON.parse(_loadouts),function(loadout){return new tgd.Loadout(loadout)});var maxCSP="";try{maxCSP=_.map(_.groupBy(_.sortBy(_.filter(_.flatten(_.map(self.characters(),function(character){return character.items()})),function(item){return item.armorIndex>-1}),"bucketType"),"bucketType"),function(items,bucketType){return String.fromCharCode(_.max(_.map(items,function(item){return item.getValue("All")})))}).join("")}catch(e){}self.apiRequest({action:"load",membershipId:parseFloat(self.activeUser().user.membershipId),maxCSP:maxCSP},function(results){var _results=[];results&&results.loadouts&&(_results=_.isArray(results.loadouts)?results.loadouts:[results.loadouts],_results=_.map(_results,function(loadout){return loadout.ids=_.isArray(loadout.ids)?loadout.ids:[loadout.ids],loadout.equipIds=_.isEmpty(loadout.equipIds)?[]:loadout.equipIds,loadout.equipIds=_.isArray(loadout.equipIds)?loadout.equipIds:[loadout.equipIds],new tgd.Loadout(loadout)})),_loadouts.length>0&&(_results=_loadouts.concat(_results),window.localStorage.setItem("loadouts","")),self.loadouts(_results),_loadouts.length>0&&self.saveLoadouts(!1)})}},this.showWhatsNew=function(callback){var container=$("<div></div>");container.attr("style","overflow-y: scroll; height: 480px"),container.html(tgd.whatsNewTemplate()),(new tgd.dialog).title(self.activeText().whats_new_title).content(container).show(!1,function(){_.isFunction(callback)&&callback()})},this.whatsNew=function(){if("true"==$("#showwhatsnew").text()){var version=tgd.version.replace(/\./g,"");4==version.length&&(version+="0");var cookie=window.localStorage.getItem("whatsnew");cookie&&cookie.length&&4==cookie.length&&(cookie+="0"),(_.isEmpty(cookie)||parseInt(cookie)<parseInt(version))&&self.showWhatsNew(function(){window.localStorage.setItem("whatsnew",version)})}},this.normalizeSingle=function(description,characters,usingbatchMode,callback){var itemTotal=0,characterStatus=_.map(characters,function(c){var characterTotal=_.reduce(_.filter(c.items(),{description:description}),function(memo,i){return memo+i.primaryStat()},0);return itemTotal+=characterTotal,{character:c,current:characterTotal,needed:0}});if(itemTotal<characterStatus.length)return usingbatchMode===!1&&$.toaster({priority:"danger",title:"Warning",message:"Cannot distribute "+itemTotal+" "+description+" between "+characterStatus.length+" characters.",settings:{timeout:tgd.defaults.toastTimeout}}),void(void 0!==callback&&callback());var itemSplit=itemTotal/characterStatus.length|0;_.each(characterStatus,function(c){c.needed=itemSplit-c.current});var getNextSurplusCharacter=function(){return function(){return _.filter(characterStatus,function(c){return c.needed<0})[0]}}(),getNextShortageCharacter=function(){return function(){return _.filter(characterStatus,function(c){return c.needed>0})[0]}}();if("undefined"==typeof getNextSurplusCharacter()||"undefined"==typeof getNextShortageCharacter())return usingbatchMode===!1&&$.toaster({priority:"success",title:"Result",message:description+" already normalized as best as possible.",settings:{timeout:tgd.defaults.toastTimeout}}),void("undefined"!=typeof callback&&callback());var adjustStateAfterTransfer=function(surplusCharacter,shortageCharacter,amountTransferred){surplusCharacter.current=surplusCharacter.current-amountTransferred,surplusCharacter.needed=surplusCharacter.needed+amountTransferred,shortageCharacter.needed=shortageCharacter.needed-amountTransferred,shortageCharacter.current=shortageCharacter.current+amountTransferred},nextTransfer=function(callback){var surplusCharacter=getNextSurplusCharacter(),shortageCharacter=getNextShortageCharacter();if("undefined"==typeof surplusCharacter||"undefined"==typeof shortageCharacter)return usingbatchMode===!1&&$.toaster({priority:"success",title:"Result",message:"All items normalized as best as possible",settings:{timeout:tgd.defaults.toastTimeout}}),void(void 0!==callback&&callback());if(surplusCharacter.character.id==shortageCharacter.character.id)return void(void 0!==callback&&callback());var surplusItems=_.filter(surplusCharacter.character.items(),{description:description}),surplusItem=surplusItems[0],maxWeCanWorkWith=Math.min(surplusItem.primaryStat(),-1*surplusCharacter.needed),amountToTransfer=Math.min(maxWeCanWorkWith,shortageCharacter.needed);"Vault"==surplusCharacter.character.id?surplusItem.transfer("Vault",shortageCharacter.character.id,amountToTransfer,function(){adjustStateAfterTransfer(surplusCharacter,shortageCharacter,amountToTransfer),nextTransfer(callback)}):"Vault"==shortageCharacter.character.id?surplusItem.transfer(surplusCharacter.character.id,"Vault",amountToTransfer,function(){adjustStateAfterTransfer(surplusCharacter,shortageCharacter,amountToTransfer),nextTransfer(callback)}):surplusItem.transfer(surplusCharacter.character.id,"Vault",amountToTransfer,function(){surplusItem.transfer("Vault",shortageCharacter.character.id,amountToTransfer,function(){adjustStateAfterTransfer(surplusCharacter,shortageCharacter,amountToTransfer),nextTransfer(callback)})})},messageStr="<div><div>Normalize "+description+"</div><ul>";for(i=0;i<characterStatus.length;i++)messageStr=messageStr.concat("<li>"+characterStatus[i].character.classType()+": "+(characterStatus[i].needed>0?"+":"")+characterStatus[i].needed+"</li>");if(messageStr=messageStr.concat("</ul></div>"),usingbatchMode===!1){new tgd.dialog({message:messageStr,buttons:[{label:"Normalize",cssClass:"btn-primary",action:function(dialogItself){nextTransfer(callback),dialogItself.close()}},{label:"Close",action:function(dialogItself){dialogItself.close()}}]}).title(self.activeText().normalize_title).show(!0)}else nextTransfer(callback)},this.normalizeAll=function(bucketType){var done=function(onlyCharacters){var descriptions=_.uniq(_.flatten(_.map(onlyCharacters,function(character){return _.pluck(_.filter(character.items(),function(item){return item.bucketType==bucketType&&item.transferStatus<2}),"description")}))),getNextDescription=function(){var i=0;return function(){return i<descriptions.length?descriptions[i++]:void 0}}(),nextNormalize=function(){var description=getNextDescription();return"undefined"==typeof description?void $.toaster({priority:"success",title:"Result",message:"All items normalized as best as possible",settings:{timeout:tgd.defaults.toastTimeout}}):void self.normalizeSingle(description,onlyCharacters,!0,nextNormalize)};nextNormalize()};this.selectMultiCharacters("Normalize All "+bucketType,"Normalize: equally distribute all "+bucketType+" across the selected characters",done)},this.selectMultiCharacters=function(title,description,callback){var selectedStatus=[];for(i=0;i<app.orderedCharacters().length;i++){var id=app.orderedCharacters()[i].id;selectedStatus[id]="Vault"!==id}new tgd.dialog({message:function(dialogItself){var $content=$(tgd.selectMultiCharactersTemplate({description:description,characters:app.orderedCharacters(),selected:selectedStatus})),charButtonClicked=function(self,id){selectedStatus[id]=!selectedStatus[id],self.find("img").css("border",selectedStatus[id]===!0?"solid 3px yellow":"none")};return $.each(app.orderedCharacters(),function(i,val){var id=val.id,sel="#char"+i.toString();$content.find(sel).click(function(){charButtonClicked($(this),id)})}),$content},buttons:[{label:"OK",cssClass:"btn-primary",action:function(dialogItself){var characters=_.filter(app.orderedCharacters(),function(c){return selectedStatus[c.id]===!0});characters.length<=1?BootstrapDialog.alert("Need to select two or more characters."):callback(characters),dialogItself.close()}},{label:"Close",action:function(dialogItself){dialogItself.close()}}]}).title(title).show(!0)},this.setVaultTo=function(){var pos=this.toString(),vault=_.findWhere(self.characters(),{id:"Vault"});return vault?(self.vaultPos(pos),void vault.order(pos)):!1},this.isVaultAt=function(pos){return ko.pureComputed(function(){var vault=_.findWhere(self.characters(),{id:"Vault"});return vault?result=vault.order()==pos:result=!1,result}).extend({rateLimit:{timeout:1e3,method:"notifyWhenChangesStop"}})},this._columnMode=function(){var characterColumns,character=this,totalCharacters=3,xsColumn=self.xsColumn(),smColumn=self.smColumn(),mdColumn=self.mdColumn(),lgColumn=self.lgColumn(),vaultColumns=lgColumn,totalColumns=tgd.bootstrapGridColumns,layoutMode=self.layoutMode();return"uneven"==layoutMode?(vaultColumns=self.vaultWidth(),characterColumns=Math.floor((totalColumns-vaultColumns)/totalCharacters)):(vaultColumns=lgColumn,characterColumns=lgColumn),"Vault"==character.id?"even"!=layoutMode||4!=self.vaultPos()||8!=lgColumn&&8!=mdColumn&&8!=smColumn?lgColumn=vaultColumns:(8==lgColumn&&(lgColumn=24),8==mdColumn&&(mdColumn=24),8==smColumn&&(smColumn=24)):lgColumn=characterColumns,"col-xs-"+xsColumn+" col-sm-"+smColumn+" col-md-"+mdColumn+" col-lg-"+lgColumn},this.columnMode=function(character){return ko.pureComputed(self._columnMode,character)},this.setColumns=function(input,ctx,evt){var type=this.toString();self[type+"Column"](tgd.bootstrapGridColumns/input.value),self.redraw()},this._btnActive=function(){var input=this;return tgd.bootstrapGridColumns/input.value==self[input.kind+"Column"]()?"btn-primary":""},this.btnActive=function(type,input){return input.kind=type,ko.pureComputed(self._btnActive,input)},this.generateStatic=function(){var profileKeys=["race","order","gender","classType","id","level","imgIcon","icon","background","stats"],itemKeys=["id","_id","characterId","damageType","damageTypeName","isEquipped","isGridComplete","locked","description","itemDescription","bucketType","type","typeName","tierType","tierTypeName","icon","primaryStat","progression","weaponIndex","armorIndex","perks","stats","isUnique","href"],profiles=_.map(self.characters(),function(profile){var newProfile={};return _.each(profileKeys,function(key){newProfile[key]=ko.unwrap(profile[key])}),newProfile.items=_.map(profile.items(),function(item){var newItem={};return _.each(itemKeys,function(key){newItem[key]=ko.unwrap(item[key])}),ko.toJS(newItem)}),newProfile});return JSON.stringify(profiles)},this.initLocale=function(callback){navigator&&navigator.globalization&&navigator.globalization.getPreferredLanguage&&(tgd.localLog("getting device locale internally"),navigator.globalization.getPreferredLanguage(function(a){if(a&&a.value&&a.value.indexOf("-")>-1){var value=a.value.split("-")[0];_.pluck(tgd.languages,"code").indexOf(value)>-1&&(tgd.localLog("internal locale is "+value),"pt"==value&&(value="pt-br"),self.locale(value))}}))},this.getBucketName=function(bucketType){return"Invisible"==bucketType?"Special Orders":bucketType},this.dndBeforeMove=function(arg){arg&&arg.targetParent&&arg.targetParent.length>0&&(arg.cancelDrop=arg.item.bucketType!==arg.targetParent[0].bucketType||arg.item.transferStatus>=2)},this.dndAfterMove=function(arg){var destination=_.filter(arg.targetParent,function(item){return item.character.id!=arg.item.character.id});if(0===destination.length&&(destination=_.filter(arg.targetParent,function(item){return item._id!=arg.item._id})),destination.length>0&&(destination=destination[0],destination.character.id!=arg.item.character.id)){var action=destination.isEquipped()?"equip":"store";$.toaster({priority:"info",title:"Transfer",message:arg.item.description+" will be "+action+"d to "+destination.character.uniqueName(),settings:{timeout:tgd.defaults.toastTimeout}}),arg.item[action](destination.character.id)}},this.loadStatic=function(username){self.staticApiRequest({username:username},function(staticProfiles){return 0===staticProfiles.length?BootstrapDialog.alert("There is no shared data to view for this profile"):void _.each(staticProfiles,function(data,index){var avatar={processed:!0,characterBase:{characterId:data.id,stats:data.stats,level:data.level,race:data.race,gender:data.gender,classType:data.classType,background:data.background,icon:data.icon},items:data.items,index:data.order},profile=new Profile(avatar);self.characters.push(profile)})})},this.transferFarmItems=function(targetCharacterId,items){if(!tgd.transferringFarmItems){var itemsToTransfer=[],farmItemCounts=self.farmItemCounts(),selectedFarmItems=self.farmItems();if(_.each(selectedFarmItems,function(itemType){var filteredItems=_.sortBy(_.filter(items,tgd.farmItemFilters[itemType]),"tierType");if(itemsToTransfer=itemsToTransfer.concat(filteredItems),"Vault"==targetCharacterId)farmItemCounts[itemType]=(farmItemCounts[itemType]||0)+filteredItems.length;else{var spaceAvailable=_.countBy(_.findWhere(self.characters(),{id:targetCharacterId}).items(),"bucketType");itemsToTransfer=_.filter(itemsToTransfer,function(item){var slotsAvailable=spaceAvailable[item.bucketType],maxSpaceAvailable=tgd.DestinyNonUniqueBuckets.indexOf(item.bucketType)>-1?20:10;return maxSpaceAvailable>slotsAvailable?(spaceAvailable[item.bucketType]++,!0):!1})}}),self.farmItemCounts(farmItemCounts),0!==itemsToTransfer.length){var adhoc=new tgd.Loadout(itemsToTransfer,!0);tgd.autoTransferStacks=!0,tgd.transferringFarmItems=!0;var msa=adhoc.transfer(targetCharacterId,!0);msa.length>0&&adhoc.swapItems(msa,targetCharacterId,function(){tgd.autoTransferStacks=!1,tgd.transferringFarmItems=!1})}}},this.farmItemHandler=function(items){self.transferFarmItems(self.farmTarget(),items)},this.vaultItemHandler=function(items){var sortedItems=_.groupBy(items,"actualBucketType");_.each(tgd.DestinyLayout,function(layout){var group=sortedItems[layout.array];if(group&&group.length==layout.counts[0]&&self.farmMode()===!0&&"Vault"==self.farmTarget()){self.farmMode(!1);var warning_msg=layout.name+" is full, disabling Farm Mode.";tgd.localLog(warning_msg),$.toaster({priority:"danger",title:"Warning",message:warning_msg,settings:{timeout:tgd.defaults.toastTimeout}})}})};var remainingInterval,subscriptions=[];this.farmModeHandler=function(isEnabled){isEnabled===!0?(self.doRefresh()===!1&&self.doRefresh(!0),clearInterval(remainingInterval),remainingInterval=setInterval(function(){var timeRemaining=Math.floor(self.refreshSeconds()-((new Date).getTime()-tgd.autoRefreshTime)/1e3);timeRemaining>60?timeRemaining=Math.floor(timeRemaining/60)+"m"+timeRemaining%60+"s":timeRemaining+="s",$("#timeRemainingForRefresh").html(timeRemaining)},1e3),_.each(self.characters(),function(character){"Vault"==character.id&&"Vault"==self.farmTarget()?subscriptions.push(character.items.subscribe(self.vaultItemHandler)):("Vault"!=character.id&&"Vault"==self.farmTarget()||"Vault"==character.id&&"Vault"!==self.farmTarget())&&subscriptions.push(character.items.subscribe(self.farmItemHandler))}),self.refresh()):(clearInterval(remainingInterval),_.each(subscriptions,function(subscription){subscription.dispose()}))},this.init=function(){_.each(ko.templates,function(content,name){$("<script></script").attr("type","text/html").attr("id",name).html(content).appendTo("head")});var providedTemplates=_.keys(ko.templates);if($("div[data-bind*=template]").map(function(i,e){var template=$(e).attr("data-bind").match(/'(.*)'/)[1];-1==providedTemplates.indexOf(template)&&$(e).remove()}),window.isStaticBrowser?($ZamTooltips.init(),self.bungie=new tgd.bungie("",function(){self.loadStatic(unescape(location.search.replace("?","")))})):($.idleTimer(18e5),$(document).on("idle.idleTimer",function(event,elem,obj){clearInterval(self.refreshInterval)}),$(document).on("active.idleTimer",self.refreshHandler)),("3"==self.lgColumn()||"4"==self.mdColumn())&&(self.lgColumn(tgd.defaults.lgColumn),self.mdColumn(tgd.defaults.mdColumn),self.smColumn(tgd.defaults.smColumn),self.xsColumn(tgd.defaults.xsColumn)),_.each(tgd.DestinyLayout,function(layout){self.allLayouts.push(new tgd.Layout(layout))}),self.initLocale(),_.isUndefined(window._itemDefs)||_.isUndefined(window._perkDefs))return BootstrapDialog.alert(self.activeText().itemDefs_undefined);if(_.each(_.templates,function(content,templateName){"languagesTemplate"==templateName&&(content=self.activeText().language_text+content),tgd[templateName]=_.template(content)}),!window.isStaticBrowser){self.doRefresh.subscribe(self.refreshHandler),self.refreshSeconds.subscribe(self.refreshHandler),self.loadoutMode.subscribe(self.refreshHandler),tgd.farmItems=new tgd.StoreObj("farmItems");var savedSelections=tgd.farmItems.read();self.farmItems(_.isArray(savedSelections)?savedSelections:savedSelections.split(",")),self.farmItems.subscribe(function(newValues){tgd.farmItems.write(newValues)})}if(self.farmMode.subscribe(self.farmModeHandler),self.padBucketHeight.subscribe(self.redraw),self.refreshHandler(),!window.isStaticBrowser){self.bungie_cookies="",window.localStorage&&window.localStorage.getItem&&(self.bungie_cookies=window.localStorage.getItem("bungie_cookies"));var isEmptyCookie=-1==(self.bungie_cookies||"").indexOf("bungled");if(isWindowsPhone){var msViewportStyle=document.createElement("style");msViewportStyle.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(msViewportStyle)}var dragAndDropEnabled=self.padBucketHeight()===!0&&self.dragAndDrop()===!0;ko.bindingHandlers.sortable.isEnabled=dragAndDropEnabled,ko.bindingHandlers.draggable.isEnabled=dragAndDropEnabled,dragAndDropEnabled?(ko.bindingHandlers.sortable.beforeMove=self.dndBeforeMove,ko.bindingHandlers.sortable.afterMove=self.dndAfterMove,ko.bindingHandlers.sortable.options={start:function(){$ZamTooltips.isEnabled=!1,$ZamTooltips.hide()},stop:function(){self.tooltipsEnabled()===!0&&($ZamTooltips.isEnabled=!0)},over:function(){$(this).addClass("active")},out:function(){$(this).removeClass("active")},sort:function(event,ui){var $target=$(event.target);if(!/html|body/i.test($target.offsetParent()[0].tagName)){var top=event.pageY-$target.offsetParent().offset().top-ui.helper.outerHeight(!0)/2;ui.helper.css({top:top+"px"})}},scroll:!1,revert:!1,placeholder:"item-placeholder",cursorAt:{cursor:"move",top:27,left:27},cursor:"pointer",appendTo:"body"}):ko.bindingHandlers.sortable=ko.bindingHandlers.foreach,isMobile&&isEmptyCookie?self.bungie=new tgd.bungie("",function(){self.activeUser({code:99,error:"Please sign-in to continue."})}):self.loadData()}tgd.autoRefreshTime=(new Date).getTime(),$("html").click(self.globalClickHandler),self.activeView.subscribe(self.redraw),$(window).resize(_.throttle(self.bucketSizeHandler,500)),$(window).resize(_.throttle(self.quickIconHighlighter,500)),$(window).scroll(_.throttle(self.quickIconHighlighter,500)),self.collectionSets=_.sortBy(Object.keys(_collections)),tgd.DestinyArmorStats=_.filter(_statDefs,function(stat){return tgd.DestinyArmorStats.indexOf(stat.statHash)>-1}),window.isStaticBrowser||$(document).on("click","a[target='_system']",function(){return window.open(this.href,tgd.openTabAs),!1}),ko.applyBindings(self),$("form").bind("submit",!1),window.isStaticBrowser||(isMobile&&(Hammer(document.getElementById("charactersContainer"),{drag_horizontal:!0,drag_vertical:!1}).on("swipeleft",self.shiftViewLeft).on("swiperight",self.shiftViewRight).on("tap",self.globalClickHandler),"undefined"!=typeof StatusBar&&(StatusBar.styleBlackOpaque(),StatusBar.backgroundColorByHexString("#272B30")),"undefined"!=typeof inappbilling&&inappbilling.init(_.noop,_.noop,{showLog:!1},["small","medium","large"]),document.addEventListener("backbutton",function(e){e.preventDefault()},!1)),self.whatsNew()),window.BOOTSTRAP_OK=!0}};window.app=new app,BootstrapDialog.defaultOptions.nl2br=!1,isMobile?(window.addEventListener("statusTap",function(){var target=$("body");target.css({"-webkit-overflow-scrolling":"auto","overflow-y":"hidden"}),target.animate({scrollTop:0},300,"swing",function(){target.css({"-webkit-overflow-scrolling":"touch","overflow-y":"scroll"})})}),document.addEventListener("deviceready",app.init,!1)):$(document).ready(app.init),function(){var f=this,g=function(a,d){var c=a.split("."),b=window||f;c[0]in b||!b.execScript||b.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)c.length||void 0===d?b=b[e]?b[e]:b[e]={}:b[e]=d},h=function(a){var d=chrome.runtime.connect("nmmhkkegccagdldgiimedpiccmgmieda",{}),c=!1;d.onMessage.addListener(function(b){c=!0,"response"in b&&!("errorType"in b.response)?a.success&&a.success(b):a.failure&&a.failure(b)}),d.onDisconnect.addListener(function(){!c&&a.failure&&a.failure({request:{},response:{errorType:"INTERNAL_SERVER_ERROR"}})}),d.postMessage(a)};g("google.payments.inapp.buy",function(a){a.method="buy",h(a)}),g("google.payments.inapp.consumePurchase",function(a){a.method="consumePurchase",h(a)}),g("google.payments.inapp.getPurchases",function(a){a.method="getPurchases",h(a)}),g("google.payments.inapp.getSkuDetails",function(a){a.method="getSkuDetails",h(a)})}(),_ga=new function(){var self=this;this.init=function(){var ga_options={cookieDomain:"none"};isMobile&&(ga_options={storage:"none",clientId:device.uuid}),ga("create","UA-61575166-1",ga_options),ga("set","checkProtocolTask",function(){}),ga("set","appVersion",tgd.version),ga(function(tracker){var originalSendHitTask=tracker.get("sendHitTask");tracker.set("sendHitTask",function(model){originalSendHitTask(model);var xhr=new XMLHttpRequest;xhr.open("POST",tgd.remoteServer+"/ga.cfm",!0),xhr.send(model.get("hitPayload"))})}),ga("send","pageview"),self.loadListeners()},this.loadListeners=function(){window.addEventListener("error",function(e){-1==e.filename.toLowerCase().indexOf("inappbrowser")&&-1==e.filename.toLowerCase().indexOf("cordova")&&-1==e.filename.toLowerCase().indexOf("libraries")&&ga("send","exception",{exDescription:e.message,exFatal:!0,appName:e.filename+":  "+e.lineno,appVersion:tgd.version,hitCallback:function(){console.log("crash reported "+e.message),console.log(e)}})});var unwantedCodes=[0,503,504,522,524,525,526,502,400,409,500];$(document).ajaxError(function(evt,request,settings,err){-1==unwantedCodes.indexOf(request.status)?ga("send","exception",{exDescription:request.status+" ajax error at "+settings.url+" "+settings.data+" "+err,exFatal:!0,appVersion:tgd.version,hitCallback:function(){tgd.localLog(request.status+" ajax error at "+settings.url+" "+settings.data+" "+err)}}):tgd.localLog(request.status+" ajax error (code 0) at "+settings.url+" "+settings.data+" "+err)})}},isMobile?document.addEventListener("deviceready",_ga.init,!1):$(document).ready(_ga.init),window.zam_tooltips={addIcons:!1,colorLinks:!1,renameLinks:!1,renderCallback:app.renderCallback,isEnabled:app.tooltipsEnabled()},tgd.Tooltip=function(id){var info=_itemDefs[id];this["class"]="destt-q"+info.tierType,this.icon=tgd.tooltipsIconTemplate({item:info}),this.id=id,this.name=unescape(info.itemName),this.site="destinydb",
this.tooltip=tgd.tooltipsTemplate({item:info}),this.type="items"},window.$ZamTooltips=function(){this.addIcons=!1,this.renameLinks=!1,this.colorLinks=!1,this.isEnabled=!0,this.enabled=function(){return this.isEnabled},this.renderCallback=function(context,content,element,cb){cb(content)},"object"==typeof zam_tooltips&&(zam_tooltips.addIcons&&(this.addIcons=!0),zam_tooltips.renderCallback&&(this.renderCallback=zam_tooltips.renderCallback),zam_tooltips.renameLinks&&(this.renameLinks=!0),zam_tooltips.colorLinks&&(this.colorLinks=!0),"isEnabled"in zam_tooltips&&(this.isEnabled=zam_tooltips.isEnabled));var reAllSites,reLocalUrl,container,lastEvent,remote="undefined"==typeof FH,sites={d3head:{url:"d3head.com",cdn:"https://d3css.zamimg.com",tt:'<div class="fhtt d3h d3h-custom"><div class="d3htt-cont">@text@</div><div class="d3htt-right"></div><div class="d3htt-bottomright"></div><div class="d3htt-bottom"></div></div>',ttFluid:'<div class="fhtt d3h d3h-fluid"><div class="d3htt-cont">@text@</div><div class="d3htt-right"></div><div class="d3htt-bottomright"></div><div class="d3htt-bottom"></div></div>',types:["achievement","class","crafting","item","lore","npc","quest","recipe","rune","skill","zone","custom"]},esohead:{url:"esohead.com",cdn:"https://esocss.zamimg.com",tt:'<div class="fhtt eh"><div class="ehtt-cont">@text@</div><div class="ehtt-right"></div><div class="ehtt-bottomright"></div><div class="ehtt-bottom"></div></div>',ttFluid:'<div class="fhtt eh eh-fluid"><div class="ehtt-cont">@text@</div><div class="ehtt-right"></div><div class="ehtt-bottomright"></div><div class="ehtt-bottom"></div></div>',types:["abilities","achievements","books","classes","items","itemsets","monsters","races","recipes","skills","tradeskills","zones","custom","poi","skyshards","mundus-stones"]},heroking:{url:"heroking.net",cdn:"https://hkcss.zamimg.com",tt:'<div class="fhtt hk"><div class="hktt-cont">@text@</div><div class="hktt-right"></div><div class="hktt-bottomright"></div><div class="hktt-bottom"></div></div>',ttFluid:'<div class="fhtt hk hk-fluid"><div class="hktt-cont">@text@</div><div class="hktt-right"></div><div class="hktt-bottomright"></div><div class="hktt-bottom"></div></div>',types:["heroes","achievements","abilities","mounts","talents","rewards","bundles"]},destinydb:{url:"destinydb.com",cdn:"https://descss.zamimg.com",tt:'<div class="fhtt des"><div class="destt-cont">@text@</div><div class="destt-right"></div><div class="destt-bottomright"></div><div class="destt-bottom"></div></div>',ttFluid:'<div class="fhtt des des-fluid"><div class="destt-cont">@text@</div><div class="destt-right"></div><div class="destt-bottomright"></div><div class="destt-bottom"></div></div>',types:["talents","talent-child","items","classes","races","activities","vendors","grimoire","destinations","places","medals","players","guardians","events","snapshots"]},overking:{url:"overking.com",cdn:"https://okcss.zamimg.com",tt:'<div class="fhtt des"><div class="destt-cont">@text@</div><div class="destt-right"></div><div class="destt-bottomright"></div><div class="destt-bottom"></div></div>',ttFluid:'<div class="fhtt des des-fluid"><div class="destt-cont">@text@</div><div class="destt-right"></div><div class="destt-bottomright"></div><div class="destt-bottom"></div></div>',types:["heroes","abilities"]}},cache=this.cache={},activeTooltip=!1,attachedTo=!1,addEvent=function(obj,evt,callback){obj.addEventListener?obj.addEventListener(evt,callback,!0):obj.attachEvent("on"+evt,callback)},removeEvent=function(obj,evt,callback){obj.removeEventListener?obj.removeEventListener(evt,callback,!0):obj.detachEvent("on"+evt,callback)},addResource=function(res){document.head?document.head.appendChild(res):document.body.appendChild(res)},getCanonicalName=function(site,type,id){return sites[site]?sites[site].url+"/"+type+"/"+id:!1},getMousePos=function(event){var windowInfo=getWindowInfo();if(!event)return{x:-9999,y:-9999};var x=void 0!==event.pageX?event.pageX:windowInfo.left+event.clientX,y=void 0!==event.pageY?event.pageY:windowInfo.top+event.clientY;return{x:x,y:y}},getElementDimensions=function(t){for(var x=t.offsetLeft,y=t.offsetTop,temp=t;temp.offsetParent&&(x+=temp.offsetParent.offsetLeft,y+=temp.offsetParent.offsetTop,"BODY"!=temp.tagName);)temp=temp.offsetParent;return{x:x,y:y,w:t.offsetWidth,h:t.offsetHeight}},getWindowInfo=function(){var left="undefined"!=typeof window.pageXOffset?window.pageXOffset:document.body.scrollLeft,top="undefined"!=typeof window.pageYOffset?window.pageYOffset:document.body.scrollTop,width=window.innerWidth?window.innerWidth:document.body.clientWidth,height=window.innerHeight?window.innerHeight:document.body.clientHeight;return{left:left,top:top,right:left+width,bottom:top+height}},getServerUrl=function(){return"https://"+location.hostname+(80==location.port?"":":"+location.port)},ready=!1;this.init=function(){if(!ready){var domains=[];for(var s in sites)if(sites.hasOwnProperty(s)){domains.push(sites[s].url),sites[s].typeHash={};for(var numTypes=sites[s].types.length,i=0;numTypes>i;i++)sites[s].typeHash[sites[s].types[i]]=!0;sites[s].re=new RegExp(sites[s].url+"/("+sites[s].types.join("|")+")/([^?&#;-]+)")}reAllSites=new RegExp("^https?://[^/]*\\.?("+domains.join("|")+")/"),reLocalUrl=new RegExp("^(https?://)"+location.host+"(/.+)"),addEvent(document,"mouseover",onMouseover);var div=document.createElement("div");div.id="zam-tooltip",div.setAttribute("style","display:none;position:absolute;left:0;top:0;z-index:9999999999");try{document.body.insertBefore(div,document.body.childNodes[0]),container=div,ready=!0,!remote||this.addIcons||this.colorLinks||this.renameLinks?this.preload():remote&&this.preload(!0)}catch(e){ga("send","exception",{exDescription:"tooltips crashed > "+e.toString(),exFatal:!1,appVersion:tgd.version,hitCallback:function(){console.log("crash reported")}})}}};var parseMatches=function(matches,tags){for(var numTags=tags.length,i=0;numTags>i;i++){var a=tags[i],match=scan(a,!0);match!==!1&&(matches[match.site]||(matches[match.site]={}),matches[match.site][match.type]||(matches[match.site][match.type]=[]),-1==matches[match.site][match.type].indexOf(match.id)&&matches[match.site][match.type].push(match.id))}};this.getContainer=function(){return container},this.preload=function(cssOnly){if(ready){var aTags=document.body.getElementsByTagName("a"),dataTags=document.querySelectorAll("[data-zamtooltip]"),matches={};parseMatches(matches,dataTags),parseMatches(matches,aTags);for(var site in matches)if(matches.hasOwnProperty(site)&&!cssOnly)for(var type in matches[site])if("custom"!=type&&matches[site].hasOwnProperty(type)){for(var id,ids=matches[site][type],finalIDs=[],i=0;id==ids[i];i++)cache[getCanonicalName(site,type,ids[i])]||finalIDs.push(id);for(var ii=0,x=finalIDs.length;x>ii;ii+=50){ids=finalIDs.slice(ii,ii+50);var url="/"+type+"/tooltip/"+ids.join(";");if(remote||FH.DOMAIN!=site){if(!sites[site])continue;url="https://"+sites[site].url+url}else url=getServerUrl()+url;var script=document.createElement("script");script.type="text/javascript",script.src=url,addResource(script);for(var numIds=ids.length,j=0;numIds>j;++j)cache[getCanonicalName(site,type,ids[j])]=!0}}}},this.updateLinks=function(site,type){if(this.addIcons||this.colorLinks||this.renameLinks)for(var tags=document.getElementsByTagName("a"),i=tags.length;i--;){var a=tags[i],opts=a.rel.split(" ");if(!a.zamModified){var match=scan(a,!0,!0);if(match&&match.site==site&&match.type==type&&!a.attributes["data-zamtooltip"]){var canonical=getCanonicalName(match.site,match.type,match.id);if(cache[canonical]){var info=cache[canonical];if(info!==!0&&(a.zamModified=!0,(this.renameLinks||opts.indexOf("rename"))&&info.name&&-1==opts.indexOf("protect")&&-1==opts.indexOf("!rename")&&(a.innerHTML=info.name),(this.renameLinks||opts.indexOf("color"))&&info["class"]&&-1==opts.indexOf("protect")&&-1==opts.indexOf("!color")&&(a.className+=" "+info["class"]),(this.addIcons||opts.indexOf("icon"))&&info.icon&&-1==opts.indexOf("protect")&&-1==opts.indexOf("!icon"))){var span=document.createElement("span");span.innerHTML=info.icon;var link=span.getElementsByTagName("a")[0];link&&(link.zamModified=!0,link.setAttribute("data-"+match.site,match.type+"="+match.id),a.href&&(link.href=a.href)),a.parentNode.insertBefore(span,a)}}}}}},this.lastElement=null,this.show=function(site,type,id,attach,element){if($("#move-popup").is(":visible"))return!1;element&&(this.lastElement=element);var canonical=getCanonicalName(site,type,id);"custom"==type&&(cache[canonical]=id),cache[canonical]||fetch(site,type,id);var info=cache[canonical];info&&container&&(info===!0?container.innerHTML=sites[site].tt.replace("@text@","Loading..."):"custom"==type?container.innerHTML=sites[site].ttFluid.replace("@text@",info):(container.innerHTML=info.tooltip.replace(/\/\/desimg.zamimg.com/g,"https://desimg.zamimg.com"),this.renderCallback(info,container.innerHTML,this.lastElement,function(newContent){container.innerHTML=newContent})),activeTooltip=canonical,attachedTo=attach,this.update())},this.update=function(){container.style.display="block",container.onclick=function(){$ZamTooltips.hide()};var pos,win=getWindowInfo(),tempcontainer=container.getBoundingClientRect(),w=tempcontainer.width,h=tempcontainer.height;if(attachedTo){var dim=getElementDimensions(attachedTo);pos=reposition(dim,win,w,h)}else{var mousePos=getMousePos(lastEvent);pos=reposition({x:mousePos.x,y:mousePos.y,w:0,h:0},win,w,h)}container.style.left=pos.left+"px",container.style.top=pos.top+"px"},this.scanAtCursor=function(event){var x=event.clientX,y=event.clientY,target=document.elementFromPoint(x,y);target&&onMouseover({target:target})},this.hide=function(){activeTooltip=!1,attachedTo=!1,container&&container.style&&(container.style.display="none",container.innerHTML="")},this.add=function(site,id,tooltip){var canonical=getCanonicalName(site,"custom",id);cache[canonical]=tooltip},this.onTooltip=function(tooltips){if(tooltips.length){for(var site,type,numTooltips=tooltips.length,i=0;numTooltips>i;i++){var info=tooltips[i];if(info.site&&info.type&&info.id&&info.tooltip){var canonical=getCanonicalName(info.site,info.type,info.id);cache[canonical]=info,site=info.site,type=info.type,activeTooltip==canonical&&this.show(info.site,info.type,info.id,attachedTo)}}this.updateLinks(site,type)}};var onMouseover=function(event){if($ZamTooltips.enabled()===!0){var t=event.target?event.target:event.srcElement;lastEvent=event;for(var i=0;t&&5>i&&!scan(t);)t=t.parentNode,i++}},onMousemove=function(event){$ZamTooltips.enabled()===!0&&(lastEvent=event,$ZamTooltips.update())},onMouseout=function(event){if($ZamTooltips.enabled()===!0){lastEvent=event,$ZamTooltips.hide();var t=event.target?event.target:event.srcElement;removeEvent(t,"mousemove",onMousemove),removeEvent(t,"mouseout",onMouseout)}},padding={x:10,y:4},reposition=function(dim,win,w,h){var left=dim.x+dim.w+padding.x,top=dim.y-h-padding.y;return left+w>win.right&&(left=dim.x-w-padding.x,left<win.left&&(left=win.right-w-padding.x)),dim.y+h+padding.y>win.bottom&&top<win.top?top=win.top-padding.y:top<win.top&&(top=dim.y+dim.h+padding.y),{left:left,top:top}},fetchLocal=function(id){var tooltips=[new tgd.Tooltip(id)];$ZamTooltips.onTooltip(tooltips)},fetch=function(site,type,id){var canonical=getCanonicalName(site,type,id);if(cache[canonical]=!0,tgd.itemsNotIndexed.indexOf(parseFloat(id))>-1)fetchLocal(id);else{var url="/"+type+"/tooltip/"+id;if(remote||FH.DOMAIN!=site){if(!sites[site])return!1;url="https://"+sites[site].url+url}else url=getServerUrl()+url;var script=document.createElement("script");script.type="text/javascript",script.src=url;var isLoaded=!1;script.onload=script.onreadystatechange=function(){this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(isLoaded=!0),isLoaded&&_.isObject(cache[canonical])||fetchLocal(id)},addResource(script),setTimeout(function(){_.isObject(cache[canonical])||fetchLocal(id)},3e3)}return!0},scan=function(t,partOfPreload,basicScan){if(!(t.attributes&&t.attributes["data-zamtooltip"]||"A"==t.nodeName&&(0!==t.href.length||0!==t.rel.length)&&-1==t.rel.indexOf("nott")&&-1==t.rel.indexOf("!tt")&&-1==t.href.indexOf(location.href+"#")))return!1;var url=t.href;if(!url){for(var a,as=t.getElementsByTagName("a"),i=0;(a=as[i])&&!(url=a.href);i++);if(!url)return!1}if(remote&&!url.match(reAllSites))return!1;!remote&&sites[FH.DOMAIN]&&(url=url.replace(reLocalUrl,sites[FH.DOMAIN].url+"$2"));var match=testDataAttrib(t);if(match||(match=testUrl(url)),!match)return!1;if(partOfPreload)return!t.preloaded||basicScan?(t.preloaded=!0,match):match;addEvent(t,"mouseout",onMouseout);var attach=!1;return t.parentNode.className.indexOf("fh-icon")>-1?attach=t.parentNode:(t.className.indexOf("fh-icon")>-1||"true"==t.getAttribute("data-fhttattach"))&&(attach=t),addEvent(t,"mousemove",onMousemove),$ZamTooltips.show(match.site,match.type,match.id,attach,t),!0},testUrl=function(url){for(var s in sites)if(sites.hasOwnProperty(s)){var site=sites[s],match=site.re.exec(url);if(match)return{site:s,type:match[1],id:match[2]}}return!1},testDataAttrib=function(t){var attr=t.attributes["data-zamtooltip"];if(attr){var split=attr.value.split("=");return 2==split.length&&sites[split[0]]?{site:split[0],type:"custom",id:split[1]}:!1}return!1}},window.$ZamTooltips=new $ZamTooltips;
//# sourceMappingURL=3.tower_ghost.js.map